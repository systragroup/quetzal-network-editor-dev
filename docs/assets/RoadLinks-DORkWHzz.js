import{t as he,r as c,d as Y,bd as ke,be as Ce,aM as C,f as w,g as H,j as b,k as p,n as q,I as ee,u as Ne,a as De,ab as Fe,c as g,o as de,bf as _e,w as O,h as A,p as $e,q as je,i as L,A as ze,H as ve,J as fe,O as pe,K as ye,B as me,C as ge,bg as Ae,bh as Ve,ak as V,aN as qe,aO as Pe,z as Re,bi as Be}from"./index-B5JWNUzE.js";const Oe={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(N,{emit:K}){const h=N,M=K,{map:d}=he(h),v=c(null),k=c(null),s=c({lnglat:null,point:null}),o=c({lnglat:null,point:null}),i=c(new Set);Y(()=>{d.value.on("mousedown",D)}),ke(()=>{d.value.off("mousedown",D)});function D(u){u.originalEvent.button===2&&(s.value.lnglat=u.lngLat,s.value.point=u.point,d.value.on("mousemove",F),d.value.on("mouseup",P),M("mousedown",{mapboxEvent:u}))}function F(u){o.value.lnglat=u.lngLat,o.value.point=u.point;const x=d.value.unproject([o.value.point.x,s.value.point.y]),_=d.value.unproject([s.value.point.x,o.value.point.y]);v.value=Ce([[[s.value.lnglat.lng,s.value.lnglat.lat],[x.lng,x.lat],[o.value.lnglat.lng,o.value.lnglat.lat],[_.lng,_.lat],[s.value.lnglat.lng,s.value.lnglat.lat]]]),d.value.getSource("selectPolygon").setData(v.value),k.value=[Object.values(s.value.point),Object.values(o.value.point)],M("mousemove",{mapboxEvent:u,polygon:v.value,bbox:k.value})}function P(u){d.value.getSource("selectPolygon").setData(C),d.value.getCanvas().style.cursor="pointer",d.value.off("mousemove",F),d.value.off("mouseup",P),R(),v.value&&M("mouseup",{mapboxEvent:u,polygon:v.value,selectedId:i.value}),k.value=null,v.value=null}function R(){if(k.value){const u=d.value.queryRenderedFeatures(k.value,{layers:["rlinks"]});i.value=new Set(u.map(x=>x.id))}else i.value=new Set}return(u,x)=>(w(),H(ee,null,[b(p(q),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:p(C)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":u.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),b(p(q),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":u.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},Ke={__name:"RoadLinks",props:["map","isEditorMode"],emits:["clickFeature","onHover","offHover","select"],setup(N,{emit:K}){const{$gettext:h}=Ne(),{openDialog:M}=Be(),d=N,v=K,k=De(),s=Fe(),{map:o}=he(d),i=g(()=>s.editionMode);Y(()=>{o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("anchorrNodes","links"),o.value.moveLayer("rnodes","links")),P()}),de(()=>{o.value.removeLayer("arrow-rlinks")}),ke(()=>{i.value&&s.cancelEdition()});async function D(){const e=u.value;e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rlinks").setData(e)}async function F(){const e=x.value;e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rnodes").setData(e)}function P(){D(),F()}const R=g(()=>k.roadsPopupContent),u=g(()=>s.visiblerLinks),x=g(()=>s.visiblerNodes);function _(){const e=o.value.queryRenderedFeatures({layers:["rlinks"]}),a=new Set(e.map(r=>r.id)),n=u.value.features.filter(r=>a.has(r.properties.index)),f=V.cloneDeep(C);return n.filter(r=>r.geometry.coordinates.length>2).forEach(r=>{const E=r.properties.index;r.geometry.coordinates.slice(1,-1).forEach((Le,Me)=>f.features.push(qe(Le,{index:Pe.generate(),linkIndex:E,coordinatedIndex:Me+1})))}),f}const G=g(()=>k.anchorMode);_e(()=>{if(i.value&&G.value&&B.value>=S.value.anchor){const e=_();o.value.getSource("anchorrNodes").setData(e)}else o.value.getSource("anchorrNodes").setData(C)},{flush:"post"});const $=c(null),l=c(null),Z=c(!1),B=c(10);async function T(){B.value=o.value.getZoom()}const I=g(()=>{const e=B.value-S.value.nodes;return 2/(1+Math.exp(-e+3))+1}),S=c({anchor:14,nodes:24});async function oe(){if(G.value&&B.value>=S.value.anchor){const e=_();o.value.getSource("anchorrNodes").setData(e)}}O(i,e=>{e?(o.value.on("dragend",oe),o.value.on("zoomend",T),T(),S.value.nodes=12):(k.setAnchorMode(!1),o.value.off("dragend",oe),o.value.off("zoomend",T),S.value.nodes=24,z(),v("select"))});const U=c(!1),W=c(!1),y=c("");function J(e){var a;if(i.value&&((a=$.value)!=null&&a.isOpen()&&$.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!Z.value&&R.value.length>0){const f=e.mapboxEvent.features[0];if(f.layer.id==="rlinks"){let r=R.value.map(E=>`${E}: <b>${f.properties[E]}</b>`);r=r.join("<br> "),$.value=new Re.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(r).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",l.value!==null&&o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const n=[...new Set(e.mapboxEvent.features.map(f=>f.id))];l.value={layerId:e.layerId,id:n},o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),X.value||v("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function Q(e){var a,n;i.value&&((a=$.value)!=null&&a.isOpen()&&$.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((n=l.value)==null?void 0:n.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(U.value?W.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,v("offHover",e)))))}function ae(e){if(i.value&&l.value!==null&&(y.value=l.value.id,y.value!==null&&l.value.layerId==="rlinks")){const a=G.value?"anchorrNodes":"rnodes";s.addRoadNodeInline({selectedIndex:y.value,lngLat:e.mapboxEvent.lngLat,nodes:a})}}function le(e,a){if(a.length===0)e=="rlinks"?D():F();else{const n=V.cloneDeep(a);n.forEach(r=>r.id=r.properties?r.properties.index:r.id),o.value.getSource(e).updateData({type:"FeatureCollection",features:n})}s.networkWasModified=!0}const be=g(()=>s.updateLinks),we=g(()=>s.updateNodes);O(be,e=>{le("rlinks",e)},{flush:"sync"}),O(we,e=>{le("rnodes",e)},{flush:"sync"});const t=c({coordinates:[0,0],showed:!1,actions:[],feature:null});function te(e){["Delete rLink","Delete Selected"].includes(e.action)?(s.deleterLink(e.feature),v("clickFeature",{action:"Delete rLink"})):M({action:e.action,selectedArr:Array.from(e.feature),lingering:!0,type:"road"}),t.value.showed=!1,z()}function ne(e){var n,f;const a=e.mapboxEvent.originalEvent.ctrlKey;if(i.value&&!a){const r=o.value.querySourceFeatures(l.value.layerId);if(y.value=r.filter(E=>l.value.id.includes(E.id)),y.value.length>0)if(((n=l.value)==null?void 0:n.layerId)==="rnodes"){const E=y.value[0].properties.index;M({action:"Edit rNode Info",selectedArr:[E],lingering:!0,type:"road"})}else((f=l.value)==null?void 0:f.layerId)==="anchorrNodes"&&s.deleteAnchorrNode({selectedNode:y.value[0].properties})}}const m=c(new Set([]));function j(e){m.value.forEach(a=>{o.value.setFeatureState({source:"rlinks",id:a},{select:e})})}function z(){j(!1),m.value=new Set([]),t.value.showed=!1}function se(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&z()}Y(()=>{o.value.on("mousedown",se),o.value.on("click",z)}),de(()=>{o.value.off("mousedown",se),o.value.off("click",z)});const X=g(()=>m.value.size>0);O(X,e=>v("select",e));function xe(e){var a;i.value&&((a=l.value)==null?void 0:a.layerId)==="rlinks"&&(t.value.showed||(t.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),t.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(m.value=new Set([...m.value,...l.value.id]),j(!0),t.value.feature=V.cloneDeep(m),t.value.actions=[{name:"Edit Road Group Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):(j(!1),m.value=new Set([]),t.value.feature=V.cloneDeep(l.value.id),t.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function Ie(e){e.mapboxEvent.originalEvent.ctrlKey?m.value=new Set([...m.value,...e.selectedId]):(j(!1),m.value=e.selectedId),j(!0),m.value.size>0?(t.value.showed=!0,t.value.coordinates=null,t.value.feature=V.cloneDeep(m),t.value.actions=[{name:"Edit Road Group Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):t.value.showed=!1}function re(e){if(i.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",U.value=!0;const a=o.value.querySourceFeatures(l.value.layerId);y.value=a.filter(n=>n.id===l.value.id[0])[0],Z.value=!0,l.value.layerId==="rnodes"&&s.getConnectedLinks({selectedNode:y.value}),o.value.on("mousemove",ue),o.value.on("mouseup",ie)}}function ue(e){W.value&&y.value&&(l.value.layerId==="anchorrNodes"?s.moverAnchor({selectedNode:y.value,lngLat:Object.values(e.lngLat)}):(v("clickFeature",{action:"Move rNode"}),s.moverNode({selectedNode:y.value,lngLat:Object.values(e.lngLat)})))}function ie(){i.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",ue),U.value=!1,W.value=!1,Z.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,o.value.off("mouseup",ie))}const ce=g(()=>k.cyclewayMode),Se=g(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.1*I.value,0],.1*I.value],a=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return ce.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],a]:["*",e,a]}),Ee=g(()=>ce.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,a)=>(w(),H("section",null,[i.value?(w(),A(Oe,{key:0,map:p(o),onMouseup:Ie},null,8,["map"])):$e("",!0),b(p(q),{"source-id":"rlinks",reactive:!1,source:{type:"geojson",dynamic:!0,data:p(C),buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",N.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*I.value,I.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:J,onMouseleave:Q,onClick:ae,onContextmenu:xe},null,8,["source","layer"]),b(p(je),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:S.value.nodes,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":Se.value,"icon-rotate":Ee.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),b(p(q),{"source-id":"rnodes",reactive:!1,source:{type:"geojson",dynamic:!0,data:x.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{type:"circle",minzoom:S.value.nodes,paint:{"circle-color":["case",["boolean",N.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],6*I.value,3*I.value],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:J,onMouseleave:Q,onMousedown:re,onContextmenu:ne},null,8,["source","layer"]),b(p(q),{"source-id":"anchorrNodes",reactive:!1,source:{type:"geojson",data:p(C),dynamic:!1,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{type:"circle",minzoom:S.value.anchor,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],6*I.value,3*I.value],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:ae,onMouseover:J,onMouseleave:Q,onMousedown:re,onContextmenu:ne},null,8,["source","layer"]),t.value.coordinates!==null?(w(),A(p(Ae),{key:1,"close-button":!1,showed:t.value.showed,coordinates:t.value.coordinates,"close-on-click":!1,onClose:a[1]||(a[1]=n=>t.value.showed=!1)},{default:L(()=>[ze("span",{onMouseleave:a[0]||(a[0]=()=>{X.value||(t.value.showed=!1)})},[b(ve,{density:"compact"},{default:L(()=>[(w(!0),H(ee,null,fe(t.value.actions,n=>(w(),A(pe,{key:n.id},{default:L(()=>[b(ye,{variant:"outlined",size:"small",onClick:f=>te({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:L(()=>[me(ge(p(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])):(w(),A(Ve,{key:2,modelValue:t.value.showed,"onUpdate:modelValue":a[2]||(a[2]=n=>t.value.showed=n),"close-button":!1,coordinates:t.value.coordinates,timeout:"-1",class:"snackbar"},{default:L(()=>[b(ve,{density:"compact"},{default:L(()=>[(w(!0),H(ee,null,fe(t.value.actions,n=>(w(),A(pe,{key:n.id},{default:L(()=>[b(ye,{variant:"outlined",size:"small",onClick:f=>te({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:L(()=>[me(ge(p(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue","coordinates"]))]))}};export{Ke as default};
