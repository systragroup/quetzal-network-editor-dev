import{bH as ne,bI as F,bJ as ce,bK as B,bL as K,_ as fe,u as de,a$ as ve,aa as he,a as ye,r as C,c as k,o as pe,d as me,bM as be,f as T,g as x,j as h,i as m,ae as D,B as V,C as p,m as g,Q as $,A as y,aW as Y,L as S,h as q,l as ge,aX as Pe,H as U,I as N,a2 as we,R as xe,a_ as Ve,U as Le,a8 as Me,a9 as Ie,Z,ah as Ce,bd as Te}from"./index-Bm9Mwp9Q.js";import{b as E,a as j,M as Fe}from"./Microservices-C2aGr8Pv.js";function I(r,e,t){if(t===void 0&&(t={}),!r)throw new Error("point is required");if(!e)throw new Error("polygon is required");var a=ne(r),l=F(e),n=l.type,s=e.bbox,i=l.coordinates;if(s&&ke(a,s)===!1)return!1;n==="Polygon"&&(i=[i]);for(var u=!1,d=0;d<i.length&&!u;d++)if(ee(a,i[d][0],t.ignoreBoundary)){for(var v=!1,L=1;L<i[d].length&&!v;)ee(a,i[d][L],!t.ignoreBoundary)&&(v=!0),L++;v||(u=!0)}return u}function ee(r,e,t){var a=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var l=0,n=e.length-1;l<e.length;n=l++){var s=e[l][0],i=e[l][1],u=e[n][0],d=e[n][1],v=r[1]*(s-u)+i*(u-r[0])+d*(r[0]-s)===0&&(s-r[0])*(u-r[0])<=0&&(i-r[1])*(d-r[1])<=0;if(v)return!t;var L=i>r[1]!=d>r[1]&&r[0]<(u-s)*(r[1]-i)/(d-i)+s;L&&(a=!a)}return a}function ke(r,e){return e[0]<=r[0]&&e[1]<=r[1]&&e[2]>=r[0]&&e[3]>=r[1]}function G(r,e,t){t===void 0&&(t={});for(var a=ne(r),l=ce(e),n=0;n<l.length-1;n++){var s=!1;if(t.ignoreEndVertices&&(n===0&&(s="start"),n===l.length-2&&(s="end"),n===0&&n+1===l.length-1&&(s="both")),Se(l[n],l[n+1],a,s,typeof t.epsilon>"u"?null:t.epsilon))return!0}return!1}function Se(r,e,t,a,l){var n=t[0],s=t[1],i=r[0],u=r[1],d=e[0],v=e[1],L=t[0]-i,O=t[1]-u,P=d-i,b=v-u,_=L*b-O*P;if(l!==null){if(Math.abs(_)>l)return!1}else if(_!==0)return!1;if(a){if(a==="start")return Math.abs(P)>=Math.abs(b)?P>0?i<n&&n<=d:d<=n&&n<i:b>0?u<s&&s<=v:v<=s&&s<u;if(a==="end")return Math.abs(P)>=Math.abs(b)?P>0?i<=n&&n<d:d<n&&n<=i:b>0?u<=s&&s<v:v<s&&s<=u;if(a==="both")return Math.abs(P)>=Math.abs(b)?P>0?i<n&&n<d:d<n&&n<i:b>0?u<s&&s<v:v<s&&s<u}else return Math.abs(P)>=Math.abs(b)?P>0?i<=n&&n<=d:d<=n&&n<=i:b>0?u<=s&&s<=v:v<=s&&s<=u;return!1}function te(r,e){var t=F(r),a=F(e),l=t.type,n=a.type,s=t.coordinates,i=a.coordinates;switch(l){case"Point":switch(n){case"Point":return R(s,i);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Ge(t,a);case"MultiPoint":return _e(t,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return G(a,t,{ignoreEndVertices:!0});case"LineString":return Oe(t,a);case"MultiPoint":return Be(t,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return I(a,t,{ignoreBoundary:!0});case"LineString":return Ae(t,a);case"Polygon":return De(t,a);case"MultiPoint":return Ee(t,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+l+" geometry not supported")}}function Ge(r,e){var t,a=!1;for(t=0;t<r.coordinates.length;t++)if(R(r.coordinates[t],e.coordinates)){a=!0;break}return a}function _e(r,e){for(var t=0,a=e.coordinates;t<a.length;t++){for(var l=a[t],n=!1,s=0,i=r.coordinates;s<i.length;s++){var u=i[s];if(R(l,u)){n=!0;break}}if(!n)return!1}return!0}function Be(r,e){for(var t=!1,a=0,l=e.coordinates;a<l.length;a++){var n=l[a];if(G(n,r,{ignoreEndVertices:!0})&&(t=!0),!G(n,r))return!1}return!!t}function Ee(r,e){for(var t=0,a=e.coordinates;t<a.length;t++){var l=a[t];if(!I(l,r,{ignoreBoundary:!0}))return!1}return!0}function Oe(r,e){for(var t=!1,a=0,l=e.coordinates;a<l.length;a++){var n=l[a];if(G({type:"Point",coordinates:n},r,{ignoreEndVertices:!0})&&(t=!0),!G({type:"Point",coordinates:n},r,{ignoreEndVertices:!1}))return!1}return t}function Ae(r,e){var t=!1,a=0,l=E(r),n=E(e);if(!se(l,n))return!1;for(a;a<e.coordinates.length-1;a++){var s=$e(e.coordinates[a],e.coordinates[a+1]);if(I({type:"Point",coordinates:s},r,{ignoreBoundary:!0})){t=!0;break}}return t}function De(r,e){if(r.type==="Feature"&&r.geometry===null||e.type==="Feature"&&e.geometry===null)return!1;var t=E(r),a=E(e);if(!se(t,a))return!1;for(var l=F(e).coordinates,n=0,s=l;n<s.length;n++)for(var i=s[n],u=0,d=i;u<d.length;u++){var v=d[u];if(!I(v,r))return!1}return!0}function se(r,e){return!(r[0]>e[0]||r[2]<e[2]||r[1]>e[1]||r[3]<e[3])}function R(r,e){return r[0]===e[0]&&r[1]===e[1]}function $e(r,e){return[(r[0]+e[0])/2,(r[1]+e[1])/2]}function oe(r,e,t){t===void 0&&(t={});var a={type:"Feature"};return(t.id===0||t.id)&&(a.id=t.id),t.bbox&&(a.bbox=t.bbox),a.properties=e||{},a.geometry=r,a}function qe(r,e,t){if(t===void 0&&(t={}),r.length<2)throw new Error("coordinates must be an array of two or more positions");var a={type:"LineString",coordinates:r};return oe(a,e,t)}function Ue(r,e){e===void 0&&(e={});var t={type:"FeatureCollection"};return e.id&&(t.id=e.id),e.bbox&&(t.bbox=e.bbox),t.features=r,t}function Ne(r,e,t){t===void 0&&(t={});var a={type:"MultiLineString",coordinates:r};return oe(a,e,t)}function W(r,e){e===void 0&&(e={});var t=F(r);switch(!e.properties&&r.type==="Feature"&&(e.properties=r.properties),t.type){case"Polygon":return We(t,e);case"MultiPolygon":return Ke(t,e);default:throw new Error("invalid poly")}}function We(r,e){e===void 0&&(e={});var t=F(r),a=t.coordinates,l=e.properties?e.properties:r.type==="Feature"?r.properties:{};return le(a,l)}function Ke(r,e){e===void 0&&(e={});var t=F(r),a=t.coordinates,l=e.properties?e.properties:r.type==="Feature"?r.properties:{},n=[];return a.forEach(function(s){n.push(le(s,l))}),Ue(n)}function le(r,e){return r.length>1?Ne(r,e):qe(r[0],e)}function Re(r,e){var t=!0;return B(r,function(a){B(e,function(l){if(t===!1)return!1;t=ze(a.geometry,l.geometry)})}),t}function ze(r,e){switch(r.type){case"Point":switch(e.type){case"Point":return!Qe(r.coordinates,e.coordinates);case"LineString":return!re(e,r);case"Polygon":return!I(r,e)}break;case"LineString":switch(e.type){case"Point":return!re(r,e);case"LineString":return!Xe(r,e);case"Polygon":return!ae(e,r)}break;case"Polygon":switch(e.type){case"Point":return!I(e,r);case"LineString":return!ae(r,e);case"Polygon":return!He(e,r)}}return!1}function re(r,e){for(var t=0;t<r.coordinates.length-1;t++)if(Je(r.coordinates[t],r.coordinates[t+1],e.coordinates))return!0;return!1}function Xe(r,e){var t=K(r,e);return t.features.length>0}function ae(r,e){for(var t=0,a=e.coordinates;t<a.length;t++){var l=a[t];if(I(l,r))return!0}var n=K(e,W(r));return n.features.length>0}function He(r,e){for(var t=0,a=r.coordinates[0];t<a.length;t++){var l=a[t];if(I(l,e))return!0}for(var n=0,s=e.coordinates[0];n<s.length;n++){var i=s[n];if(I(i,r))return!0}var u=K(W(r),W(e));return u.features.length>0}function Je(r,e,t){var a=t[0]-r[0],l=t[1]-r[1],n=e[0]-r[0],s=e[1]-r[1],i=a*s-l*n;return i!==0?!1:Math.abs(n)>=Math.abs(s)?n>0?r[0]<=t[0]&&t[0]<=e[0]:e[0]<=t[0]&&t[0]<=r[0]:s>0?r[1]<=t[1]&&t[1]<=e[1]:e[1]<=t[1]&&t[1]<=r[1]}function Qe(r,e){return r[0]===e[0]&&r[1]===e[1]}function Ye(r,e){var t=!1;return B(r,function(a){B(e,function(l){if(t===!0)return!0;t=!Re(a.geometry,l.geometry)})}),t}const Ze={class:"background"},je={class:"params-row"},et={class:"list"},tt={class:"list-row"},rt={class:"list-item-small"},at={class:"list-item-small"},nt={class:"list-item-small"},st={class:"list-item-small"},ot={class:"list-item-medium"},lt={class:"list-item-medium"},it={class:"list-item-large"},ut={__name:"GTFSWebImporter",setup(r){const{$gettext:e}=de(),t=ve(),a=he(),l=ye(),n=C(!1),s=C(null),i=C([]),u=C([]),d=C(!1),v=C(t.selectedGTFS),L=k(()=>t.stateMachineArn),O=k(()=>a.linksIsEmpty),P=k(()=>t.callID),b=k(()=>t.running),_=k(()=>t.error),z=k(()=>t.errorMessage);pe(()=>{t.saveParams(A.value),t.saveSelectedGTFS(v.value)});const A=C([{name:"start_time",text:"start time",value:t.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:t.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:t.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),X={required:f=>!!f||e("Required")};me(async()=>{i.value=await ie(),i.value.forEach((f,c)=>{try{f.bbox=j([f["location.bounding_box.minimum_longitude"],f["location.bounding_box.minimum_latitude"],f["location.bounding_box.maximum_longitude"],f["location.bounding_box.maximum_latitude"]])}catch{f.bbox=null}f.index=c}),i.value=i.value.filter(f=>f.bbox),i.value=i.value.filter(f=>{var c;return((c=f["urls.latest"])==null?void 0:c.length)>0}),i.value.sort((f,c)=>f["location.country_code"]<c["location.country_code"]?-1:f["location.country_code"]>c["location.country_code"]?1:0)});async function ie(){try{const f=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});f.ok||l.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const c=await f.arrayBuffer();return be(c)}catch(f){l.changeAlert(f)}}function ue(f){s.value?s.value=f:(s.value=f,H())}function H(){let f=null;if(s.value.style==="bbox"){const o=s.value.geometry;f=j([o[1],o[0],o[3],o[2]])}else f=Te([s.value.geometry]);u.value=i.value.filter(o=>te(f,o.bbox)||Ye(f,o.bbox)),u.value.forEach(o=>o.allInPolygon=te(f,o.bbox));const c=new Set(u.value.map(o=>o.index));v.value=v.value.filter(o=>c.has(o))}function J(){if(O.value){t.setCallID();const o={files:u.value.filter(w=>v.value.includes(w.index)).map(w=>w["urls.latest"]),callID:P.value};A.value.forEach(w=>{o[w.name]=w.value}),t.startExecution(L.value,o)}else n.value=!0}function Q(){a.$reset(),n.value=!1,J()}return(f,c)=>(x(),T("div",Ze,[h($,{class:"card"},{default:m(()=>[h(D,{class:"subtitle"},{default:m(()=>[V(p(g(e)("GTFS importer")),1)]),_:1}),h(Fe,{onChange:ue})]),_:1}),h($,{class:"card2"},{default:m(()=>[h(D,{class:"subtitle"},{default:m(()=>[V(p(g(e)("Available GTFS")),1)]),_:1}),h(Y,null,{default:m(()=>[V(p(g(e)("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),h(S,{disabled:b.value,"prepend-icon":"fa-solid fa-sync",onClick:H},{default:m(()=>[V(p(g(e)("fetch available GTFS")),1)]),_:1},8,["disabled"]),h(S,{loading:b.value,disabled:b.value||v.value.length===0,color:b.value||v.value.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:J},{default:m(()=>[V(p(g(e)("Download")),1)]),_:1},8,["loading","disabled","color"]),h(Y,null,{default:m(()=>[_.value?(x(),q(Pe,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:m(()=>[V(p(g(e)("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(x(!0),T(U,null,N(Object.keys(z.value),o=>(x(),T("p",{key:o},[y("b",null,p(o)+": ",1),V(p(z.value[o]),1)]))),128))]),_:1})):ge("",!0)]),_:1}),y("div",je,[(x(!0),T(U,null,N(A.value,(o,w)=>(x(),T("div",{key:w,class:"params"},[typeof o.items>"u"?(x(),q(we,{key:0,modelValue:o.value,"onUpdate:modelValue":M=>o.value=M,step:"1",type:o.type,label:g(e)(o.text),suffix:o.units,variant:"underlined",hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(M=>X[M]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(x(),q(xe,{key:1,modelValue:o.value,"onUpdate:modelValue":M=>o.value=M,variant:"underlined",type:o.type,items:o.items,label:g(e)(o.text),suffix:o.units,hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(M=>X[M]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),y("div",et,[y("ul",tt,[y("span",rt,[h(Ve,{disabled:!0})]),c[4]||(c[4]=y("span",{class:"list-item-small"},"All in polygon",-1)),c[5]||(c[5]=y("span",{class:"list-item-small"},"Code",-1)),c[6]||(c[6]=y("span",{class:"list-item-medium"},"Name",-1)),c[7]||(c[7]=y("span",{class:"list-item-medium"},"City",-1)),c[8]||(c[8]=y("span",{class:"list-item-large"},"Agency",-1)),c[9]||(c[9]=y("span",{class:"list-item-small"},".zip",-1))]),(x(!0),T(U,null,N(u.value,(o,w)=>(x(),T("ul",{key:o.index,class:"list-row"},[y("span",at,[h(Le,{modelValue:v.value,"onUpdate:modelValue":c[0]||(c[0]=M=>v.value=M),value:o.index,label:String(w)},null,8,["modelValue","value","label"])]),y("span",nt,p(o.allInPolygon),1),y("span",st,p(o["location.country_code"]),1),y("span",ot,p(o["location.subdivision_name"]),1),y("span",lt,p(o["location.municipality"]),1),y("span",it,p(o.provider),1),h(S,{variant:"text",icon:"fa-solid fa-download",size:"small",href:o["urls.latest"]},null,8,["href"])]))),128))])]),_:1}),h(Ce,{modelValue:n.value,"onUpdate:modelValue":c[2]||(c[2]=o=>n.value=o),persistent:"","max-width":"500",onKeydown:[Z(Q,["enter"]),c[3]||(c[3]=Z(o=>n.value=!1,["esc"]))]},{default:m(()=>[h($,null,{default:m(()=>[h(D,{class:"text-h5"},{default:m(()=>[V(p(g(e)("Overwrite current PT network ?")),1)]),_:1}),h(Me,null,{default:m(()=>[h(Ie),h(S,{color:"regular",onClick:c[1]||(c[1]=o=>n.value=!n.value)},{default:m(()=>[V(p(g(e)("No")),1)]),_:1}),h(S,{color:"primary",onClick:Q},{default:m(()=>[V(p(g(e)("Yes")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},dt=fe(ut,[["__scopeId","data-v-d4d2a359"]]);export{dt as default};
