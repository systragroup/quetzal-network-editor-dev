import{ax as ye,u as w,ar as C,ay as G,a3 as ve,az as Le,_ as R,c as Pe,r as k,o as m,f as x,M as Ke,a as $e,b as Ye,a4 as ie,a7 as g,j as v,aA as pe,aB as Qe,aa as Xe,aC as Ie,aD as et,aE as tt,aF as st,w as d,g as o,A as b,i as V,a8 as Ue,aG as _e,k as _,ab as A,n as h,t as u,Z as P,aH as W,F as T,z as O,l as p,ap as le,ac as at,Y as Q,G as de,aI as rt,aJ as Re,E as N,$ as K,a9 as xe,S as X,s as nt,aK as ot,x as it,aL as lt,aM as dt,V as U,aN as qe,aO as He,aP as oe,aQ as ee,aR as we,aS as fe,aT as ct,at as ut,aU as De,J as ht,al as mt,O as pt,B as ft,p as ae,v as re,ad as gt,Q as Fe,as as yt,R as vt,an as Me,aV as _t,ao as $}from"./index-d2df715b.js";var ge={exports:{}},Ce=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof window.msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto);if(Ce){var Te=new Uint8Array(16);ge.exports=function(){return Ce(Te),Te}}else{var Oe=new Array(16);ge.exports=function(){for(var s=0,a;s<16;s++)s&3||(a=Math.random()*4294967296),Oe[s]=a>>>((s&3)<<3)&255;return Oe}}var ze=ge.exports,je=[];for(var ne=0;ne<256;++ne)je[ne]=(ne+256).toString(16).substr(1);function xt(e,s){var a=s||0,t=je;return[t[e[a++]],t[e[a++]],t[e[a++]],t[e[a++]],"-",t[e[a++]],t[e[a++]],"-",t[e[a++]],t[e[a++]],"-",t[e[a++]],t[e[a++]],"-",t[e[a++]],t[e[a++]],t[e[a++]],t[e[a++]],t[e[a++]],t[e[a++]]].join("")}var Be=xt,wt=ze,bt=Be,Ee,ce,ue=0,he=0;function St(e,s,a){var t=s&&a||0,l=s||[];e=e||{};var c=e.node||Ee,i=e.clockseq!==void 0?e.clockseq:ce;if(c==null||i==null){var r=wt();c==null&&(c=Ee=[r[0]|1,r[1],r[2],r[3],r[4],r[5]]),i==null&&(i=ce=(r[6]<<8|r[7])&16383)}var n=e.msecs!==void 0?e.msecs:new Date().getTime(),f=e.nsecs!==void 0?e.nsecs:he+1,y=n-ue+(f-he)/1e4;if(y<0&&e.clockseq===void 0&&(i=i+1&16383),(y<0||n>ue)&&e.nsecs===void 0&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");ue=n,he=f,ce=i,n+=122192928e5;var I=((n&268435455)*1e4+f)%4294967296;l[t++]=I>>>24&255,l[t++]=I>>>16&255,l[t++]=I>>>8&255,l[t++]=I&255;var D=n/4294967296*1e4&268435455;l[t++]=D>>>8&255,l[t++]=D&255,l[t++]=D>>>24&15|16,l[t++]=D>>>16&255,l[t++]=i>>>8|128,l[t++]=i&255;for(var F=0;F<6;++F)l[t+F]=c[F];return s||bt(l)}var kt=St,It=ze,Dt=Be;function Ft(e,s,a){var t=s&&a||0;typeof e=="string"&&(s=e==="binary"?new Array(16):null,e=null),e=e||{};var l=e.random||(e.rng||It)();if(l[6]=l[6]&15|64,l[8]=l[8]&63|128,s)for(var c=0;c<16;++c)s[t+c]=l[c];return s||Dt(l)}var Mt=Ft,Ct=kt,Je=Mt,be=Je;be.v1=Ct;be.v4=Je;var Z=be;const Tt=e=>e,Se=ye("runGTFS",{state:()=>({stateMachineArn:"arn:aws:states:ca-central-1:142023388927:stateMachine:quetzal-gtfs-api",bucket:"quetzal-api-bucket",callID:Z.v4(),status:"",running:!1,executionArn:"",error:!1,errorMessage:"",UploadedGTFS:[],selectedGTFS:[],parameters:{start_time:"6:00:00",end_time:"8:59:00",day:"tuesday"},widthDict:{bus:3,subway:8,rail:6,tram:5}}),actions:{cleanRun(){this.running=!1,this.executionArn="",this.error=!1,this.UploadedGTFS=[],this.selectedGTFS=[],this.callID=Z.v4()},setCallID(){this.callID=Z.v4()},terminateExecution(e){this.running=!1,this.error=!0,this.errorMessage=e,this.executionArn=""},changeRunning(e){this.running=e},saveParams(e){e.forEach(s=>this.parameters[s.name]=s.value)},saveSelectedGTFS(e){this.selectedGTFS=e},updateProgress(e){this.UploadedGTFS.filter(s=>s.name===e.name)[0].progress=e.progress},succeedExecution(){const e=w();this.running=!1,this.executionArn="",e.changeNotification({text:Tt("gtfs imported successfully!"),autoClose:!1,color:"success"})},async addGTFS(e){this.UploadedGTFS.map(t=>t==null?void 0:t.name).includes(e.info.name)||this.UploadedGTFS.push(e.info);const a=C.uploadObject(this.bucket,this.callID+"/"+e.info.name,e.content);a.on("httpUploadProgress",t=>{const l=Math.round(t.loaded/t.total*100);this.updateProgress({name:e.info.name,progress:l})}),a.done()},startExecution(e){this.running=!0,this.error=!1;let a={input:JSON.stringify({callID:this.callID,files:e.files,start_time:e.start_time,end_time:e.end_time,dates:e.dates}),name:Z.v4(),stateMachineArn:this.stateMachineArn};G.client.post("",a=JSON.stringify(a)).then(t=>{this.executionArn=t.data.executionArn,this.pollExecution()}).catch(t=>{w().changeAlert(t),this.running=!1,this.status="FAILED"})},async pollExecution(){const e=setInterval(()=>{let s={executionArn:this.executionArn};G.client.post("/describe",s=JSON.stringify(s)).then(async a=>{this.status=a.data.status,console.log(this.status),this.status==="SUCCEEDED"?(clearInterval(e),await this.downloadOSMFromS3(),this.succeedExecution()):["FAILED","TIMED_OUT","ABORTED"].includes(this.status)&&(this.terminateExecution(JSON.parse(a.data.cause)),clearInterval(e))}).catch(a=>{w().changeAlert(a)})},2e3)},stopExecution(){const e=w();let s={executionArn:this.executionArn};G.client.post("/abort",s=JSON.stringify(s)).then(a=>{this.terminateExecution(a.data)}).catch(a=>{e.changeAlert(a)})},async downloadOSMFromS3(){const e=ve();function s(l,c){return Object.keys(c).forEach(i=>{l.features.filter(r=>r.properties.route_type===i).forEach(r=>{r.properties.route_width=c[i]})}),l}let a=await C.readJson(this.bucket,this.callID.concat("/links.geojson"));a.features.length>0&&(a=s(a,this.widthDict)),e.appendNewLinks(a);const t=await C.readJson(this.bucket,this.callID.concat("/nodes.geojson"));e.appendNewNodes(t),Le.push("/Home").catch(()=>{})}},getters:{}}),Ot=["motorway","motorway_link","trunk","trunk_link","primary","primary_link","secondary","secondary_link","tertiary","tertiary_link","residential","living_street","service","unclassified","cycleway","pedestrian"],Et={motorway:"E892A2",motorway_link:"E892A2",trunk:"E892A2",trunk_link:"E892A2",primary:"FCD6A4",primary_link:"FCD6A4",secondary:"F7F9BE",secondary_link:"F7F9BE",tertiary:"808080",tertiary_link:"808080",residential:"808080",living_street:"808080",service:"808080",unclassified:"808080",cycleway:"1D8621",pedestrian:"1D8621"},Gt={motorway:4,motorway_link:4,trunk:4,trunk_link:4,primary:4,primary_link:4,secondary:3,secondary_link:3,tertiary:2,tertiary_link:2,residential:2,living_street:2,service:2,unclassified:2,cycleway:2,pedestrian:2},Vt={name:"NodesLayer",components:{MglGeojsonLayer:Pe},props:["map","nodes","active"],event:["move","rightClick"],data(){return{hoveredStateId:null,keepHovering:!1,dragNode:!1}},computed:{},watch:{},created(){},methods:{onCursor(e){if(this.active&&this.hoveredStateId===null){this.map.getCanvas().style.cursor="pointer";const s=[...new Set(e.mapboxEvent.features.map(a=>a.id))];this.hoveredStateId={layerId:e.layerId,id:s},this.map.setFeatureState({source:this.hoveredStateId.layerId,id:this.hoveredStateId.id[0]},{hover:!0})}},offCursor(e){this.active&&this.hoveredStateId!==null&&(this.keepHovering?this.dragNode=!0:(this.map.getCanvas().style.cursor="",this.map.setFeatureState({source:this.hoveredStateId.layerId,id:this.hoveredStateId.id[0]},{hover:!1}),this.hoveredStateId=null))},rightClick(e){var s;if(!this.dragNode&&((s=this.hoveredStateId)==null?void 0:s.layerId)==="nodes"){const t=this.map.querySourceFeatures(this.hoveredStateId.layerId).filter(c=>c.id===this.hoveredStateId.id[0])[0],l={selectedFeature:t};t&&this.$emit("rightClick",l)}},moveNode(e){var s,a;if(this.active&&((s=this.hoveredStateId)==null?void 0:s.layerId)==="nodes"&&e.mapboxEvent.originalEvent.button===0){e.mapboxEvent.preventDefault(),this.map.getCanvas().style.cursor="grab",this.keepHovering=!0;const t=this.map.querySourceFeatures(this.hoveredStateId.layerId);this.selectedFeature=t.filter(l=>l.id===this.hoveredStateId.id[0])[0],(a=this.selectedFeature)!=null&&a.properties&&(this.map.on("mousemove",this.onMove),this.map.on("mouseup",this.stopMovingNode))}},onMove(e){if(this.dragNode&&this.selectedFeature){const s={selectedFeature:this.selectedFeature,lngLat:Object.values(e.lngLat)};this.$emit("move",s)}},stopMovingNode(e){this.active&&e.originalEvent.button===0&&(this.map.getCanvas().style.cursor="pointer",this.map.off("mousemove",this.onMove),this.keepHovering=!1,this.dragNode=!1,this.map.getCanvas().style.cursor="",this.hoveredStateId&&this.map.setFeatureState({source:this.hoveredStateId.layerId,id:this.hoveredStateId.id[0]},{hover:!1}),this.hoveredStateId=null,this.map.off("mouseup",this.stopMovingNode))}}};function At(e,s,a,t,l,c){const i=k("MglGeojsonLayer");return m(),x(i,{"source-id":"nodes",source:{type:"geojson",data:a.nodes,buffer:0,promoteId:"index"},"layer-id":"nodes",layer:{interactive:!0,type:"circle",paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,5],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onMouseover:c.onCursor,onMouseleave:c.offCursor,onMousedown:c.moveNode,onContextmenu:c.rightClick},null,8,["source","layer","onMouseover","onMouseleave","onMousedown","onContextmenu"])}const Nt=R(Vt,[["render",At]]);const me=e=>e,Lt="pk.eyJ1Ijoic2JvaXZpbiIsImEiOiJja3BlMm41cm4xa2QyMnZwZTBqdGx4bHI0In0.11oH2-B2g9J6LarDnoqQfQ",Pt={name:"MapSelector",events:["change"],components:{MglMap:Ke,MglNavigationControl:$e,MglScaleControl:Ye,MglGeojsonLayer:Pe,NodesLayer:Nt},setup(){const e=w(),s=ie(),a=Lt,t=g(!1),l=g(null),c=g({}),i=g(!1),r=v(()=>e.mapStyle),n=v(()=>s.rlinksIsEmpty),f=v(()=>s.rnodesHeader);return{store:e,mapIsLoaded:t,mapboxPublicKey:a,poly:l,nodes:c,freeForm:i,mapStyle:r,rlinksIsEmpty:n,nodesHeader:f}},watch:{mapStyle(){try{this.map.removeLayer("stroke")}catch{}}},beforeDestroy(){var s;const e=(s=this.map)==null?void 0:s.getCenter();e&&this.store.saveMapPosition({mapCenter:[e.lng,e.lat],mapZoom:this.map.getZoom()}),this.storesaveImportPoly({freeForm:this.freeForm,poly:this.poly});try{this.map.removeLayer("stroke")}catch{}},methods:{onMapLoaded(e){var s;e.map.dragRotate.disable(),this.map=e.map,this.map.on("dragend",this.getBounds),this.map.on("zoomend",this.getBounds),this.freeForm=!1,(s=this.store.importPoly)!=null&&s.freeForm?(this.poly=this.store.importPoly.poly,this.toggleFreeForm()):this.getBounds(),this.mapIsLoaded=!0},getBounds(){const e=this.map.getBounds(),s=pe([e._sw.lng,e._sw.lat,e._ne.lng,e._ne.lat]);this.poly=Qe(s,-.1*(e._ne.lat-e._sw.lat),{units:"degrees"}),this.poly.geometry.coordinates[0]=this.poly.geometry.coordinates[0].reverse();const a=[e._sw.lat,e._sw.lng,e._ne.lat,e._ne.lng];this.$emit("change",{style:"bbox",geometry:a})},toggleFreeForm(e){this.freeForm=!this.freeForm,this.freeForm?(this.map.off("dragend",this.getBounds),this.map.off("zoomend",this.getBounds),this.getNodes(),this.store.changeNotification({text:me("Click to add points. Right click de remove"),autoClose:!1})):(this.map.on("dragend",this.getBounds),this.map.on("zoomend",this.getBounds),this.getBounds(),this.store.changeNotification({text:"",autoClose:!0}))},onHover(){this.freeForm&&(this.map.getCanvas().style.cursor="pointer")},offHover(){this.freeForm&&(this.map.getCanvas().style.cursor="")},getNodes(){const e=Xe.cloneDeep(this.nodesHeader),s=this.poly.geometry.coordinates[0];s.slice(0,s.length-1).forEach((a,t)=>e.features.push(Ie(a,{index:et.generate(),coordinatesIndex:t}))),this.nodes=e,this.$emit("change",{style:"poly",geometry:this.poly.geometry.coordinates[0]})},moveNode(e){const s=e.selectedFeature.properties.coordinatesIndex,a=this.poly.geometry.coordinates[0];a[s]=e.lngLat,s===0&&(a[a.length-1]=e.lngLat),this.getNodes()},removeNode(e){const s=e.selectedFeature.properties.coordinatesIndex,a=this.poly.geometry.coordinates[0];a.length<=4?this.store.changeNotification({text:me("Cannot delete anymore"),autoClose:!0}):s===0?this.store.changeNotification({text:me("cannot delete first point of polygon"),autoClose:!0}):(this.poly.geometry.coordinates[0]=[...a.slice(0,s),...a.slice(s+1)],this.getNodes())},addNode(e){if(this.freeForm&&Object.keys(e).includes("mapboxEvent")){const s=this.poly.geometry.coordinates[0],a=e.mapboxEvent.lngLat,t=tt(s),l=Ie(Object.values(a)),i=st(t,l,{units:"kilometers"}).properties.index+1;s.splice(i,0,Object.values(a)),this.getNodes()}}}};function Ut(e,s,a,t,l,c){const i=k("MglScaleControl"),r=k("MglNavigationControl"),n=k("MglGeojsonLayer"),f=k("NodesLayer"),y=k("MglMap");return m(),x(y,{key:t.mapStyle,class:"map",center:t.store.mapCenter,zoom:t.store.mapZoom,"min-zoom":3,"access-token":t.mapboxPublicKey,"map-style":t.mapStyle,onLoad:c.onMapLoaded,onClick:c.addNode},{default:d(()=>[o(i,{position:"bottom-right"}),o(r,{position:"bottom-right"}),o(b,{class:"freeform-button",size:"small",icon:t.freeForm?"far fa-square":"fas fa-vector-square",onClick:c.toggleFreeForm},null,8,["icon","onClick"]),o(n,{"source-id":"polygon",source:{type:"geojson",data:t.poly,promoteId:"index"},"layer-id":"poly",layer:{interactive:!0,type:"fill",paint:{"fill-color":e.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}},onMouseover:c.onHover,onMouseleave:c.offHover},null,8,["source","layer","onMouseover","onMouseleave"]),o(n,{"source-id":"polygon",type:"line",source:"polygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":e.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"]),t.mapIsLoaded?(m(),x(f,{key:0,map:e.map,nodes:t.freeForm?t.nodes:t.nodesHeader,active:t.freeForm,onMove:c.moveNode,onRightClick:c.removeNode},null,8,["map","nodes","active","onMove","onRightClick"])):V("",!0)]),_:1},8,["center","zoom","access-token","map-style","onLoad","onClick"])}const Ze=R(Pt,[["render",Ut],["__scopeId","data-v-08f93d14"]]),Rt=e=>e,qt=ye("runOSM",{state:()=>({stateMachineArn:"arn:aws:states:ca-central-1:142023388927:stateMachine:quetzal-osm-api",bucket:"quetzal-api-bucket",callID:"",status:"",timer:0,running:!1,executionArn:"",error:!1,errorMessage:"",tags:["highway","maxspeed","lanes","name","oneway","surface"],parameters:{extendedCycleway:!1,highway:["motorway","motorway_link","trunk","trunk_link","primary","primary_link"]},colorDict:Et,widthDict:Gt}),actions:{cleanRun(){this.running=!1,this.executionArn="",this.error=!1},setCallID(){this.callID=Z.v4()},terminateExecution(e){this.running=!1,this.error=!0,this.errorMessage=e,this.executionArn=""},changeRunning(e){this.running=e},saveParams(e){Object.keys(e).forEach(s=>this.parameters[s]=e[s])},succeedExecution(){this.running=!1,this.executionArn="",w().changeNotification({text:Rt("OSM network imported successfully!"),autoClose:!1,color:"success"})},startExecution(e){this.running=!0,this.error=!1;let s="";e.method==="bbox"?s=JSON.stringify({bbox:e.coords,highway:this.parameters.highway,callID:this.callID,elevation:!0,extended_cycleway:this.parameters.extendedCycleway}):s=JSON.stringify({poly:e.coords,highway:this.parameters.highway,callID:this.callID,elevation:!0,extended_cycleway:this.parameters.extendedCycleway});let a={input:s,name:this.callID,stateMachineArn:this.stateMachineArn};G.client.post("",a=JSON.stringify(a)).then(t=>{this.executionArn=t.data.executionArn,this.pollExecution()}).catch(t=>{w().changeAlert(t),this.running=!1,this.status="FAILED"})},async pollExecution(){const e=setInterval(()=>{let s={executionArn:this.executionArn};this.timer=this.timer-2,G.client.post("/describe",s=JSON.stringify(s)).then(async a=>{this.status=a.data.status,console.log(this.status),this.status==="SUCCEEDED"?(clearInterval(e),await this.downloadOSMFromS3(),this.succeedExecution()):["FAILED","TIMED_OUT","ABORTED"].includes(this.status)&&(this.terminateExecution(JSON.parse(a.data.cause)),clearInterval(e))}).catch(a=>{w().changeAlert(a)})},2e3)},stopExecution(){let e={executionArn:this.executionArn};G.client.post("/abort",e=JSON.stringify(e)).then(s=>{this.terminateExecution(s.data)}).catch(s=>{w().changeAlert(s)})},async downloadOSMFromS3(){function e(l,c,i){return Object.keys(c).forEach(r=>{l.features.filter(n=>n.properties.highway===r).forEach(n=>{n.properties.route_width=i[r],n.properties.route_color=c[r]})}),l}let s=await C.readJson(this.bucket,this.callID.concat("/links.geojson"));s=e(s,this.colorDict,this.widthDict);const a=ie();a.appendNewrLinks(s);const t=await C.readJson(this.bucket,this.callID.concat("/nodes.geojson"));a.appendNewrNodes(t),Le.push("/Home").catch(()=>{})}},getters:{highway:e=>e.parameters.highway,extendedCycleway:e=>e.parameters.extendedCycleway}});const Ht={name:"OSMImporter",components:{MapSelector:Ze},setup(){const e=w(),s=qt(),a=ie(),t=g(!1),l=g(null),c=g({}),i=g(null),r=g(!1),n=g(Ot),f=v(()=>a.rlinksIsEmpty),y=v(()=>s.highway),I=v(()=>s.extendedCycleway),D=v(()=>s.callID),F=v(()=>s.running),q=v(()=>s.error),H=v(()=>s.errorMessage);function z(M){l.value=M}function L(){f.value?(s.saveParams({highway:i.value,extendedCycleway:r.value}),s.setCallID(),s.startExecution({coords:l.value.geometry,method:l.value.style})):t.value=!0}function E(){e.initrLinks(),t.value=!1,L()}return Ue(()=>{i.value=y.value,r.value=I.value}),_e(()=>{s.saveParams({highway:i.value,extendedCycleway:r.value})}),{showOverwriteDialog:t,poly:l,nodes:c,selectedHighway:i,selectedExtended:r,highwayList:n,rlinksIsEmpty:f,highway:y,extendedCycleway:I,callID:D,running:F,error:q,errorMessage:H,getBBOX:z,importOSM:L,applyOverwriteDialog:E}}},zt={class:"background"},jt={key:1,class:"text-grey text-caption align-self-center"};function Bt(e,s,a,t,l,c){const i=k("MapSelector");return m(),_("section",zt,[o(N,{class:"card"},{default:d(()=>[o(A,null,{default:d(()=>[h(u(e.$gettext("Import OSM network in bounding box")),1)]),_:1}),o(P),o(W,null,{default:d(()=>[t.error?(m(),x(le,{key:0,density:"compact",width:"50rem",variant:"outlined",text:"",type:"error"},{default:d(()=>[h(u(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(m(!0),_(T,null,O(Object.keys(t.errorMessage),r=>(m(),_("p",{key:r},[p("b",null,u(r)+": ",1),h(u(t.errorMessage[r]),1)]))),128))]),_:1})):V("",!0)]),_:1}),o(i,{onChange:t.getBBOX},null,8,["onChange"]),o(at),o(Q,null,{default:d(()=>[o(P),o(de,{modelValue:t.selectedHighway,"onUpdate:modelValue":s[0]||(s[0]=r=>t.selectedHighway=r),class:"select",items:t.highwayList,label:"Select Item",variant:"underlined",multiple:""},{selection:d(({item:r,index:n})=>[n<2?(m(),x(rt,{key:0},{default:d(()=>[p("span",null,u(r.title),1)]),_:2},1024)):V("",!0),n===2?(m(),_("span",jt," (+"+u(t.selectedHighway.length-2)+" others) ",1)):V("",!0)]),_:1},8,["modelValue","items"]),o(P),o(Re,{modelValue:t.selectedExtended,"onUpdate:modelValue":s[1]||(s[1]=r=>t.selectedExtended=r),label:"Extended cycleway"},null,8,["modelValue"]),o(P),o(b,{variant:"outlined",color:"success",loading:t.running,disabled:t.running,onClick:t.importOSM},{default:d(()=>[h(u(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1}),o(xe,{modelValue:t.showOverwriteDialog,"onUpdate:modelValue":s[3]||(s[3]=r=>t.showOverwriteDialog=r),persistent:"","max-width":"500",onKeydown:[K(t.applyOverwriteDialog,["enter"]),s[4]||(s[4]=K(r=>t.showOverwriteDialog=!1,["esc"]))]},{default:d(()=>[o(N,null,{default:d(()=>[o(A,{class:"text-h5"},{default:d(()=>[h(u(e.$gettext("Overwrite current road network ?")),1)]),_:1}),o(Q,null,{default:d(()=>[o(P),o(b,{color:"regular",onClick:s[2]||(s[2]=r=>t.showOverwriteDialog=!t.showOverwriteDialog)},{default:d(()=>[h(u(e.$gettext("No")),1)]),_:1}),o(b,{color:"primary",onClick:t.applyOverwriteDialog},{default:d(()=>[h(u(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const Jt=R(Ht,[["render",Bt],["__scopeId","data-v-789fe19d"]]),Zt={name:"DatePicker",components:{},props:["date","from","to"],events:["update:date"],data(){return{isoDate:null,dateMax:null,dateMin:null,menu:!1}},computed:{textDate(){return this.isoDate?this.isoDate.toISOString().substring(0,10):""}},watch:{isoDate(e){this.$emit("update:date",this.parseOutput(e))}},mounted(){this.isoDate=this.parseInput(String(this.date)),this.dateMin=this.parseInput(String(this.from)),this.dateMax=this.parseInput(String(this.to))},methods:{parseInput(e){if(e)return new Date(e.substring(0,4)+"-"+e.substring(4,6)+"-"+e.substring(6,8))},parseOutput(e){return e.toISOString().substring(0,10).replaceAll("-","")}}};function Wt(e,s,a,t,l,c){return m(),x(it,{modelValue:l.menu,"onUpdate:modelValue":s[1]||(s[1]=i=>l.menu=i),"close-on-content-click":!1,transition:"scale-transition","max-width":"290px","min-width":"auto"},{activator:d(({props:i})=>[o(X,nt({"model-value":c.textDate,"persistent-hint":"",readonly:"",variant:"underlined"},i),null,16,["model-value"])]),default:d(()=>[o(ot,{modelValue:l.isoDate,"onUpdate:modelValue":s[0]||(s[0]=i=>l.isoDate=i)},null,8,["modelValue"])]),_:1},8,["modelValue"])}const Kt=R(Zt,[["render",Wt]]);const Ge=e=>e,$t={name:"GTFSWebImporter",components:{DatePicker:Kt},setup(){const e=Se(),s=ve(),a=w(),t=g(!1),l=g(null),c=g({}),i=g([]),r=g(!1),n=g(!1),f=v(()=>s.linksIsEmpty),y=v(()=>e.UploadedGTFS),I=v(()=>e.callID),D=v(()=>e.running),F=v(()=>e.error),q=v(()=>e.errorMessage),H=v(()=>y.value.filter(M=>M.progress<100).length>0);_e(()=>{e.saveParams(E.value)});const z=/^(0?[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/,L={required:M=>!!M||Ge("Required"),timeRule:M=>z.test(M)||Ge("invalid date time")},E=g([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"String",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"String",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required","timeRule"]}]);return{showOverwriteDialog:t,poly:l,runGTFS:e,store:a,nodes:c,gtfsList:i,checkall:r,showHint:n,parameters:E,rules:L,linksIsEmpty:f,UploadedGTFS:y,callID:I,running:D,error:F,errorMessage:q,isUploading:H}},methods:{uploadGTFS(){this.$refs.zipInput.click(),document.getElementById("zip-input").value=""},async readZip(e){try{this.store.changeLoading(!0);const s=e.target.files;if(!s.length){this.store.changeLoading(!1);return}for(const a of s){const t=await lt(a),l=t.reduce((r,n)=>n.start_date<r?n.start_date:r,t[0].start_date),c=t.reduce((r,n)=>n.end_date>r?n.end_date:r,t[0].end_date),i={content:a,info:{name:a.name,minDate:l,maxDate:c,date:l,progress:0}};await this.runGTFS.addGTFS(i)}this.store.changeLoading(!1)}catch(s){this.store.changeLoading(!1),this.store.changeAlert(s)}},importGTFS(){if(this.linksIsEmpty){const e=this.UploadedGTFS.map(t=>t.name),s=this.UploadedGTFS.map(t=>t.date),a={files:e,dates:s};this.parameters.forEach(t=>{a[t.name]=t.value}),this.runGTFS.startExecution(a)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},Yt=e=>(qe("data-v-15c8ebf3"),e=e(),He(),e),Qt={class:"params-row"},Xt={class:"list"},es={class:"list-row bold"},ts=Yt(()=>p("span",{class:"list-item-small"},null,-1)),ss={class:"list-item-large"},as={class:"list-item-medium"},rs={class:"list-item-medium"},ns={class:"list-item-medium"},os={class:"list-item-small"},is={class:"list-item-small"},ls={class:"list-item-large"},ds={class:"list-item-medium"},cs={class:"list-item-medium"},us={class:"list-item-medium"},hs={class:"list-item-small"},ms={class:"bottom-button"};function ps(e,s,a,t,l,c){const i=k("v-card-action"),r=k("DatePicker");return m(),_("div",null,[p("input",{id:"zip-input",ref:"zipInput",type:"file",style:{display:"none"},accept:".zip",multiple:"multiple",onChange:s[0]||(s[0]=(...n)=>c.readZip&&c.readZip(...n))},null,544),o(N,{class:"card"},{default:d(()=>[o(A,{class:"subtitle"},{default:d(()=>[h(u(e.$gettext("GTFS importer")),1)]),_:1}),o(W,null,{default:d(()=>[h(u(e.$gettext("import GTFS from local computer")),1)]),_:1}),o(W,null,{default:d(()=>[h(u(e.$gettext("Add GTFS files. When its done uploading press Convert")),1)]),_:1}),o(i,null,{default:d(()=>[o(b,{disabled:t.running,"prepend-icon":"fa-solid fa-file-archive",onClick:c.uploadGTFS},{default:d(()=>[h(u(e.$gettext("upload GTFS")),1)]),_:1},8,["disabled","onClick"])]),_:1}),o(W,null,{default:d(()=>[t.error?(m(),x(le,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:d(()=>[h(u(e.$gettext("There as been an error while converting your GTFS.             Please try again. If the problem persist, contact us."))+" ",1),(m(!0),_(T,null,O(Object.keys(t.errorMessage),n=>(m(),_("p",{key:n},[p("b",null,u(n)+": ",1),h(u(t.errorMessage[n]),1)]))),128))]),_:1})):V("",!0)]),_:1}),p("div",Qt,[(m(!0),_(T,null,O(t.parameters,(n,f)=>(m(),_("div",{key:f,class:"params"},[typeof n.items>"u"?(m(),x(X,{key:0,modelValue:n.value,"onUpdate:modelValue":y=>n.value=y,type:n.type,variant:"underlined",label:e.$gettext(n.text),suffix:n.units,hint:t.showHint?e.$gettext(n.hint):"","persistent-hint":t.showHint,rules:n.rules.map(y=>t.rules[y]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(m(),x(de,{key:1,modelValue:n.value,"onUpdate:modelValue":y=>n.value=y,type:n.type,items:n.items,label:e.$gettext(n.text),suffix:n.units,hint:t.showHint?e.$gettext(n.hint):"","persistent-hint":t.showHint,rules:n.rules.map(y=>t.rules[y]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),p("div",Xt,[p("li",es,[ts,p("span",ss,u(e.$gettext("name")),1),p("span",as,u(e.$gettext("from")),1),p("span",rs,u(e.$gettext("to")),1),p("span",ns,u(e.$gettext("selected date")),1),p("span",os,u(e.$gettext("Uploaded")),1)]),(m(!0),_(T,null,O(t.UploadedGTFS,(n,f)=>(m(),_("ul",{key:f,class:"list-row"},[p("span",is,u(f),1),p("span",ls,u(n.name),1),p("span",ds,u(n.minDate),1),p("span",cs,u(n.maxDate),1),p("span",us,[o(r,{date:n.date,from:n.minDate,to:n.maxDate,"onUpdate:date":y=>n.date=y},null,8,["date","from","to","onUpdate:date"])]),p("span",hs,[n.progress<100?(m(),x(dt,{key:0,indeterminate:n.progress===0,absolute:"",color:"primary","model-value":n.progress},null,8,["indeterminate","model-value"])):(m(),x(U,{key:1},{default:d(()=>[h("fas fa-check")]),_:1}))])]))),128))]),p("div",ms,[o(b,{loading:t.running,disabled:t.running||t.UploadedGTFS.length==0||t.isUploading,color:"success",onClick:c.importGTFS},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-play ")]),_:1}),h(" "+u(e.$gettext("convert")),1)]),_:1},8,["loading","disabled","onClick"])])]),_:1}),o(xe,{modelValue:t.showOverwriteDialog,"onUpdate:modelValue":s[2]||(s[2]=n=>t.showOverwriteDialog=n),persistent:"","max-width":"500",onKeydown:[K(c.applyOverwriteDialog,["enter"]),s[3]||(s[3]=K(n=>t.showOverwriteDialog=!1,["esc"]))]},{default:d(()=>[o(N,null,{default:d(()=>[o(A,{class:"text-h5"},{default:d(()=>[h(u(e.$gettext("Overwrite current road network ?")),1)]),_:1}),o(Q,null,{default:d(()=>[o(P),o(b,{color:"regular",onClick:s[1]||(s[1]=n=>t.showOverwriteDialog=!t.showOverwriteDialog)},{default:d(()=>[h(u(e.$gettext("No")),1)]),_:1}),o(b,{color:"primary",onClick:c.applyOverwriteDialog},{default:d(()=>[h(u(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const fs=R($t,[["render",ps],["__scopeId","data-v-15c8ebf3"]]);function gs(e,s){var a=!0;return oe(e,function(t){oe(s,function(l){if(a===!1)return!1;a=ys(t.geometry,l.geometry)})}),a}function ys(e,s){switch(e.type){case"Point":switch(s.type){case"Point":return!ws(e.coordinates,s.coordinates);case"LineString":return!Ve(s,e);case"Polygon":return!ee(e,s)}break;case"LineString":switch(s.type){case"Point":return!Ve(e,s);case"LineString":return!vs(e,s);case"Polygon":return!Ae(s,e)}break;case"Polygon":switch(s.type){case"Point":return!ee(s,e);case"LineString":return!Ae(e,s);case"Polygon":return!_s(s,e)}}return!1}function Ve(e,s){for(var a=0;a<e.coordinates.length-1;a++)if(xs(e.coordinates[a],e.coordinates[a+1],s.coordinates))return!0;return!1}function vs(e,s){var a=we(e,s);return a.features.length>0}function Ae(e,s){for(var a=0,t=s.coordinates;a<t.length;a++){var l=t[a];if(ee(l,e))return!0}var c=we(s,fe(e));return c.features.length>0}function _s(e,s){for(var a=0,t=e.coordinates[0];a<t.length;a++){var l=t[a];if(ee(l,s))return!0}for(var c=0,i=s.coordinates[0];c<i.length;c++){var r=i[c];if(ee(r,e))return!0}var n=we(fe(e),fe(s));return n.features.length>0}function xs(e,s,a){var t=a[0]-e[0],l=a[1]-e[1],c=s[0]-e[0],i=s[1]-e[1],r=t*i-l*c;return r!==0?!1:Math.abs(c)>=Math.abs(i)?c>0?e[0]<=a[0]&&a[0]<=s[0]:s[0]<=a[0]&&a[0]<=e[0]:i>0?e[1]<=a[1]&&a[1]<=s[1]:s[1]<=a[1]&&a[1]<=e[1]}function ws(e,s){return e[0]===s[0]&&e[1]===s[1]}function bs(e,s){var a=!1;return oe(e,function(t){oe(s,function(l){if(a===!0)return!0;a=!gs(t.geometry,l.geometry)})}),a}var Ss=function(e,s){if(e===null)throw new Error("No coordinates passed");for(var a=0;a<e.length;a++)for(var t=e[a],l=0;l<t[t.length-1].length;l++){if(t.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(t[t.length-1][l]!==t[0][l])throw new Error("First and last Position are not equivalent.")}var c={type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:s};return c.properties||(c.properties={}),c};const ks=ct(Ss);const Ne=e=>e,Is={name:"GTFSWebImporter",components:{MapSelector:Ze},setup(){const e=Se(),s=ve(),a=w(),t=g(!1),l=g(null),c=g({}),i=g([]),r=g([]),n=g(!1),f=g(!1),y=g(e.selectedGTFS),I=v(()=>s.linksIsEmpty),D=v(()=>e.UploadedGTFS),F=v(()=>e.callID),q=v(()=>e.running),H=v(()=>e.error),z=v(()=>e.errorMessage),L=v(()=>D.value.filter(j=>j.progress<100).length>0);_e(()=>{e.saveParams(E.value),e.saveSelectedGTFS(y.value)});const E=g([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"String",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"String",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),M=/^(0?[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return{showOverwriteDialog:t,poly:l,runGTFS:e,store:a,nodes:c,gtfsList:i,availableGTFS:r,selectedGTFS:y,checkall:n,showHint:f,parameters:E,rules:{required:j=>!!j||Ne("Required"),timeRule:j=>M.test(j)||Ne("invalid date time")},linksIsEmpty:I,UploadedGTFS:D,callID:F,running:q,error:H,errorMessage:z,isUploading:L}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,s)=>{try{e.bbox=pe([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=s}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,s)=>e["location.country_code"]<s["location.country_code"]?-1:e["location.country_code"]>s["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const s=await e.arrayBuffer();return ut(s)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const a=this.poly.geometry;e=pe([a[1],a[0],a[3],a[2]])}else e=ks([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(a=>De(e,a.bbox)||bs(e,a.bbox)),this.availableGTFS.forEach(a=>a.allInPolygon=De(e,a.bbox));const s=new Set(this.availableGTFS.map(a=>a.index));this.selectedGTFS=this.selectedGTFS.filter(a=>s.has(a))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const a={files:this.availableGTFS.filter(t=>this.selectedGTFS.includes(t.index)).map(t=>t["urls.latest"])};this.parameters.forEach(t=>{a[t.name]=t.value}),this.runGTFS.startExecution(a)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},te=e=>(qe("data-v-ec4dddae"),e=e(),He(),e),Ds={class:"background"},Fs={class:"params-row"},Ms={class:"list"},Cs={class:"list-row"},Ts={class:"list-item-small"},Os=te(()=>p("span",{class:"list-item-small"},"All in polygon",-1)),Es=te(()=>p("span",{class:"list-item-small"},"Code",-1)),Gs=te(()=>p("span",{class:"list-item-medium"},"Name",-1)),Vs=te(()=>p("span",{class:"list-item-large"},"City",-1)),As=te(()=>p("span",{class:"list-item-large"},"Agency",-1)),Ns={class:"list-item-small"},Ls={class:"list-item-small"},Ps={class:"list-item-small"},Us={class:"list-item-medium"},Rs={class:"list-item-large"},qs={class:"list-item-large"};function Hs(e,s,a,t,l,c){const i=k("MapSelector");return m(),_("div",Ds,[o(N,{class:"card"},{default:d(()=>[o(A,{class:"subtitle"},{default:d(()=>[h(u(e.$gettext("GTFS importer")),1)]),_:1}),o(i,{onChange:c.getBBOX},null,8,["onChange"])]),_:1}),o(N,{class:"card2"},{default:d(()=>[o(A,{class:"subtitle"},{default:d(()=>[h(u(e.$gettext("Available GTFS")),1)]),_:1}),o(W,null,{default:d(()=>[h(u(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),o(b,{disabled:t.running,onClick:c.getAvaileGTFS},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-sync ")]),_:1}),h(" "+u(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),o(b,{loading:t.running,disabled:t.running||t.selectedGTFS.length===0,color:"success",onClick:c.importGTFS},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-play ")]),_:1}),h(" "+u(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","onClick"]),o(W,null,{default:d(()=>[t.error?(m(),x(le,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:d(()=>[h(u(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(m(!0),_(T,null,O(Object.keys(t.errorMessage),r=>(m(),_("p",{key:r},[p("b",null,u(r)+": ",1),h(u(t.errorMessage[r]),1)]))),128))]),_:1})):V("",!0)]),_:1}),p("div",Fs,[(m(!0),_(T,null,O(t.parameters,(r,n)=>(m(),_("div",{key:n,class:"params"},[typeof r.items>"u"?(m(),x(X,{key:0,modelValue:r.value,"onUpdate:modelValue":f=>r.value=f,type:r.type,label:e.$gettext(r.text),suffix:r.units,variant:"underlined",hint:t.showHint?e.$gettext(r.hint):"","persistent-hint":t.showHint,rules:r.rules.map(f=>t.rules[f]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(m(),x(de,{key:1,modelValue:r.value,"onUpdate:modelValue":f=>r.value=f,variant:"underlined",type:r.type,items:r.items,label:e.$gettext(r.text),suffix:r.units,hint:t.showHint?e.$gettext(r.hint):"","persistent-hint":t.showHint,rules:r.rules.map(f=>t.rules[f]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),p("div",Ms,[p("ul",Cs,[p("span",Ts,[o(Re,{disabled:!0})]),Os,Es,Gs,Vs,As]),(m(!0),_(T,null,O(t.availableGTFS,(r,n)=>(m(),_("ul",{key:r.index,class:"list-row"},[p("span",Ns,[o(ht,{modelValue:t.selectedGTFS,"onUpdate:modelValue":s[0]||(s[0]=f=>t.selectedGTFS=f),value:r.index,label:String(n)},null,8,["modelValue","value","label"])]),p("span",Ls,u(r.allInPolygon),1),p("span",Ps,u(r["location.country_code"]),1),p("span",Us,u(r["location.subdivision_name"]),1),p("span",Rs,u(r["location.municipality"]),1),p("span",qs,u(r.provider),1)]))),128))])]),_:1}),o(xe,{modelValue:t.showOverwriteDialog,"onUpdate:modelValue":s[2]||(s[2]=r=>t.showOverwriteDialog=r),persistent:"","max-width":"500",onKeydown:[K(c.applyOverwriteDialog,["enter"]),s[3]||(s[3]=K(r=>t.showOverwriteDialog=!1,["esc"]))]},{default:d(()=>[o(N,null,{default:d(()=>[o(A,{class:"text-h5"},{default:d(()=>[h(u(e.$gettext("Overwrite current road network ?")),1)]),_:1}),o(Q,null,{default:d(()=>[o(P),o(b,{color:"regular",onClick:s[1]||(s[1]=r=>t.showOverwriteDialog=!t.showOverwriteDialog)},{default:d(()=>[h(u(e.$gettext("No")),1)]),_:1}),o(b,{color:"primary",onClick:c.applyOverwriteDialog},{default:d(()=>[h(u(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const zs=R(Is,[["render",Hs],["__scopeId","data-v-ec4dddae"]]),js=e=>e,Bs=ye("runMRC",{state:()=>({stateMachineArn:"arn:aws:states:ca-central-1:142023388927:stateMachine:quetzal-matrixroadcaster-api",bucket:"quetzal-api-bucket",callID:"",status:"",timer:0,running:!1,executionArn:"",error:!1,errorMessage:"",parameters:{callID:"test",num_zones:100,train_size:100,date_time:"2022-12-13T08:00:21-04:00",ff_time_col:"time",max_speed:100,num_cores:1,num_random_od:1,create_zone:!0,hereApiKey:""}}),actions:{cleanRun(){this.running=!1,this.executionArn="",this.error=!1},setCallID(){this.callID=Z.v4()},setParameters(e){this.parameters=e},terminateExecution(e){this.running=!1,this.error=!0,this.errorMessage=e,this.executionArn=""},changeRunning(e){this.running=e},getApproxTimer(e){const s=this.parameters.num_zones,a=this.parameters.train_size,t=this.parameters.num_random_od;this.timer=Math.min(s,a)*1.8+e*.002+15,this.timer+=10*t},succeedExecution(){this.running=!1,this.executionArn="",w().changeNotification({text:js("Matrix Road Caster executed successfully!"),autoClose:!1,color:"success"})},async startExecution(e){this.getApproxTimer(e.rlinks.features.length),this.setParameters(e.parameters),console.log("exporting roads to s3"),this.error=!1,this.running=!0;try{await C.putObject(this.bucket,this.callID.concat("/road_links.geojson"),JSON.stringify(e.rlinks)),await C.putObject(this.bucket,this.callID.concat("/road_nodes.geojson"),JSON.stringify(e.rnodes))}catch(a){w().changeAlert(a)}let s={input:JSON.stringify(this.parameters),name:this.callID,stateMachineArn:this.stateMachineArn};G.client.post("",s=JSON.stringify(s)).then(a=>{this.executionArn=a.data.executionArn,this.pollExecution()}).catch(a=>{w().changeAlert(a),this.running=!1,this.status="FAILED"})},pollExecution(){const e=setInterval(()=>{let s={executionArn:this.executionArn};this.timer=this.timer-2,G.client.post("/describe",s=JSON.stringify(s)).then(a=>{this.status=a.data.status,console.log(this.status),this.status==="SUCCEEDED"?(this.succeedExecution(),clearInterval(e)):["FAILED","TIMED_OUT","ABORTED"].includes(this.status)&&(this.terminateExecution(JSON.parse(a.data.cause)),clearInterval(e))}).catch(a=>{w().changeAlert(a)})},2e3)},stopExecution(){let e={executionArn:this.executionArn};G.client.post("/abort",e=JSON.stringify(e)).then(s=>{this.terminateExecution(s.data)}).catch(s=>{w().changeAlert(s)})}}});const Y=e=>e,Js={name:"MatrixRoadCaster",components:{},setup(){const e=Bs(),s=ie(),a=w(),t=g([]),l=g(!1),c=g(!1),i=g(!0),r=g(!1),n=g([{name:"num_zones",text:"number of zones",value:null,type:"Number",units:"",hint:"number of zones. road nodes will be aggregate to form centroids",rules:["required","largerThanZero"]},{name:"train_size",text:"number of OD (api call)",value:null,type:"Number",units:"",hint:"number of OD to get from the API, the rest will be interpolated with ML",rules:["required","largerThanZero"]},{name:"date_time",text:"date Time",value:null,type:"String",units:"",hint:"DateTime in the past. (YYYY-MM-DDTHH:MM:SS(UTC-timezone) (-04:00 for montreal))",rules:["required","dateTimeRule"]},{name:"ff_time_col",text:"freeflow time on roads",value:null,items:s.rlineAttributes,type:"String",units:"",hint:"road links time (link length / speed) to use as a first approximation. this is the freeflow speed, or speed limit",rules:["required"]},{name:"max_speed",text:"max speed on road",value:null,type:"Number",units:"",hint:"Maximum allowed speed on a road. applying an OD matrix on the road network could result il unrealistic speed if not used.",rules:["required","largerThanZero"]},{name:"num_random_od",text:"number of OD to plot",value:null,type:"Number",units:"",hint:"number of OD calibration plot to produce. those are random OD.",rules:["required","largerThanZero"]},{name:"hereApiKey",text:"HERE api key",value:null,type:"password",units:"",hint:"HERE api key to download a set of OD",rules:["required"]}]),f=v(()=>e.bucket),y=v(()=>e.callID),I=v(()=>e.timer),D=v(()=>e.status),F=v(()=>e.running),q=v(()=>e.error),H=v(()=>e.errorMessage);Ue(()=>{const S=e.parameters;n.value.forEach(B=>B.value=S[B.name]),y.value&&M()}),mt(D,S=>{S==="SUCCEEDED"&&M()});async function z(S){if(!(await S).valid)return;e.setCallID();const J={callID:y.value};n.value.forEach(se=>{J[se.name]=se.value}),e.startExecution({rlinks:s.rlinks,rnodes:s.rnodes,parameters:J})}function L(){e.stopExecution()}async function E(){c.value=!0;const S=await C.readJson(f.value,y.value.concat("/road_links.geojson"));s.loadrLinks(S);const B=await C.readJson(f.value,y.value.concat("/road_nodes.geojson"));s.loadrNodes(B),c.value=!1,a.changeNotification({text:Y("Road links applied!"),autoClose:!0,color:"success"})}async function M(){const B=(await C.listFiles(f.value,y.value+"/")).filter(J=>J.endsWith(".png"));for(const J of B){const se=await C.getImagesURL(f.value,J);t.value.push(se)}}async function ke(){l.value=!0,await C.downloadFolder(f.value,y.value.concat("/")),l.value=!1}const j=g(!1),We=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;return{imgs:t,exporting:l,applying:c,validForm:i,showP:r,parameters:n,showHint:j,rules:{required:S=>!!S||Y("Required"),largerThanZero:S=>S>0||Y("should be larger than 0"),nonNegative:S=>S>=0||Y("should be larger or equal to 0"),dateTimeRule:S=>We.test(S)||Y("invalid date time")},timer:I,running:F,error:q,errorMessage:H,download:ke,run:z,stopRun:L,ApplyResults:E}}};function Zs(e,s,a,t,l,c){return m(),x(vt,{class:"ma-0 pa-2 background"},{default:d(()=>[o(Fe,null,{default:d(()=>[o(N,{class:"card"},{default:d(()=>[o(A,{class:"subtitle"},{default:d(()=>[h(u(e.$gettext("ML Matrix Road Caster")),1)]),_:1}),p("p",null,u(e.$gettext("1) Find n zones centroids using a Kmean clustering on the nodes")),1),p("p",null,u(e.$gettext("2) Call the Here Matrix API on random OD ( around 1% is sufficient )")),1),p("p",null,u(e.$gettext("3) Interpolate every other OD time with an hybrid Machine learning model")),1),p("p",null,u(e.$gettext("4) ajust the speed on the road network to match the routing time with the OD time using an iterative algorithm")),1),o(pt,{"validate-on":"submit lazy",onSubmit:ft(t.run,["prevent"])},{default:d(()=>[(m(!0),_(T,null,O(t.parameters,(i,r)=>(m(),_("div",{key:r},[i.type==="password"?(m(),x(X,{key:0,modelValue:i.value,"onUpdate:modelValue":n=>i.value=n,type:t.showP?"text":"password","append-icon":t.showP?"fas fa-eye":"fas fa-eye-slash",label:e.$gettext(i.text),suffix:i.units,hint:t.showHint?e.$gettext(i.hint):"","persistent-hint":t.showHint,rules:i.rules.map(n=>t.rules[n]),required:"","onClick:append":s[0]||(s[0]=n=>t.showP=!t.showP)},null,8,["modelValue","onUpdate:modelValue","type","append-icon","label","suffix","hint","persistent-hint","rules"])):typeof i.items>"u"?(m(),x(X,{key:1,modelValue:i.value,"onUpdate:modelValue":n=>i.value=n,type:i.type,label:e.$gettext(i.text),suffix:i.units,hint:t.showHint?e.$gettext(i.hint):"","persistent-hint":t.showHint,rules:i.rules.map(n=>t.rules[n]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(m(),x(de,{key:2,modelValue:i.value,"onUpdate:modelValue":n=>i.value=n,type:i.type,items:i.items,label:e.$gettext(i.text),suffix:i.units,hint:t.showHint?e.$gettext(i.hint):"","persistent-hint":t.showHint,rules:i.rules.map(n=>t.rules[n]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128)),o(Q,null,{default:d(()=>[o(b,{variant:"regular",color:"success",loading:t.running||e.importStatus==="RUNNING",disabled:t.running||e.importStatus==="RUNNING"||!t.validForm,type:"submit"},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-play ")]),_:1}),h(" "+u(e.$gettext("Run")),1)]),_:1},8,["loading","disabled"]),ae(o(b,{color:"grey",variant:"text",onClick:s[1]||(s[1]=i=>t.stopRun())},{default:d(()=>[h(u(e.$gettext("Abort")),1)]),_:1},512),[[re,e.importStatus=="RUNNING"]]),ae(o(gt,null,{default:d(()=>[h(" ~ "+u(t.timer>0?Math.ceil(t.timer/60):e.$gettext("less than 1"))+u(e.$gettext(" minutes remaining")),1)]),_:1},512),[[re,e.importStatus=="RUNNING"]]),o(P),o(b,{size:"small",onClick:s[2]||(s[2]=i=>t.showHint=!t.showHint)},{default:d(()=>[o(U,null,{default:d(()=>[h("far fa-question-circle small")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1}),o(Fe,null,{default:d(()=>[o(N,{class:"card2"},{default:d(()=>[o(A,{class:"subtitle"},{default:d(()=>[h(u(e.$gettext("Calibration Results")),1)]),_:1}),ae(o(b,{loading:t.applying,disabled:t.applying,onClick:t.ApplyResults},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-upload ")]),_:1}),h(" "+u(e.$gettext("Apply Road links to project")),1)]),_:1},8,["loading","disabled","onClick"]),[[re,t.imgs.length>0]]),ae(o(b,{loading:t.exporting,disabled:t.exporting,onClick:t.download},{default:d(()=>[o(U,{size:"small",style:{"margin-right":"10px"}},{default:d(()=>[h(" fa-solid fa-download ")]),_:1}),h(" "+u(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","onClick"]),[[re,t.imgs.length>0]]),t.error?(m(),x(le,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:d(()=>[h(u(e.$gettext("Service ended with an execution error or have been aborted.             Please retry. If the problem persist, contact us."))+" ",1),(m(!0),_(T,null,O(Object.keys(t.errorMessage),i=>(m(),_("p",{key:i},[p("b",null,u(i)+": ",1),h(u(t.errorMessage[i]),1)]))),128))]),_:1})):V("",!0),(m(!0),_(T,null,O(t.imgs,(i,r)=>(m(),_("div",{key:r,class:"gallery"},[o(yt,{src:i,alt:"image",cover:""},null,8,["src"])]))),128))]),_:1})]),_:1})]),_:1})}const Ws=R(Js,[["render",Zs],["__scopeId","data-v-24521792"]]);const Ks={name:"Microservices",components:{OSMImporter:Jt,MatrixRoadCaster:Ws,GTFSWebImporter:zs,GTFSZipImporter:fs},setup(){const e=Se(),s=g("OSM importer"),a=g("Zip importer"),t=v(()=>e.running);return{tab:s,subtab:a,GTFSrunning:t}}};function $s(e,s,a,t,l,c){const i=k("OSMImporter"),r=k("GTFSZipImporter"),n=k("GTFSWebImporter"),f=k("MatrixRoadCaster");return m(),_("section",null,[o(Me,{modelValue:t.tab,"onUpdate:modelValue":s[0]||(s[0]=y=>t.tab=y),color:"primary","bg-color":"lightergrey","align-tabs":"center"},{default:d(()=>[o($,{value:"OSM importer"},{default:d(()=>[h(" OSM importer ")]),_:1}),o($,{value:"GTFS importer"},{default:d(()=>[h(" GTFS importer ")]),_:1}),o($,{value:"Matrix Road Caster"},{default:d(()=>[h(" Matrix Road Caster ")]),_:1})]),_:1},8,["modelValue"]),t.tab==="GTFS importer"?(m(),x(Me,{key:0,modelValue:t.subtab,"onUpdate:modelValue":s[1]||(s[1]=y=>t.subtab=y),class:"subtabs",color:"primary","bg-color":"lightergrey","align-tabs":"center"},{default:d(()=>[o($,{disabled:t.GTFSrunning,value:"Zip importer"},{default:d(()=>[h(" Zip importer ")]),_:1},8,["disabled"]),o($,{disabled:t.GTFSrunning,value:"Web importer"},{default:d(()=>[h(" Web importer ")]),_:1},8,["disabled"])]),_:1},8,["modelValue"])):V("",!0),o(_t,{class:"layout"},{default:d(()=>[t.tab==="OSM importer"?(m(),x(i,{key:0})):t.tab==="GTFS importer"&&t.subtab==="Zip importer"?(m(),x(r,{key:1})):t.tab==="GTFS importer"&&t.subtab==="Web importer"?(m(),x(n,{key:2})):t.tab==="Matrix Road Caster"?(m(),x(f,{key:3})):V("",!0)]),_:1})])}const Xs=R(Ks,[["render",$s],["__scopeId","data-v-e9edd2ef"]]);export{Xs as default};
