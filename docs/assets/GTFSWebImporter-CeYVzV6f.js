import{M as ee,b as W}from"./Microservices-a4M-uNvS.js";import{bN as Y,bO as S,bP as te,aC as C,aF as re,bQ as ae,bR as ne,bS as I,bT as q,_ as se,aX as oe,a6 as ie,u as le,r as w,e as T,o as ue,aB as ce,f as de,g as p,q as F,j as d,i as v,ab as _,x as m,y as f,L as O,aS as H,G as k,h as B,ap as fe,F as D,E,v as h,l as he,Z as ve,N as ye,aU as ge,Q as pe,a2 as me,a3 as be,a4 as K,a9 as we,bU as Pe,bV as Te}from"./index-Db1Zz-Gc.js";import{P as Fe}from"./index-DTh02Eps.js";function P(e,t,r){if(r===void 0&&(r={}),!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");var a=Y(e),i=S(t),n=i.type,o=t.bbox,s=i.coordinates;if(o&&Se(a,o)===!1)return!1;n==="Polygon"&&(s=[s]);for(var u=!1,l=0;l<s.length&&!u;l++)if(R(a,s[l][0],r.ignoreBoundary)){for(var c=!1,b=1;b<s[l].length&&!c;)R(a,s[l][b],!r.ignoreBoundary)&&(c=!0),b++;c||(u=!0)}return u}function R(e,t,r){var a=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var i=0,n=t.length-1;i<t.length;n=i++){var o=t[i][0],s=t[i][1],u=t[n][0],l=t[n][1],c=e[1]*(o-u)+s*(u-e[0])+l*(e[0]-o)===0&&(o-e[0])*(u-e[0])<=0&&(s-e[1])*(l-e[1])<=0;if(c)return!r;var b=s>e[1]!=l>e[1]&&e[0]<(u-o)*(e[1]-s)/(l-s)+o;b&&(a=!a)}return a}function Se(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}function x(e,t,r){r===void 0&&(r={});for(var a=Y(e),i=te(t),n=0;n<i.length-1;n++){var o=!1;if(r.ignoreEndVertices&&(n===0&&(o="start"),n===i.length-2&&(o="end"),n===0&&n+1===i.length-1&&(o="both")),xe(i[n],i[n+1],a,o,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function xe(e,t,r,a,i){var n=r[0],o=r[1],s=e[0],u=e[1],l=t[0],c=t[1],b=r[0]-s,L=r[1]-u,y=l-s,g=c-u,V=b*g-L*y;if(i!==null){if(Math.abs(V)>i)return!1}else if(V!==0)return!1;if(a){if(a==="start")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<=l:l<=n&&n<s:g>0?u<o&&o<=c:c<=o&&o<u;if(a==="end")return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<l:l<n&&n<=s:g>0?u<=o&&o<c:c<o&&o<=u;if(a==="both")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<l:l<n&&n<s:g>0?u<o&&o<c:c<o&&o<u}else return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<=l:l<=n&&n<=s:g>0?u<=o&&o<=c:c<=o&&o<=u;return!1}function X(e,t){var r=S(e),a=S(t),i=r.type,n=a.type,o=r.coordinates,s=a.coordinates;switch(i){case"Point":switch(n){case"Point":return A(o,s);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Ge(r,a);case"MultiPoint":return Le(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return x(a,r,{ignoreEndVertices:!0});case"LineString":return Ce(r,a);case"MultiPoint":return Ve(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return P(a,r,{ignoreBoundary:!0});case"LineString":return Ie(r,a);case"Polygon":return Me(r,a);case"MultiPoint":return ke(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+i+" geometry not supported")}}function Ge(e,t){var r,a=!1;for(r=0;r<e.coordinates.length;r++)if(A(e.coordinates[r],t.coordinates)){a=!0;break}return a}function Le(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){for(var i=a[r],n=!1,o=0,s=e.coordinates;o<s.length;o++){var u=s[o];if(A(i,u)){n=!0;break}}if(!n)return!1}return!0}function Ve(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var n=i[a];if(x(n,e,{ignoreEndVertices:!0})&&(r=!0),!x(n,e))return!1}return!!r}function ke(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(!P(i,e,{ignoreBoundary:!0}))return!1}return!0}function Ce(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var n=i[a];if(x({type:"Point",coordinates:n},e,{ignoreEndVertices:!0})&&(r=!0),!x({type:"Point",coordinates:n},e,{ignoreEndVertices:!1}))return!1}return r}function Ie(e,t){var r=!1,a=0,i=C(e),n=C(t);if(!Z(i,n))return!1;for(a;a<t.coordinates.length-1;a++){var o=_e(t.coordinates[a],t.coordinates[a+1]);if(P({type:"Point",coordinates:o},e,{ignoreBoundary:!0})){r=!0;break}}return r}function Me(e,t){if(e.type==="Feature"&&e.geometry===null||t.type==="Feature"&&t.geometry===null)return!1;var r=C(e),a=C(t);if(!Z(r,a))return!1;for(var i=S(t).coordinates,n=0,o=i;n<o.length;n++)for(var s=o[n],u=0,l=s;u<l.length;u++){var c=l[u];if(!P(c,e))return!1}return!0}function Z(e,t){return!(e[0]>t[0]||e[2]<t[2]||e[1]>t[1]||e[3]<t[3])}function A(e,t){return e[0]===t[0]&&e[1]===t[1]}function _e(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}function U(e,t){t===void 0&&(t={});var r=S(e);switch(!t.properties&&e.type==="Feature"&&(t.properties=e.properties),r.type){case"Polygon":return Oe(r,t);case"MultiPolygon":return Be(r,t);default:throw new Error("invalid poly")}}function Oe(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{};return z(a,i)}function Be(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{},n=[];return a.forEach(function(o){n.push(z(o,i))}),re(n)}function z(e,t){return e.length>1?ae(e,t):ne(e[0],t)}function De(e,t){var r=!0;return I(e,function(a){I(t,function(i){if(r===!1)return!1;r=Ee(a.geometry,i.geometry)})}),r}function Ee(e,t){switch(e.type){case"Point":switch(t.type){case"Point":return!Ne(e.coordinates,t.coordinates);case"LineString":return!Q(t,e);case"Polygon":return!P(e,t)}break;case"LineString":switch(t.type){case"Point":return!Q(e,t);case"LineString":return!Ue(e,t);case"Polygon":return!J(t,e)}break;case"Polygon":switch(t.type){case"Point":return!P(t,e);case"LineString":return!J(e,t);case"Polygon":return!qe(t,e)}}return!1}function Q(e,t){for(var r=0;r<e.coordinates.length-1;r++)if(Ae(e.coordinates[r],e.coordinates[r+1],t.coordinates))return!0;return!1}function Ue(e,t){var r=q(e,t);return r.features.length>0}function J(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(P(i,e))return!0}var n=q(t,U(e));return n.features.length>0}function qe(e,t){for(var r=0,a=e.coordinates[0];r<a.length;r++){var i=a[r];if(P(i,t))return!0}for(var n=0,o=t.coordinates[0];n<o.length;n++){var s=o[n];if(P(s,e))return!0}var u=q(U(e),U(t));return u.features.length>0}function Ae(e,t,r){var a=r[0]-e[0],i=r[1]-e[1],n=t[0]-e[0],o=t[1]-e[1],s=a*o-i*n;return s!==0?!1:Math.abs(n)>=Math.abs(o)?n>0?e[0]<=r[0]&&r[0]<=t[0]:t[0]<=r[0]&&r[0]<=e[0]:o>0?e[1]<=r[1]&&r[1]<=t[1]:t[1]<=r[1]&&r[1]<=e[1]}function Ne(e,t){return e[0]===t[0]&&e[1]===t[1]}function We(e,t){var r=!1;return I(e,function(a){I(t,function(i){if(r===!0)return!0;r=!De(a.geometry,i.geometry)})}),r}const He=e=>e,Ke={name:"GTFSWebImporter",components:{MapSelector:ee},setup(){const e=oe(),t=ie(),r=le(),a=w(!1),i=w(null),n=w({}),o=w([]),s=w([]),u=w(!1),l=w(!1),c=w(e.selectedGTFS),b=T(()=>t.linksIsEmpty),L=T(()=>e.UploadedGTFS),y=T(()=>e.callID),g=T(()=>e.running),V=T(()=>e.error),j=T(()=>e.errorMessage),$=T(()=>L.value.filter(M=>M.progress<100).length>0);ue(()=>{e.saveParams(N.value),e.saveSelectedGTFS(c.value)});const N=w([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]);return{showOverwriteDialog:a,poly:i,runGTFS:e,store:r,nodes:n,gtfsList:o,availableGTFS:s,selectedGTFS:c,checkall:u,showHint:l,parameters:N,rules:{required:M=>!!M||He("Required")},linksIsEmpty:b,UploadedGTFS:L,callID:y,running:g,error:V,errorMessage:j,isUploading:$}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,t)=>{try{e.bbox=W([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=t}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,t)=>e["location.country_code"]<t["location.country_code"]?-1:e["location.country_code"]>t["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const t=await e.arrayBuffer();return ce(t)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const r=this.poly.geometry;e=W([r[1],r[0],r[3],r[2]])}else e=Fe([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(r=>X(e,r.bbox)||We(e,r.bbox)),this.availableGTFS.forEach(r=>r.allInPolygon=X(e,r.bbox));const t=new Set(this.availableGTFS.map(r=>r.index));this.selectedGTFS=this.selectedGTFS.filter(r=>t.has(r))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const r={files:this.availableGTFS.filter(a=>this.selectedGTFS.includes(a.index)).map(a=>a["urls.latest"])};this.parameters.forEach(a=>{r[a.name]=a.value}),this.runGTFS.startExecution(r)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},G=e=>(Pe("data-v-9dd377c2"),e=e(),Te(),e),Re={class:"background"},Xe={class:"params-row"},Qe={class:"list"},Je={class:"list-row"},Ye={class:"list-item-small"},Ze=G(()=>h("span",{class:"list-item-small"},"All in polygon",-1)),ze=G(()=>h("span",{class:"list-item-small"},"Code",-1)),je=G(()=>h("span",{class:"list-item-medium"},"Name",-1)),$e=G(()=>h("span",{class:"list-item-large"},"City",-1)),et=G(()=>h("span",{class:"list-item-large"},"Agency",-1)),tt={class:"list-item-small"},rt={class:"list-item-small"},at={class:"list-item-small"},nt={class:"list-item-medium"},st={class:"list-item-large"},ot={class:"list-item-large"};function it(e,t,r,a,i,n){const o=de("MapSelector");return p(),F("div",Re,[d(O,{class:"card"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("GTFS importer")),1)]),_:1}),d(o,{onChange:n.getBBOX},null,8,["onChange"])]),_:1}),d(O,{class:"card2"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("Available GTFS")),1)]),_:1}),d(H,null,{default:v(()=>[m(f(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),d(k,{disabled:a.running,"prepend-icon":"fa-solid fa-sync",onClick:n.getAvaileGTFS},{default:v(()=>[m(f(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),d(k,{loading:a.running,disabled:a.running||a.selectedGTFS.length===0,color:a.running||a.selectedGTFS.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:n.importGTFS},{default:v(()=>[m(f(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","color","onClick"]),d(H,null,{default:v(()=>[a.error?(p(),B(fe,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:v(()=>[m(f(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(p(!0),F(D,null,E(Object.keys(a.errorMessage),s=>(p(),F("p",{key:s},[h("b",null,f(s)+": ",1),m(f(a.errorMessage[s]),1)]))),128))]),_:1})):he("",!0)]),_:1}),h("div",Xe,[(p(!0),F(D,null,E(a.parameters,(s,u)=>(p(),F("div",{key:u,class:"params"},[typeof s.items>"u"?(p(),B(ve,{key:0,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,step:"1",type:s.type,label:e.$gettext(s.text),suffix:s.units,variant:"underlined",hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(p(),B(ye,{key:1,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,variant:"underlined",type:s.type,items:s.items,label:e.$gettext(s.text),suffix:s.units,hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",Qe,[h("ul",Je,[h("span",Ye,[d(ge,{disabled:!0})]),Ze,ze,je,$e,et]),(p(!0),F(D,null,E(a.availableGTFS,(s,u)=>(p(),F("ul",{key:s.index,class:"list-row"},[h("span",tt,[d(pe,{modelValue:a.selectedGTFS,"onUpdate:modelValue":t[0]||(t[0]=l=>a.selectedGTFS=l),value:s.index,label:String(u)},null,8,["modelValue","value","label"])]),h("span",rt,f(s.allInPolygon),1),h("span",at,f(s["location.country_code"]),1),h("span",nt,f(s["location.subdivision_name"]),1),h("span",st,f(s["location.municipality"]),1),h("span",ot,f(s.provider),1)]))),128))])]),_:1}),d(we,{modelValue:a.showOverwriteDialog,"onUpdate:modelValue":t[2]||(t[2]=s=>a.showOverwriteDialog=s),persistent:"","max-width":"500",onKeydown:[K(n.applyOverwriteDialog,["enter"]),t[3]||(t[3]=K(s=>a.showOverwriteDialog=!1,["esc"]))]},{default:v(()=>[d(O,null,{default:v(()=>[d(_,{class:"text-h5"},{default:v(()=>[m(f(e.$gettext("Overwrite current PT network ?")),1)]),_:1}),d(me,null,{default:v(()=>[d(be),d(k,{color:"regular",onClick:t[1]||(t[1]=s=>a.showOverwriteDialog=!a.showOverwriteDialog)},{default:v(()=>[m(f(e.$gettext("No")),1)]),_:1}),d(k,{color:"primary",onClick:n.applyOverwriteDialog},{default:v(()=>[m(f(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const ft=se(Ke,[["render",it],["__scopeId","data-v-9dd377c2"]]);export{ft as default};
