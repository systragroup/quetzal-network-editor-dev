import{t as ge,r as d,v as X,bh as Ee,aS as C,b,x as O,f as k,g as f,j as q,G as Y,u as Me,a as Ce,a9 as Ne,c as m,o as ie,bi as Fe,w as H,d as z,k as De,l as _e,e as S,y as je,F as de,H as ve,L as fe,I as pe,z as ye,A as me,bj as $e,bk as Pe,ai as V,aT as ze,aU as Ve,q as qe}from"./index-BJ5li8yH.js";import{P as Ae}from"./index-CBK01YYf.js";const Be={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(N,{emit:K}){const h=N,F=K,{map:s}=ge(h),g=d(null),c=d(null),a=d({lnglat:null,point:null}),u=d({lnglat:null,point:null}),L=d(new Set);X(()=>{s.value.on("mousedown",D)}),Ee(()=>{s.value.off("mousedown",D)});function D(i){i.originalEvent.button===2&&(a.value.lnglat=i.lngLat,a.value.point=i.point,s.value.on("mousemove",A),s.value.on("mouseup",_),F("mousedown",{mapboxEvent:i}))}function A(i){u.value.lnglat=i.lngLat,u.value.point=i.point;const w=s.value.unproject([u.value.point.x,a.value.point.y]),E=s.value.unproject([a.value.point.x,u.value.point.y]);g.value=Ae([[[a.value.lnglat.lng,a.value.lnglat.lat],[w.lng,w.lat],[u.value.lnglat.lng,u.value.lnglat.lat],[E.lng,E.lat],[a.value.lnglat.lng,a.value.lnglat.lat]]]),s.value.getSource("selectPolygon").setData(g.value),c.value=[Object.values(a.value.point),Object.values(u.value.point)],F("mousemove",{mapboxEvent:i,polygon:g.value,bbox:c.value})}function _(i){s.value.getSource("selectPolygon").setData(C),s.value.getCanvas().style.cursor="pointer",s.value.off("mousemove",A),s.value.off("mouseup",_),B(),g.value&&F("mouseup",{mapboxEvent:i,polygon:g.value,selectedId:L.value}),c.value=null,g.value=null}function B(){if(c.value){const i=s.value.queryRenderedFeatures(c.value,{layers:["rlinks"]});L.value=new Set(i.map(w=>w.id))}else L.value=new Set}return(i,w)=>(b(),O(Y,null,[k(f(q),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:f(C)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":i.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),k(f(q),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":i.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},Oe={__name:"RoadLinks",props:["map","isEditorMode"],emits:["clickFeature","onHover","offHover","select"],setup(N,{emit:K}){const{$gettext:h}=Me(),F=N,s=K,g=Ce(),c=Ne(),{map:a}=ge(F),u=m(()=>c.editionMode);X(()=>{a.value.getLayer("links")&&(a.value.moveLayer("rlinks","links"),a.value.moveLayer("anchorrNodes","links"),a.value.moveLayer("rnodes","links")),A()}),ie(()=>{a.value.removeLayer("arrow-rlinks"),u.value&&c.cancelEdition()});async function L(){const e=B.value;e.features.forEach(o=>o.id=o.properties.index),a.value.getSource("rlinks").setData(e)}async function D(){const e=i.value;e.features.forEach(o=>o.id=o.properties.index),a.value.getSource("rnodes").setData(e)}function A(){L(),D()}const _=m(()=>g.roadsPopupContent),B=m(()=>c.visiblerLinks),i=m(()=>c.visiblerNodes);function w(){const e=a.value.queryRenderedFeatures({layers:["rlinks"]}),o=new Set(e.map(r=>r.id)),n=B.value.features.filter(r=>o.has(r.properties.index)),v=V.cloneDeep(C);return n.filter(r=>r.geometry.coordinates.length>2).forEach(r=>{const M=r.properties.index;r.geometry.coordinates.slice(1,-1).forEach((Se,Le)=>v.features.push(ze(Se,{index:Ve.generate(),linkIndex:M,coordinatedIndex:Le+1})))}),v}const E=m(()=>g.anchorMode);Fe(()=>{if(u.value&&E.value&&R.value>=I.value.anchor){const e=w();a.value.getSource("anchorrNodes").setData(e)}else a.value.getSource("anchorrNodes").setData(C)},{flush:"post"});const j=d(null),l=d(null),T=d(!1),R=d(10);async function U(){R.value=a.value.getZoom()}const x=m(()=>{const e=R.value-I.value.nodes;return 2/(1+Math.exp(-e+3))+1}),I=d({anchor:14,nodes:24});async function ee(){if(E.value&&R.value>=I.value.anchor){const e=w();a.value.getSource("anchorrNodes").setData(e)}}H(u,e=>{e?(a.value.on("dragend",ee),a.value.on("zoomend",U),U(),I.value.nodes=12):(g.setAnchorMode(!1),a.value.off("dragend",ee),a.value.off("zoomend",U),I.value.nodes=24,P(),s("select"))});const Z=d(!1),G=d(!1),p=d("");function W(e){var o;if(u.value&&((o=j.value)!=null&&o.isOpen()&&j.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!T.value&&_.value.length>0){const v=e.mapboxEvent.features[0];if(v.layer.id==="rlinks"){let r=_.value.map(M=>`${M}: <b>${v.properties[M]}</b>`);r=r.join("<br> "),j.value=new qe.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(r).addTo(e.map)}}a.value.getCanvas().style.cursor="pointer",l.value!==null&&a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const n=[...new Set(e.mapboxEvent.features.map(v=>v.id))];l.value={layerId:e.layerId,id:n},a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),Q.value||s("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function J(e){var o,n;u.value&&((o=j.value)!=null&&o.isOpen()&&j.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((n=l.value)==null?void 0:n.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(Z.value?G.value=!0:(a.value.getCanvas().style.cursor="",a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,s("offHover",e)))))}function ae(e){if(u.value&&l.value!==null&&(p.value=l.value.id,p.value!==null&&l.value.layerId==="rlinks")){const o=E.value?"anchorrNodes":"rnodes";c.addRoadNodeInline({selectedIndex:p.value,lngLat:e.mapboxEvent.lngLat,nodes:o})}}function oe(e,o){if(o.length===0)e=="rlinks"?L():D();else{const n=V.cloneDeep(o);n.forEach(r=>r.id=r.properties?r.properties.index:r.id),a.value.getSource(e).updateData({type:"FeatureCollection",features:n})}}const he=m(()=>c.updateLinks),ke=m(()=>c.updateNodes);H(he,e=>{oe("rlinks",e)},{flush:"sync"}),H(ke,e=>{oe("rnodes",e)},{flush:"sync"});const t=d({coordinates:[0,0],showed:!1,actions:[],feature:null});function le(e){["Delete rLink","Delete Selected"].includes(e.action)?(c.deleterLink({selectedIndex:e.feature}),s("clickFeature",{action:"Delete rLink"})):s("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),t.value.showed=!1,P()}function te(e){var n,v;const o=e.mapboxEvent.originalEvent.ctrlKey;if(u.value&&!o){const r=a.value.querySourceFeatures(l.value.layerId);p.value=r.filter(M=>l.value.id.includes(M.id)),p.value.length>0&&(((n=l.value)==null?void 0:n.layerId)==="rnodes"?s("clickFeature",{selectedFeature:p.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((v=l.value)==null?void 0:v.layerId)==="anchorrNodes"&&c.deleteAnchorrNode({selectedNode:p.value[0].properties}))}}const y=d(new Set([]));function $(e){y.value.forEach(o=>{a.value.setFeatureState({source:"rlinks",id:o},{select:e})})}function P(){$(!1),y.value=new Set([]),t.value.showed=!1}function ne(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&P()}X(()=>{a.value.on("mousedown",ne),a.value.on("click",P)}),ie(()=>{a.value.off("mousedown",ne),a.value.off("click",P)});const Q=m(()=>y.value.size>0);H(Q,e=>s("select",e));function be(e){var o;u.value&&((o=l.value)==null?void 0:o.layerId)==="rlinks"&&(t.value.showed||(t.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),t.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(y.value=new Set([...y.value,...l.value.id]),$(!0),t.value.feature=V.cloneDeep(y),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):($(!1),y.value=new Set([]),t.value.feature=V.cloneDeep(l.value.id),t.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function we(e){e.mapboxEvent.originalEvent.ctrlKey?y.value=new Set([...y.value,...e.selectedId]):($(!1),y.value=e.selectedId),$(!0),y.value.size>0?(t.value.showed=!0,t.value.coordinates=null,t.value.feature=V.cloneDeep(y),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):t.value.showed=!1}function se(e){if(u.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),a.value.getCanvas().style.cursor="grab",Z.value=!0;const o=a.value.querySourceFeatures(l.value.layerId);p.value=o.filter(n=>n.id===l.value.id[0])[0],T.value=!0,l.value.layerId==="rnodes"&&c.getConnectedLinks({selectedNode:p.value}),a.value.on("mousemove",ue),a.value.on("mouseup",re)}}function ue(e){G.value&&p.value&&(l.value.layerId==="anchorrNodes"?c.moverAnchor({selectedNode:p.value,lngLat:Object.values(e.lngLat)}):(s("clickFeature",{action:"Move rNode"}),c.moverNode({selectedNode:p.value,lngLat:Object.values(e.lngLat)})))}function re(){u.value&&(a.value.getCanvas().style.cursor="pointer",a.value.off("mousemove",ue),Z.value=!1,G.value=!1,T.value=!1,a.value.getCanvas().style.cursor="",a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,a.value.off("mouseup",re))}const ce=m(()=>g.cyclewayMode),xe=m(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.1*x.value,0],.1*x.value],o=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return ce.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],o]:["*",e,o]}),Ie=m(()=>ce.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,o)=>(b(),O("section",null,[u.value?(b(),z(Be,{key:0,map:f(a),onMouseup:we},null,8,["map"])):De("",!0),k(f(q),{"source-id":"rlinks",reactive:!1,source:{type:"geojson",dynamic:!0,data:f(C),buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",N.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*x.value,x.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:W,onMouseleave:J,onClick:ae,onContextmenu:be},null,8,["source","layer"]),k(f(_e),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:I.value.nodes,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":xe.value,"icon-rotate":Ie.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),k(f(q),{"source-id":"rnodes",reactive:!1,source:{type:"geojson",dynamic:!0,data:i.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{type:"circle",minzoom:I.value.nodes,paint:{"circle-color":["case",["boolean",N.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],6*x.value,3*x.value],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:W,onMouseleave:J,onMousedown:se,onContextmenu:te},null,8,["source","layer"]),k(f(q),{"source-id":"anchorrNodes",reactive:!1,source:{type:"geojson",data:f(C),dynamic:!1,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{type:"circle",minzoom:I.value.anchor,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],6*x.value,3*x.value],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:ae,onMouseover:W,onMouseleave:J,onMousedown:se,onContextmenu:te},null,8,["source","layer"]),t.value.coordinates!==null?(b(),z(f($e),{key:1,"close-button":!1,showed:t.value.showed,coordinates:t.value.coordinates,"close-on-click":!1,onClose:o[1]||(o[1]=n=>t.value.showed=!1)},{default:S(()=>[je("span",{onMouseleave:o[0]||(o[0]=()=>{Q.value||(t.value.showed=!1)})},[k(de,{density:"compact"},{default:S(()=>[(b(!0),O(Y,null,ve(t.value.actions,n=>(b(),z(fe,{key:n.id},{default:S(()=>[k(pe,{variant:"outlined",size:"small",onClick:v=>le({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:S(()=>[ye(me(f(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])):(b(),z(Pe,{key:2,modelValue:t.value.showed,"onUpdate:modelValue":o[2]||(o[2]=n=>t.value.showed=n),"close-button":!1,coordinates:t.value.coordinates,timeout:"-1",class:"snackbar"},{default:S(()=>[k(de,{density:"compact"},{default:S(()=>[(b(!0),O(Y,null,ve(t.value.actions,n=>(b(),z(fe,{key:n.id},{default:S(()=>[k(pe,{variant:"outlined",size:"small",onClick:v=>le({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:S(()=>[ye(me(f(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue","coordinates"]))]))}};export{Oe as default};
