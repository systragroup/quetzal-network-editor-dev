import{t as ce,r as d,p as J,ba as ke,aM as $,g as j,q as W,j as b,ah as y,c as P,F as ie,ae as we,u as xe,a7 as Ie,o as re,e as g,bb as Se,w as B,h as ue,l as Ee,d as Le,i as O,v as Me,D as Ne,E as Ce,J as De,G as Fe,x as _e,y as je,bc as $e,aa as _,aN as Pe,aO as qe,n as ze}from"./index-CRKZRABL.js";import{P as Re}from"./index-CpUb6NoZ.js";const Ae={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(S,{emit:V}){const h=S,E=V,{map:s}=ce(h),m=d(null),i=d(null),o=d({lnglat:null,point:null}),u=d({lnglat:null,point:null}),L=d(new Set);J(()=>{s.value.on("mousedown",q)}),ke(()=>{s.value.off("mousedown",q)});function q(c){c.originalEvent.button===2&&(o.value.lnglat=c.lngLat,o.value.point=c.point,s.value.on("mousemove",M),s.value.on("mouseup",N),E("mousedown",{mapboxEvent:c}))}function M(c){u.value.lnglat=c.lngLat,u.value.point=c.point;const k=s.value.unproject([u.value.point.x,o.value.point.y]),x=s.value.unproject([o.value.point.x,u.value.point.y]);m.value=Re([[[o.value.lnglat.lng,o.value.lnglat.lat],[k.lng,k.lat],[u.value.lnglat.lng,u.value.lnglat.lat],[x.lng,x.lat],[o.value.lnglat.lng,o.value.lnglat.lat]]]),s.value.getSource("selectPolygon").setData(m.value),i.value=[Object.values(o.value.point),Object.values(u.value.point)],E("mousemove",{mapboxEvent:c,polygon:m.value,bbox:i.value})}function N(c){s.value.getSource("selectPolygon").setData($),s.value.getCanvas().style.cursor="pointer",s.value.off("mousemove",M),s.value.off("mouseup",N),C(),m.value&&E("mouseup",{mapboxEvent:c,polygon:m.value,selectedId:L.value}),i.value=null,m.value=null}function C(){if(i.value){const c=s.value.queryRenderedFeatures(i.value,{layers:["rlinks"]});L.value=new Set(c.map(k=>k.id))}else L.value=new Set}return(c,k)=>(j(),W(ie,null,[b(y(P),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:y($)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":c.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),b(y(P),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":c.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},Ve={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover","select"],setup(S,{emit:V}){const{$gettext:h}=we(),E=S,s=V,m=xe(),i=Ie(),{map:o,isRoadMode:u}=ce(E);J(()=>{o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("anchorrNodes","links"),o.value.moveLayer("rnodes","links")),M()}),re(()=>{o.value.removeLayer("arrow-rlinks")});async function L(){const e=C.value;e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rlinks").setData(e)}async function q(){const e=c.value;e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rnodes").setData(e)}function M(){L(),q()}const N=g(()=>m.roadsPopupContent),C=g(()=>i.visiblerLinks),c=g(()=>i.visiblerNodes);function k(){const e=o.value.queryRenderedFeatures({layers:["rlinks"]}),a=new Set(e.map(r=>r.id)),t=C.value.features.filter(r=>a.has(r.properties.index)),p=_.cloneDeep($);return t.filter(r=>r.geometry.coordinates.length>2).forEach(r=>{const I=r.properties.index;r.geometry.coordinates.slice(1,-1).forEach((he,be)=>p.features.push(Pe(he,{index:qe.generate(),linkIndex:I,coordinatedIndex:be+1})))}),p}const x=g(()=>m.anchorMode);Se(()=>{if(u.value&&x.value&&z.value>=w.value.anchor){const e=k();o.value.getSource("anchorrNodes").setData(e)}else o.value.getSource("anchorrNodes").setData($)},{flush:"post"});const D=d(null),l=d(null),H=d(!1),z=d(10),R=g(()=>{const e=z.value-w.value.nodes;return 2/(1+Math.exp(-e+3))+1}),w=d({anchor:14,nodes:12});async function Q(){z.value=o.value.getZoom()}async function X(){if(x.value&&z.value>=w.value.anchor){const e=k();o.value.getSource("anchorrNodes").setData(e)}}B(u,e=>{e?(o.value.on("dragend",X),o.value.on("zoomend",Q),w.value.nodes=12):(m.setAnchorMode(!1),o.value.off("dragend",X),o.value.off("zoomend",Q),w.value.nodes=24)},{immediate:!0});const K=d(!1),Z=d(!1),v=d("");function G(e){var a;if(u.value&&((a=D.value)!=null&&a.isOpen()&&D.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!H.value&&N.value.length>0){const p=e.mapboxEvent.features[0];if(p.layer.id==="rlinks"){let r=N.value.map(I=>`${I}: <b>${p.properties[I]}</b>`);r=r.join("<br> "),D.value=new ze.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(r).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",l.value!==null&&o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const t=[...new Set(e.mapboxEvent.features.map(p=>p.id))];l.value={layerId:e.layerId,id:t},o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),U.value||s("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function T(e){var a,t;u.value&&((a=D.value)!=null&&a.isOpen()&&D.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((t=l.value)==null?void 0:t.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(K.value?Z.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,s("offHover",e)))))}function Y(e){if(u.value&&l.value!==null&&(v.value=l.value.id,v.value!==null&&l.value.layerId==="rlinks")){const a=x.value?"anchorrNodes":"rnodes";i.addRoadNodeInline({selectedIndex:v.value,lngLat:e.mapboxEvent.lngLat,nodes:a})}}function ee(e,a){if(a.length===0)M();else{const t=_.cloneDeep(a);t.forEach(r=>r.id=r.properties?r.properties.index:r.id),o.value.getSource(e).updateData({type:"FeatureCollection",features:t})}}const de=g(()=>i.updateLinks),ve=g(()=>i.updateNodes);B(de,e=>{ee("rlinks",e)},{flush:"sync"}),B(ve,e=>{ee("rnodes",e)},{flush:"sync"});const n=d({coordinates:[0,0],showed:!1,actions:[],feature:null});function fe(e){["Delete rLink","Delete Selected"].includes(e.action)?(i.deleterLink({selectedIndex:e.feature}),s("clickFeature",{action:"Delete rLink"})):s("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),n.value.showed=!1,A()}function oe(e){var t,p;const a=e.mapboxEvent.originalEvent.ctrlKey;if(u.value&&!a){const r=o.value.querySourceFeatures(l.value.layerId);v.value=r.filter(I=>l.value.id.includes(I.id)),v.value.length>0&&(((t=l.value)==null?void 0:t.layerId)==="rnodes"?s("clickFeature",{selectedFeature:v.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((p=l.value)==null?void 0:p.layerId)==="anchorrNodes"&&i.deleteAnchorrNode({selectedNode:v.value[0].properties}))}}const f=d(new Set([]));function F(e){f.value.forEach(a=>{o.value.setFeatureState({source:"rlinks",id:a},{select:e})})}function A(){F(!1),f.value=new Set([]),n.value.showed=!1}function ae(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&A()}J(()=>{o.value.on("mousedown",ae),o.value.on("click",A)}),re(()=>{o.value.off("mousedown",ae),o.value.off("click",A)});const U=g(()=>f.value.size>0);B(U,e=>s("select",e));function pe(e){var a;u.value&&((a=l.value)==null?void 0:a.layerId)==="rlinks"&&(n.value.showed||(n.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),n.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(f.value=new Set([...f.value,...l.value.id]),F(!0),n.value.feature=_.cloneDeep(f),n.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):(F(!1),f.value=new Set([]),n.value.feature=_.cloneDeep(l.value.id),n.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function ye(e){if(e.mapboxEvent.originalEvent.ctrlKey?f.value=new Set([...f.value,...e.selectedId]):(F(!1),f.value=e.selectedId),F(!0),f.value.size>0){n.value.showed=!0;const t=e.polygon.geometry.coordinates[0];n.value.coordinates=[(t[0][0]+t[2][0])/2,Math.max(t[0][1],t[2][1])],n.value.feature=_.cloneDeep(f),n.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]}else n.value.showed=!1}function le(e){if(u.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",K.value=!0;const a=o.value.querySourceFeatures(l.value.layerId);v.value=a.filter(t=>t.id===l.value.id[0])[0],H.value=!0,l.value.layerId==="rnodes"&&i.getConnectedLinks({selectedNode:v.value}),o.value.on("mousemove",te),o.value.on("mouseup",ne)}}function te(e){Z.value&&v.value&&(l.value.layerId==="anchorrNodes"?i.moverAnchor({selectedNode:v.value,lngLat:Object.values(e.lngLat)}):(s("clickFeature",{action:"Move rNode"}),i.moverNode({selectedNode:v.value,lngLat:Object.values(e.lngLat)})))}function ne(){u.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",te),K.value=!1,Z.value=!1,H.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,o.value.off("mouseup",ne))}const se=g(()=>m.cyclewayMode),me=g(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.1*R.value,0],.1*R.value],a=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return se.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],a]:["*",e,a]}),ge=g(()=>se.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,a)=>(j(),W("section",null,[y(u)?(j(),ue(Ae,{key:0,map:y(o),onMouseup:ye},null,8,["map"])):Ee("",!0),b(y(P),{"source-id":"rlinks",reactive:!1,source:{type:"geojson",dynamic:!0,data:C.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",S.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*R.value,R.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:G,onMouseleave:T,onClick:Y,onContextmenu:pe},null,8,["source","layer"]),b(y(Le),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:w.value.nodes,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":me.value,"icon-rotate":ge.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),b(y(P),{"source-id":"rnodes",reactive:!1,source:{type:"geojson",dynamic:!0,data:c.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{type:"circle",minzoom:w.value.nodes,paint:{"circle-color":["case",["boolean",S.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:G,onMouseleave:T,onMousedown:le,onContextmenu:oe},null,8,["source","layer"]),b(y(P),{"source-id":"anchorrNodes",reactive:!1,source:{type:"geojson",data:y($),dynamic:!1,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{type:"circle",minzoom:w.value.anchor,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:Y,onMouseover:G,onMouseleave:T,onMousedown:le,onContextmenu:oe},null,8,["source","layer"]),b(y($e),{"close-button":!1,showed:n.value.showed,coordinates:n.value.coordinates,"close-on-click":!1,onClose:a[1]||(a[1]=t=>n.value.showed=!1)},{default:O(()=>[Me("span",{onMouseleave:a[0]||(a[0]=()=>{U.value||(n.value.showed=!1)})},[b(Ne,{density:"compact"},{default:O(()=>[(j(!0),W(ie,null,Ce(n.value.actions,t=>(j(),ue(De,{key:t.id},{default:O(()=>[b(Fe,{variant:"outlined",size:"small",onClick:p=>fe({action:t.name,feature:n.value.feature,coordinates:n.value.coordinates})},{default:O(()=>[_e(je(y(h)(t.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])]))}};export{Ve as default};
