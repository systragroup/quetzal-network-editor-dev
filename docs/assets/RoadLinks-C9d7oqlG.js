import{M as E,a as ye,b as pe}from"./main-DNW6zwB5.js";import{P as ge}from"./index-oOKQT20B.js";import{a3 as se,r as c,o as Q,a7 as he,a4 as O,d as D,e as X,g,i as d,F as ie,u as be,a as ke,L as we,a9 as re,c as m,w as W,z as ue,A as Le,h as V,f as xe,n as Ie,B as Me,p as Ee,V as Se,s as Ne,t as Ce,l as J}from"./index-DsN3MW9U.js";import{a as _e}from"./mapbox-gl-CRk0kY7b.js";const Fe={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(x,{emit:q}){const h=x,S=q,{map:r}=se(h),p=c(null),u=c(null),o=c({lnglat:null,point:null}),s=c({lnglat:null,point:null}),I=c(new Set);Q(()=>{r.value.on("mousedown",z)}),he(()=>{r.value.off("mousedown",z)});function z(i){i.originalEvent.button===2&&(o.value.lnglat=i.lngLat,o.value.point=i.point,r.value.on("mousemove",M),r.value.on("mouseup",P),S("mousedown",{mapboxEvent:i}))}function M(i){s.value.lnglat=i.lngLat,s.value.point=i.point;const w=r.value.unproject([s.value.point.x,o.value.point.y]),$=r.value.unproject([o.value.point.x,s.value.point.y]);p.value=ge([[[o.value.lnglat.lng,o.value.lnglat.lat],[w.lng,w.lat],[s.value.lnglat.lng,s.value.lnglat.lat],[$.lng,$.lat],[o.value.lnglat.lng,o.value.lnglat.lat]]]),r.value.getSource("selectPolygon").setData(p.value),u.value=[Object.values(o.value.point),Object.values(s.value.point)],S("mousemove",{mapboxEvent:i,polygon:p.value,bbox:u.value})}function P(i){r.value.getSource("selectPolygon").setData(O),r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",M),r.value.off("mouseup",P),H(),p.value&&S("mouseup",{mapboxEvent:i,polygon:p.value,selectedId:I.value}),u.value=null,p.value=null}function H(){if(u.value){const i=r.value.queryRenderedFeatures(u.value,{layers:["rlinks"]});I.value=new Set(i.map(w=>w.id))}else I.value=new Set}return(i,w)=>(D(),X(ie,null,[g(d(E),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:d(O)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":i.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),g(d(E),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":i.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},je={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover","select"],setup(x,{emit:q}){const{$gettext:h}=be(),S=x,r=q,p=ke(),u=we(),{map:o,isRoadMode:s}=se(S);Q(()=>{o.value.on("dragend",b),o.value.on("zoomend",b),o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("staticrLinks","links"),o.value.moveLayer("anchorrNodes","links"),o.value.moveLayer("rnodes","links"))}),re(()=>{o.value.removeLayer("arrow-rlinks")});const I=m(()=>p.roadsPopupContent),z=m(()=>u.selectedrGroup),M=m(()=>u.visiblerLinks),P=m(()=>u.renderedrLinks),H=m(()=>u.renderedrNodes),i=m(()=>p.anchorMode),w=O,$=m(()=>i.value?u.anchorrNodes:O),N=c(null),a=c(null),G=c(!1),K=c(100),L=c(10),j=m(()=>L.value>y.value.rendered+1?2:L.value>y.value.rendered?1+(L.value-y.value.rendered):1),y=c({links:4,rendered:14});W(z,()=>{K.value=100,b()}),W(s,e=>{e?(o.value.on("dragend",b),o.value.on("zoomend",b),b()):(o.value.off("dragend",b),o.value.off("zoomend",b),u.setRenderedrLinks({method:"None"}),o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(M.value))});async function b(){if(L.value=o.value.getZoom(),L.value>y.value.rendered){const e=o.value.getBounds();u.getRenderedrLinks({bbox:[e._sw.lng,e._sw.lat,e._ne.lng,e._ne.lat]}),o.value.setLayoutProperty("staticrLinks","visibility","none")}else L.value>y.value.links&&K.value>y.value.rendered&&(await o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(M.value),u.setRenderedrLinks({method:"None"}),_());K.value=L.value}const Z=c(!1),T=c(!1),v=c("");function R(e){var l;if(s.value&&((l=N.value)!=null&&l.isOpen()&&N.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!G.value&&I.value.length>0){const k=e.mapboxEvent.features[0];if(k.layer.id!=="rnodes"){let F=I.value.map(A=>`${A}: <b>${k.properties[A]}</b>`);F=F.join("<br> "),N.value=new _e.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(F).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",a.value!==null&&o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const n=[...new Set(e.mapboxEvent.features.map(k=>k.id))];a.value={layerId:e.layerId,id:n},o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),U.value||r("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function B(e){var l,n;s.value&&((l=N.value)!=null&&l.isOpen()&&N.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((n=a.value)==null?void 0:n.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(Z.value?T.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r("offHover",e)))))}function Y(e){if(s.value&&a.value!==null&&(v.value=a.value.id,v.value!==null&&a.value.layerId==="rlinks")){const l=i.value?"anchorrNodes":"rnodes";u.addRoadNodeInline({selectedIndex:v.value,lngLat:e.mapboxEvent.lngLat,nodes:l})}}const t=c({coordinates:[0,0],showed:!1,actions:[],feature:null});function ce(e){["Delete rLink","Delete Selected"].includes(e.action)?(u.deleterLink({selectedIndex:e.feature}),r("clickFeature",{action:"Delete rLink"})):r("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),t.value.showed=!1,_()}function ee(e){var n,k;const l=e.mapboxEvent.originalEvent.ctrlKey;if(s.value&&!l){const F=o.value.querySourceFeatures(a.value.layerId);v.value=F.filter(A=>a.value.id.includes(A.id)),v.value.length>0&&(((n=a.value)==null?void 0:n.layerId)==="rnodes"?r("clickFeature",{selectedFeature:v.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((k=a.value)==null?void 0:k.layerId)==="anchorrNodes"&&u.deleteAnchorrNode({selectedNode:v.value[0].properties}))}}const f=c(new Set([]));function C(e){f.value.forEach(l=>{o.value.setFeatureState({source:"rlinks",id:l},{select:e})})}function _(){C(!1),f.value=new Set([]),t.value.showed=!1}function oe(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&_()}Q(()=>{o.value.on("mousedown",oe),o.value.on("click",_)}),re(()=>{o.value.off("mousedown",oe),o.value.off("click",_)});const U=m(()=>f.value.size>0);W(U,e=>r("select",e));function de(e){var l;s.value&&((l=a.value)==null?void 0:l.layerId)==="rlinks"&&(t.value.showed||(t.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),t.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(f.value=new Set([...f.value,...a.value.id]),C(!0),t.value.feature=J.cloneDeep(f),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):(C(!1),f.value=new Set([]),t.value.feature=J.cloneDeep(a.value.id),t.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function ve(e){if(e.mapboxEvent.originalEvent.ctrlKey?f.value=new Set([...f.value,...e.selectedId]):(C(!1),f.value=e.selectedId),C(!0),f.value.size>0){t.value.showed=!0;const n=e.polygon.geometry.coordinates[0];t.value.coordinates=[(n[0][0]+n[2][0])/2,Math.max(n[0][1],n[2][1])],t.value.feature=J.cloneDeep(f),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]}else t.value.showed=!1}function ae(e){if(s.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",Z.value=!0;const l=o.value.querySourceFeatures(a.value.layerId);v.value=l.filter(n=>n.id===a.value.id[0])[0],G.value=!0,a.value.layerId==="rnodes"&&u.getConnectedLinks({selectedNode:v.value}),o.value.on("mousemove",le),o.value.on("mouseup",te)}}function le(e){T.value&&v.value&&(r("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?u.moverAnchor({selectedNode:v.value,lngLat:Object.values(e.lngLat)}):u.moverNode({selectedNode:v.value,lngLat:Object.values(e.lngLat)}))}function te(){s.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",le),Z.value=!1,T.value=!1,G.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,o.value.off("mouseup",te))}const ne=m(()=>p.cyclewayMode),fe=m(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],l=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return ne.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],l]:["*",e,l]}),me=m(()=>ne.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,l)=>(D(),X("section",null,[d(s)?(D(),ue(Fe,{key:0,map:d(o),onMouseup:ve},null,8,["map"])):Le("",!0),g(d(E),{"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:M.value,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:y.value.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",x.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*j.value,j.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:R,onMouseleave:B},null,8,["source","layer"]),g(d(E),{"source-id":"rlinks",source:{type:"geojson",data:P.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:y.value.links,paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",x.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*j.value,j.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:R,onMouseleave:B,onClick:Y,onContextmenu:de},null,8,["source","layer"]),g(d(ye),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:y.value.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":fe.value,"icon-rotate":me.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),g(d(E),{"source-id":"rnodes",source:{type:"geojson",data:H.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:y.value.rendered,paint:{"circle-color":["case",["boolean",x.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:R,onMouseleave:B,onMousedown:ae,onContextmenu:ee},null,8,["source","layer"]),g(d(E),{"source-id":"anchorrNodes",source:{type:"geojson",data:d(s)?$.value:d(w),buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:y.value.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:Y,onMouseover:R,onMouseleave:B,onMousedown:ae,onContextmenu:ee},null,8,["source","layer"]),g(d(pe),{"close-button":!1,showed:t.value.showed,coordinates:t.value.coordinates,"close-on-click":!1,onClose:l[1]||(l[1]=n=>t.value.showed=!1)},{default:V(()=>[xe("span",{onMouseleave:l[0]||(l[0]=()=>{U.value||(t.value.showed=!1)})},[g(Ie,{density:"compact"},{default:V(()=>[(D(!0),X(ie,null,Me(t.value.actions,n=>(D(),ue(Ee,{key:n.id},{default:V(()=>[g(Se,{variant:"outlined",size:"small",onClick:k=>ce({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:V(()=>[Ne(Ce(d(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])]))}};export{je as default};
