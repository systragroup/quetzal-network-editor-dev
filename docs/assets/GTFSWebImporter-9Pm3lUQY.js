import{bI as ae,bJ as C,bK as ue,bL as E,bM as W,_ as fe,u as ce,aZ as de,aa as ve,a as ye,r as T,c as S,o as he,d as pe,aI as me,f as x,g as k,j as y,i as m,ah as $,B as V,C as p,k as g,Q as q,aV as Q,K as G,h as A,ax as be,I as N,J as U,A as h,p as ge,a2 as we,R as Pe,aY as xe,U as Ve,a8 as Ie,a9 as Le,Z as X,ad as Me,be as Te}from"./index-B5JWNUzE.js";import{b as _,a as H,M as ke}from"./Microservices-Bn2XZgtq.js";function M(t,e,r){if(r===void 0&&(r={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var a=ae(t),l=C(e),n=l.type,s=e.bbox,i=l.coordinates;if(s&&Ce(a,s)===!1)return!1;n==="Polygon"&&(i=[i]);for(var u=!1,d=0;d<i.length&&!u;d++)if(j(a,i[d][0],r.ignoreBoundary)){for(var v=!1,I=1;I<i[d].length&&!v;)j(a,i[d][I],!r.ignoreBoundary)&&(v=!0),I++;v||(u=!0)}return u}function j(t,e,r){var a=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var l=0,n=e.length-1;l<e.length;n=l++){var s=e[l][0],i=e[l][1],u=e[n][0],d=e[n][1],v=t[1]*(s-u)+i*(u-t[0])+d*(t[0]-s)===0&&(s-t[0])*(u-t[0])<=0&&(i-t[1])*(d-t[1])<=0;if(v)return!r;var I=i>t[1]!=d>t[1]&&t[0]<(u-s)*(t[1]-i)/(d-i)+s;I&&(a=!a)}return a}function Ce(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}function B(t,e,r){r===void 0&&(r={});for(var a=ae(t),l=ue(e),n=0;n<l.length-1;n++){var s=!1;if(r.ignoreEndVertices&&(n===0&&(s="start"),n===l.length-2&&(s="end"),n===0&&n+1===l.length-1&&(s="both")),Fe(l[n],l[n+1],a,s,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Fe(t,e,r,a,l){var n=r[0],s=r[1],i=t[0],u=t[1],d=e[0],v=e[1],I=r[0]-i,O=r[1]-u,b=d-i,w=v-u,F=I*w-O*b;if(l!==null){if(Math.abs(F)>l)return!1}else if(F!==0)return!1;if(a){if(a==="start")return Math.abs(b)>=Math.abs(w)?b>0?i<n&&n<=d:d<=n&&n<i:w>0?u<s&&s<=v:v<=s&&s<u;if(a==="end")return Math.abs(b)>=Math.abs(w)?b>0?i<=n&&n<d:d<n&&n<=i:w>0?u<=s&&s<v:v<s&&s<=u;if(a==="both")return Math.abs(b)>=Math.abs(w)?b>0?i<n&&n<d:d<n&&n<i:w>0?u<s&&s<v:v<s&&s<u}else return Math.abs(b)>=Math.abs(w)?b>0?i<=n&&n<=d:d<=n&&n<=i:w>0?u<=s&&s<=v:v<=s&&s<=u;return!1}function ee(t,e){var r=C(t),a=C(e),l=r.type,n=a.type,s=r.coordinates,i=a.coordinates;switch(l){case"Point":switch(n){case"Point":return J(s,i);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Se(r,a);case"MultiPoint":return Ge(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return B(a,r,{ignoreEndVertices:!0});case"LineString":return _e(r,a);case"MultiPoint":return Be(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return M(a,r,{ignoreBoundary:!0});case"LineString":return Oe(r,a);case"Polygon":return De(r,a);case"MultiPoint":return Ee(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+l+" geometry not supported")}}function Se(t,e){var r,a=!1;for(r=0;r<t.coordinates.length;r++)if(J(t.coordinates[r],e.coordinates)){a=!0;break}return a}function Ge(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){for(var l=a[r],n=!1,s=0,i=t.coordinates;s<i.length;s++){var u=i[s];if(J(l,u)){n=!0;break}}if(!n)return!1}return!0}function Be(t,e){for(var r=!1,a=0,l=e.coordinates;a<l.length;a++){var n=l[a];if(B(n,t,{ignoreEndVertices:!0})&&(r=!0),!B(n,t))return!1}return!!r}function Ee(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){var l=a[r];if(!M(l,t,{ignoreBoundary:!0}))return!1}return!0}function _e(t,e){for(var r=!1,a=0,l=e.coordinates;a<l.length;a++){var n=l[a];if(B({type:"Point",coordinates:n},t,{ignoreEndVertices:!0})&&(r=!0),!B({type:"Point",coordinates:n},t,{ignoreEndVertices:!1}))return!1}return r}function Oe(t,e){var r=!1,a=0,l=_(t),n=_(e);if(!ne(l,n))return!1;for(a;a<e.coordinates.length-1;a++){var s=$e(e.coordinates[a],e.coordinates[a+1]);if(M({type:"Point",coordinates:s},t,{ignoreBoundary:!0})){r=!0;break}}return r}function De(t,e){if(t.type==="Feature"&&t.geometry===null||e.type==="Feature"&&e.geometry===null)return!1;var r=_(t),a=_(e);if(!ne(r,a))return!1;for(var l=C(e).coordinates,n=0,s=l;n<s.length;n++)for(var i=s[n],u=0,d=i;u<d.length;u++){var v=d[u];if(!M(v,t))return!1}return!0}function ne(t,e){return!(t[0]>e[0]||t[2]<e[2]||t[1]>e[1]||t[3]<e[3])}function J(t,e){return t[0]===e[0]&&t[1]===e[1]}function $e(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function se(t,e,r){r===void 0&&(r={});var a={type:"Feature"};return(r.id===0||r.id)&&(a.id=r.id),r.bbox&&(a.bbox=r.bbox),a.properties=e||{},a.geometry=t,a}function qe(t,e,r){if(r===void 0&&(r={}),t.length<2)throw new Error("coordinates must be an array of two or more positions");var a={type:"LineString",coordinates:t};return se(a,e,r)}function Ae(t,e){e===void 0&&(e={});var r={type:"FeatureCollection"};return e.id&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.features=t,r}function Ne(t,e,r){r===void 0&&(r={});var a={type:"MultiLineString",coordinates:t};return se(a,e,r)}function K(t,e){e===void 0&&(e={});var r=C(t);switch(!e.properties&&t.type==="Feature"&&(e.properties=t.properties),r.type){case"Polygon":return Ue(r,e);case"MultiPolygon":return Ke(r,e);default:throw new Error("invalid poly")}}function Ue(t,e){e===void 0&&(e={});var r=C(t),a=r.coordinates,l=e.properties?e.properties:t.type==="Feature"?t.properties:{};return oe(a,l)}function Ke(t,e){e===void 0&&(e={});var r=C(t),a=r.coordinates,l=e.properties?e.properties:t.type==="Feature"?t.properties:{},n=[];return a.forEach(function(s){n.push(oe(s,l))}),Ae(n)}function oe(t,e){return t.length>1?Ne(t,e):qe(t[0],e)}function We(t,e){var r=!0;return E(t,function(a){E(e,function(l){if(r===!1)return!1;r=Je(a.geometry,l.geometry)})}),r}function Je(t,e){switch(t.type){case"Point":switch(e.type){case"Point":return!Ze(t.coordinates,e.coordinates);case"LineString":return!re(e,t);case"Polygon":return!M(t,e)}break;case"LineString":switch(e.type){case"Point":return!re(t,e);case"LineString":return!Re(t,e);case"Polygon":return!te(e,t)}break;case"Polygon":switch(e.type){case"Point":return!M(e,t);case"LineString":return!te(t,e);case"Polygon":return!ze(e,t)}}return!1}function re(t,e){for(var r=0;r<t.coordinates.length-1;r++)if(Ye(t.coordinates[r],t.coordinates[r+1],e.coordinates))return!0;return!1}function Re(t,e){var r=W(t,e);return r.features.length>0}function te(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){var l=a[r];if(M(l,t))return!0}var n=W(e,K(t));return n.features.length>0}function ze(t,e){for(var r=0,a=t.coordinates[0];r<a.length;r++){var l=a[r];if(M(l,e))return!0}for(var n=0,s=e.coordinates[0];n<s.length;n++){var i=s[n];if(M(i,t))return!0}var u=W(K(t),K(e));return u.features.length>0}function Ye(t,e,r){var a=r[0]-t[0],l=r[1]-t[1],n=e[0]-t[0],s=e[1]-t[1],i=a*s-l*n;return i!==0?!1:Math.abs(n)>=Math.abs(s)?n>0?t[0]<=r[0]&&r[0]<=e[0]:e[0]<=r[0]&&r[0]<=t[0]:s>0?t[1]<=r[1]&&r[1]<=e[1]:e[1]<=r[1]&&r[1]<=t[1]}function Ze(t,e){return t[0]===e[0]&&t[1]===e[1]}function Qe(t,e){var r=!1;return E(t,function(a){E(e,function(l){if(r===!0)return!0;r=!We(a.geometry,l.geometry)})}),r}const Xe={class:"background"},He={class:"params-row"},je={class:"list"},er={class:"list-row"},rr={class:"list-item-small"},tr={class:"list-item-small"},ar={class:"list-item-small"},nr={class:"list-item-small"},sr={class:"list-item-medium"},or={class:"list-item-medium"},lr={class:"list-item-large"},ir={__name:"GTFSWebImporter",setup(t){const{$gettext:e}=ce(),r=de(),a=ve(),l=ye(),n=T(!1),s=T(null),i=T([]),u=T([]),d=T(!1),v=T(r.selectedGTFS),I=S(()=>a.linksIsEmpty),O=S(()=>r.callID),b=S(()=>r.running),w=S(()=>r.error),F=S(()=>r.errorMessage);he(()=>{r.saveParams(D.value),r.saveSelectedGTFS(v.value)});const D=T([{name:"start_time",text:"start time",value:r.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:r.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:r.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),R={required:c=>!!c||e("Required")};pe(async()=>{i.value=await le(),i.value.forEach((c,f)=>{try{c.bbox=H([c["location.bounding_box.minimum_longitude"],c["location.bounding_box.minimum_latitude"],c["location.bounding_box.maximum_longitude"],c["location.bounding_box.maximum_latitude"]])}catch{c.bbox=null}c.index=f}),i.value=i.value.filter(c=>c.bbox),i.value=i.value.filter(c=>{var f;return((f=c["urls.latest"])==null?void 0:f.length)>0}),i.value.sort((c,f)=>c["location.country_code"]<f["location.country_code"]?-1:c["location.country_code"]>f["location.country_code"]?1:0)});async function le(){try{const c=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});c.ok||l.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const f=await c.arrayBuffer();return me(f)}catch(c){l.changeAlert(c)}}function ie(c){s.value?s.value=c:(s.value=c,z())}function z(){let c=null;if(s.value.style==="bbox"){const o=s.value.geometry;c=H([o[1],o[0],o[3],o[2]])}else c=Te([s.value.geometry]);u.value=i.value.filter(o=>ee(c,o.bbox)||Qe(c,o.bbox)),u.value.forEach(o=>o.allInPolygon=ee(c,o.bbox));const f=new Set(u.value.map(o=>o.index));v.value=v.value.filter(o=>f.has(o))}function Y(){if(I.value){r.setCallID();const o={files:u.value.filter(P=>v.value.includes(P.index)).map(P=>P["urls.latest"]),callID:O.value};D.value.forEach(P=>{o[P.name]=P.value}),r.startExecution(o)}else n.value=!0}function Z(){a.$reset(),n.value=!1,Y()}return(c,f)=>(x(),k("div",Xe,[y(q,{class:"card"},{default:m(()=>[y($,{class:"subtitle"},{default:m(()=>[V(p(g(e)("GTFS importer")),1)]),_:1}),y(ke,{onChange:ie})]),_:1}),y(q,{class:"card2"},{default:m(()=>[y($,{class:"subtitle"},{default:m(()=>[V(p(g(e)("Available GTFS")),1)]),_:1}),y(Q,null,{default:m(()=>[V(p(g(e)("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),y(G,{disabled:b.value,"prepend-icon":"fa-solid fa-sync",onClick:z},{default:m(()=>[V(p(g(e)("fetch available GTFS")),1)]),_:1},8,["disabled"]),y(G,{loading:b.value,disabled:b.value||v.value.length===0,color:b.value||v.value.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:Y},{default:m(()=>[V(p(g(e)("Download")),1)]),_:1},8,["loading","disabled","color"]),y(Q,null,{default:m(()=>[w.value?(x(),A(be,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:m(()=>[V(p(g(e)("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(x(!0),k(N,null,U(Object.keys(F.value),o=>(x(),k("p",{key:o},[h("b",null,p(o)+": ",1),V(p(F.value[o]),1)]))),128))]),_:1})):ge("",!0)]),_:1}),h("div",He,[(x(!0),k(N,null,U(D.value,(o,P)=>(x(),k("div",{key:P,class:"params"},[typeof o.items>"u"?(x(),A(we,{key:0,modelValue:o.value,"onUpdate:modelValue":L=>o.value=L,step:"1",type:o.type,label:g(e)(o.text),suffix:o.units,variant:"underlined",hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(L=>R[L]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(x(),A(Pe,{key:1,modelValue:o.value,"onUpdate:modelValue":L=>o.value=L,variant:"underlined",type:o.type,items:o.items,label:g(e)(o.text),suffix:o.units,hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(L=>R[L]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",je,[h("ul",er,[h("span",rr,[y(xe,{disabled:!0})]),f[4]||(f[4]=h("span",{class:"list-item-small"},"All in polygon",-1)),f[5]||(f[5]=h("span",{class:"list-item-small"},"Code",-1)),f[6]||(f[6]=h("span",{class:"list-item-medium"},"Name",-1)),f[7]||(f[7]=h("span",{class:"list-item-medium"},"City",-1)),f[8]||(f[8]=h("span",{class:"list-item-large"},"Agency",-1)),f[9]||(f[9]=h("span",{class:"list-item-small"},".zip",-1))]),(x(!0),k(N,null,U(u.value,(o,P)=>(x(),k("ul",{key:o.index,class:"list-row"},[h("span",tr,[y(Ve,{modelValue:v.value,"onUpdate:modelValue":f[0]||(f[0]=L=>v.value=L),value:o.index,label:String(P)},null,8,["modelValue","value","label"])]),h("span",ar,p(o.allInPolygon),1),h("span",nr,p(o["location.country_code"]),1),h("span",sr,p(o["location.subdivision_name"]),1),h("span",or,p(o["location.municipality"]),1),h("span",lr,p(o.provider),1),y(G,{variant:"text",icon:"fa-solid fa-download",size:"small",href:o["urls.latest"],style:{color:"white"}},null,8,["href"])]))),128))])]),_:1}),y(Me,{modelValue:n.value,"onUpdate:modelValue":f[2]||(f[2]=o=>n.value=o),persistent:"","max-width":"500",onKeydown:[X(Z,["enter"]),f[3]||(f[3]=X(o=>n.value=!1,["esc"]))]},{default:m(()=>[y(q,null,{default:m(()=>[y($,{class:"text-h5"},{default:m(()=>[V(p(g(e)("Overwrite current PT network ?")),1)]),_:1}),y(Ie,null,{default:m(()=>[y(Le),y(G,{color:"regular",onClick:f[1]||(f[1]=o=>n.value=!n.value)},{default:m(()=>[V(p(g(e)("No")),1)]),_:1}),y(G,{color:"primary",onClick:Z},{default:m(()=>[V(p(g(e)("Yes")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},cr=fe(ir,[["__scopeId","data-v-442394f3"]]);export{cr as default};
