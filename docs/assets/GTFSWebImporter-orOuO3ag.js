import{b as O}from"./index-OtUW8uTq.js";import{b4 as S,b5 as w,b6 as L,b7 as P,aP as J,_ as Q,aK as Y,a5 as Z,u as z,r as p,e as m,o as $,ay as ee,b8 as B,f as te,g as f,q as v,j as n,i as u,aa as F,y as i,x as y,L as T,aF as E,G as x,am as se,F as G,v as c,E as V,h as k,l as ae,Z as re,N as oe,aH as ne,Q as le,a2 as ie,a3 as ce,a4 as M,a8 as ue,b9 as de,ba as he}from"./index-KxYlB9va.js";import{M as fe}from"./Microservices-E053zgqI.js";function ye(e,t){var s=!0;return S(e,function(a){S(t,function(l){if(s===!1)return!1;s=pe(a.geometry,l.geometry)})}),s}function pe(e,t){switch(e.type){case"Point":switch(t.type){case"Point":return!be(e.coordinates,t.coordinates);case"LineString":return!A(t,e);case"Polygon":return!w(e,t)}break;case"LineString":switch(t.type){case"Point":return!A(e,t);case"LineString":return!ge(e,t);case"Polygon":return!N(t,e)}break;case"Polygon":switch(t.type){case"Point":return!w(t,e);case"LineString":return!N(e,t);case"Polygon":return!me(t,e)}}return!1}function A(e,t){for(var s=0;s<e.coordinates.length-1;s++)if(ve(e.coordinates[s],e.coordinates[s+1],t.coordinates))return!0;return!1}function ge(e,t){var s=L(e,t);return s.features.length>0}function N(e,t){for(var s=0,a=t.coordinates;s<a.length;s++){var l=a[s];if(w(l,e))return!0}var o=L(t,P(e));return o.features.length>0}function me(e,t){for(var s=0,a=e.coordinates[0];s<a.length;s++){var l=a[s];if(w(l,t))return!0}for(var o=0,h=t.coordinates[0];o<h.length;o++){var r=h[o];if(w(r,e))return!0}var g=L(P(e),P(t));return g.features.length>0}function ve(e,t,s){var a=s[0]-e[0],l=s[1]-e[1],o=t[0]-e[0],h=t[1]-e[1],r=a*h-l*o;return r!==0?!1:Math.abs(o)>=Math.abs(h)?o>0?e[0]<=s[0]&&s[0]<=t[0]:t[0]<=s[0]&&s[0]<=e[0]:h>0?e[1]<=s[1]&&s[1]<=t[1]:t[1]<=s[1]&&s[1]<=e[1]}function be(e,t){return e[0]===t[0]&&e[1]===t[1]}function we(e,t){var s=!1;return S(e,function(a){S(t,function(l){if(s===!0)return!0;s=!ye(a.geometry,l.geometry)})}),s}var _e=function(e,t){if(e===null)throw new Error("No coordinates passed");for(var s=0;s<e.length;s++)for(var a=e[s],l=0;l<a[a.length-1].length;l++){if(a.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(a[a.length-1][l]!==a[0][l])throw new Error("First and last Position are not equivalent.")}var o={type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:t};return o.properties||(o.properties={}),o};const xe=J(_e),U=e=>e,Se={name:"GTFSWebImporter",components:{MapSelector:fe},setup(){const e=Y(),t=Z(),s=z(),a=p(!1),l=p(null),o=p({}),h=p([]),r=p([]),g=p(!1),d=p(!1),C=p(e.selectedGTFS),q=m(()=>t.linksIsEmpty),I=m(()=>e.UploadedGTFS),H=m(()=>e.callID),R=m(()=>e.running),j=m(()=>e.error),K=m(()=>e.errorMessage),W=m(()=>I.value.filter(b=>b.progress<100).length>0);$(()=>{e.saveParams(D.value),e.saveSelectedGTFS(C.value)});const D=p([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"String",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"String",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),X=/^(0?[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return{showOverwriteDialog:a,poly:l,runGTFS:e,store:s,nodes:o,gtfsList:h,availableGTFS:r,selectedGTFS:C,checkall:g,showHint:d,parameters:D,rules:{required:b=>!!b||U("Required"),timeRule:b=>X.test(b)||U("invalid date time")},linksIsEmpty:q,UploadedGTFS:I,callID:H,running:R,error:j,errorMessage:K,isUploading:W}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,t)=>{try{e.bbox=O([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=t}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,t)=>e["location.country_code"]<t["location.country_code"]?-1:e["location.country_code"]>t["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const t=await e.arrayBuffer();return ee(t)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const s=this.poly.geometry;e=O([s[1],s[0],s[3],s[2]])}else e=xe([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(s=>B(e,s.bbox)||we(e,s.bbox)),this.availableGTFS.forEach(s=>s.allInPolygon=B(e,s.bbox));const t=new Set(this.availableGTFS.map(s=>s.index));this.selectedGTFS=this.selectedGTFS.filter(s=>t.has(s))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const s={files:this.availableGTFS.filter(a=>this.selectedGTFS.includes(a.index)).map(a=>a["urls.latest"])};this.parameters.forEach(a=>{s[a.name]=a.value}),this.runGTFS.startExecution(s)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},_=e=>(de("data-v-b6c76dd2"),e=e(),he(),e),Fe={class:"background"},Te={class:"params-row"},Ge={class:"list"},Ve={class:"list-row"},ke={class:"list-item-small"},Pe=_(()=>c("span",{class:"list-item-small"},"All in polygon",-1)),Le=_(()=>c("span",{class:"list-item-small"},"Code",-1)),Ce=_(()=>c("span",{class:"list-item-medium"},"Name",-1)),Ie=_(()=>c("span",{class:"list-item-large"},"City",-1)),De=_(()=>c("span",{class:"list-item-large"},"Agency",-1)),Oe={class:"list-item-small"},Be={class:"list-item-small"},Ee={class:"list-item-small"},Me={class:"list-item-medium"},Ae={class:"list-item-large"},Ne={class:"list-item-large"};function Ue(e,t,s,a,l,o){const h=te("MapSelector");return f(),v("div",Fe,[n(T,{class:"card"},{default:u(()=>[n(F,{class:"subtitle"},{default:u(()=>[y(i(e.$gettext("GTFS importer")),1)]),_:1}),n(h,{onChange:o.getBBOX},null,8,["onChange"])]),_:1}),n(T,{class:"card2"},{default:u(()=>[n(F,{class:"subtitle"},{default:u(()=>[y(i(e.$gettext("Available GTFS")),1)]),_:1}),n(E,null,{default:u(()=>[y(i(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),n(x,{disabled:a.running,"prepend-icon":"fa-solid fa-sync",onClick:o.getAvaileGTFS},{default:u(()=>[y(i(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),n(x,{loading:a.running,disabled:a.running||a.selectedGTFS.length===0,color:a.running||a.selectedGTFS.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:o.importGTFS},{default:u(()=>[y(i(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","color","onClick"]),n(E,null,{default:u(()=>[a.error?(f(),k(se,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:u(()=>[y(i(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(f(!0),v(G,null,V(Object.keys(a.errorMessage),r=>(f(),v("p",{key:r},[c("b",null,i(r)+": ",1),y(i(a.errorMessage[r]),1)]))),128))]),_:1})):ae("",!0)]),_:1}),c("div",Te,[(f(!0),v(G,null,V(a.parameters,(r,g)=>(f(),v("div",{key:g,class:"params"},[typeof r.items>"u"?(f(),k(re,{key:0,modelValue:r.value,"onUpdate:modelValue":d=>r.value=d,type:r.type,label:e.$gettext(r.text),suffix:r.units,variant:"underlined",hint:a.showHint?e.$gettext(r.hint):"","persistent-hint":a.showHint,rules:r.rules.map(d=>a.rules[d]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(f(),k(oe,{key:1,modelValue:r.value,"onUpdate:modelValue":d=>r.value=d,variant:"underlined",type:r.type,items:r.items,label:e.$gettext(r.text),suffix:r.units,hint:a.showHint?e.$gettext(r.hint):"","persistent-hint":a.showHint,rules:r.rules.map(d=>a.rules[d]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),c("div",Ge,[c("ul",Ve,[c("span",ke,[n(ne,{disabled:!0})]),Pe,Le,Ce,Ie,De]),(f(!0),v(G,null,V(a.availableGTFS,(r,g)=>(f(),v("ul",{key:r.index,class:"list-row"},[c("span",Oe,[n(le,{modelValue:a.selectedGTFS,"onUpdate:modelValue":t[0]||(t[0]=d=>a.selectedGTFS=d),value:r.index,label:String(g)},null,8,["modelValue","value","label"])]),c("span",Be,i(r.allInPolygon),1),c("span",Ee,i(r["location.country_code"]),1),c("span",Me,i(r["location.subdivision_name"]),1),c("span",Ae,i(r["location.municipality"]),1),c("span",Ne,i(r.provider),1)]))),128))])]),_:1}),n(ue,{modelValue:a.showOverwriteDialog,"onUpdate:modelValue":t[2]||(t[2]=r=>a.showOverwriteDialog=r),persistent:"","max-width":"500",onKeydown:[M(o.applyOverwriteDialog,["enter"]),t[3]||(t[3]=M(r=>a.showOverwriteDialog=!1,["esc"]))]},{default:u(()=>[n(T,null,{default:u(()=>[n(F,{class:"text-h5"},{default:u(()=>[y(i(e.$gettext("Overwrite current road network ?")),1)]),_:1}),n(ie,null,{default:u(()=>[n(ce),n(x,{color:"regular",onClick:t[1]||(t[1]=r=>a.showOverwriteDialog=!a.showOverwriteDialog)},{default:u(()=>[y(i(e.$gettext("No")),1)]),_:1}),n(x,{color:"primary",onClick:o.applyOverwriteDialog},{default:u(()=>[y(i(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const Ke=Q(Se,[["render",Ue],["__scopeId","data-v-b6c76dd2"]]);export{Ke as default};
