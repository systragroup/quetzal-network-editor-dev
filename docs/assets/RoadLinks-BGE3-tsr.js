import{t as ge,r as d,v as Q,bh as Ee,aS as z,b,x as O,f as k,g as f,j as V,G as X,u as Me,a as Ce,a9 as Ne,o as ie,c as g,bi as Fe,w as H,d as $,k as De,l as _e,e as I,y as je,F as de,H as ve,L as fe,I as pe,z as me,A as ye,bj as $e,bk as Pe,ai as P,aT as ze,aU as Ve,q as qe}from"./index-DlhVgENj.js";import{P as Ae}from"./index-D-xfX5HJ.js";const Re={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(E,{emit:K}){const h=E,M=K,{map:s}=ge(h),y=d(null),i=d(null),a=d({lnglat:null,point:null}),r=d({lnglat:null,point:null}),C=d(new Set);Q(()=>{s.value.on("mousedown",q)}),Ee(()=>{s.value.off("mousedown",q)});function q(c){c.originalEvent.button===2&&(a.value.lnglat=c.lngLat,a.value.point=c.point,s.value.on("mousemove",N),s.value.on("mouseup",F),M("mousedown",{mapboxEvent:c}))}function N(c){r.value.lnglat=c.lngLat,r.value.point=c.point;const w=s.value.unproject([r.value.point.x,a.value.point.y]),S=s.value.unproject([a.value.point.x,r.value.point.y]);y.value=Ae([[[a.value.lnglat.lng,a.value.lnglat.lat],[w.lng,w.lat],[r.value.lnglat.lng,r.value.lnglat.lat],[S.lng,S.lat],[a.value.lnglat.lng,a.value.lnglat.lat]]]),s.value.getSource("selectPolygon").setData(y.value),i.value=[Object.values(a.value.point),Object.values(r.value.point)],M("mousemove",{mapboxEvent:c,polygon:y.value,bbox:i.value})}function F(c){s.value.getSource("selectPolygon").setData(z),s.value.getCanvas().style.cursor="pointer",s.value.off("mousemove",N),s.value.off("mouseup",F),D(),y.value&&M("mouseup",{mapboxEvent:c,polygon:y.value,selectedId:C.value}),i.value=null,y.value=null}function D(){if(i.value){const c=s.value.queryRenderedFeatures(i.value,{layers:["rlinks"]});C.value=new Set(c.map(w=>w.id))}else C.value=new Set}return(c,w)=>(b(),O(X,null,[k(f(V),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:f(z)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":c.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),k(f(V),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":c.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},Oe={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover","select"],setup(E,{emit:K}){const{$gettext:h}=Me(),M=E,s=K,y=Ce(),i=Ne(),{map:a,isRoadMode:r}=ge(M);Q(()=>{a.value.getLayer("links")&&(a.value.moveLayer("rlinks","links"),a.value.moveLayer("anchorrNodes","links"),a.value.moveLayer("rnodes","links")),N()}),ie(()=>{a.value.removeLayer("arrow-rlinks")});async function C(){const e=D.value;e.features.forEach(o=>o.id=o.properties.index),a.value.getSource("rlinks").setData(e)}async function q(){const e=c.value;e.features.forEach(o=>o.id=o.properties.index),a.value.getSource("rnodes").setData(e)}function N(){C(),q()}const F=g(()=>y.roadsPopupContent),D=g(()=>i.visiblerLinks),c=g(()=>i.visiblerNodes);function w(){const e=a.value.queryRenderedFeatures({layers:["rlinks"]}),o=new Set(e.map(u=>u.id)),n=D.value.features.filter(u=>o.has(u.properties.index)),v=P.cloneDeep(z);return n.filter(u=>u.geometry.coordinates.length>2).forEach(u=>{const L=u.properties.index;u.geometry.coordinates.slice(1,-1).forEach((Se,Le)=>v.features.push(ze(Se,{index:Ve.generate(),linkIndex:L,coordinatedIndex:Le+1})))}),v}const S=g(()=>y.anchorMode);Fe(()=>{if(r.value&&S.value&&A.value>=x.value.anchor){const e=w();a.value.getSource("anchorrNodes").setData(e)}else a.value.getSource("anchorrNodes").setData(z)},{flush:"post"});const _=d(null),l=d(null),T=d(!1),A=d(10),R=g(()=>{const e=A.value-x.value.nodes;return 2/(1+Math.exp(-e+3))+1}),x=d({anchor:14,nodes:12});async function Y(){A.value=a.value.getZoom()}async function ee(){if(S.value&&A.value>=x.value.anchor){const e=w();a.value.getSource("anchorrNodes").setData(e)}}H(r,e=>{e?(a.value.on("dragend",ee),a.value.on("zoomend",Y),x.value.nodes=12):(y.setAnchorMode(!1),a.value.off("dragend",ee),a.value.off("zoomend",Y),x.value.nodes=24)},{immediate:!0});const U=d(!1),Z=d(!1),p=d("");function G(e){var o;if(r.value&&((o=_.value)!=null&&o.isOpen()&&_.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!T.value&&F.value.length>0){const v=e.mapboxEvent.features[0];if(v.layer.id==="rlinks"){let u=F.value.map(L=>`${L}: <b>${v.properties[L]}</b>`);u=u.join("<br> "),_.value=new qe.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(u).addTo(e.map)}}a.value.getCanvas().style.cursor="pointer",l.value!==null&&a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const n=[...new Set(e.mapboxEvent.features.map(v=>v.id))];l.value={layerId:e.layerId,id:n},a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),J.value||s("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function W(e){var o,n;r.value&&((o=_.value)!=null&&o.isOpen()&&_.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((n=l.value)==null?void 0:n.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(U.value?Z.value=!0:(a.value.getCanvas().style.cursor="",a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,s("offHover",e)))))}function ae(e){if(r.value&&l.value!==null&&(p.value=l.value.id,p.value!==null&&l.value.layerId==="rlinks")){const o=S.value?"anchorrNodes":"rnodes";i.addRoadNodeInline({selectedIndex:p.value,lngLat:e.mapboxEvent.lngLat,nodes:o})}}function oe(e,o){if(o.length===0)N();else{const n=P.cloneDeep(o);n.forEach(u=>u.id=u.properties?u.properties.index:u.id),a.value.getSource(e).updateData({type:"FeatureCollection",features:n})}}const he=g(()=>i.updateLinks),ke=g(()=>i.updateNodes);H(he,e=>{oe("rlinks",e)},{flush:"sync"}),H(ke,e=>{oe("rnodes",e)},{flush:"sync"});const t=d({coordinates:[0,0],showed:!1,actions:[],feature:null});function le(e){["Delete rLink","Delete Selected"].includes(e.action)?(i.deleterLink({selectedIndex:e.feature}),s("clickFeature",{action:"Delete rLink"})):s("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),t.value.showed=!1,B()}function te(e){var n,v;const o=e.mapboxEvent.originalEvent.ctrlKey;if(r.value&&!o){const u=a.value.querySourceFeatures(l.value.layerId);p.value=u.filter(L=>l.value.id.includes(L.id)),p.value.length>0&&(((n=l.value)==null?void 0:n.layerId)==="rnodes"?s("clickFeature",{selectedFeature:p.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((v=l.value)==null?void 0:v.layerId)==="anchorrNodes"&&i.deleteAnchorrNode({selectedNode:p.value[0].properties}))}}const m=d(new Set([]));function j(e){m.value.forEach(o=>{a.value.setFeatureState({source:"rlinks",id:o},{select:e})})}function B(){j(!1),m.value=new Set([]),t.value.showed=!1}function ne(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&B()}Q(()=>{a.value.on("mousedown",ne),a.value.on("click",B)}),ie(()=>{a.value.off("mousedown",ne),a.value.off("click",B)});const J=g(()=>m.value.size>0);H(J,e=>s("select",e));function be(e){var o;r.value&&((o=l.value)==null?void 0:o.layerId)==="rlinks"&&(t.value.showed||(t.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),t.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(m.value=new Set([...m.value,...l.value.id]),j(!0),t.value.feature=P.cloneDeep(m),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):(j(!1),m.value=new Set([]),t.value.feature=P.cloneDeep(l.value.id),t.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function we(e){e.mapboxEvent.originalEvent.ctrlKey?m.value=new Set([...m.value,...e.selectedId]):(j(!1),m.value=e.selectedId),j(!0),m.value.size>0?(t.value.showed=!0,t.value.coordinates=null,t.value.feature=P.cloneDeep(m),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):t.value.showed=!1}function se(e){if(r.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),a.value.getCanvas().style.cursor="grab",U.value=!0;const o=a.value.querySourceFeatures(l.value.layerId);p.value=o.filter(n=>n.id===l.value.id[0])[0],T.value=!0,l.value.layerId==="rnodes"&&i.getConnectedLinks({selectedNode:p.value}),a.value.on("mousemove",ue),a.value.on("mouseup",re)}}function ue(e){Z.value&&p.value&&(l.value.layerId==="anchorrNodes"?i.moverAnchor({selectedNode:p.value,lngLat:Object.values(e.lngLat)}):(s("clickFeature",{action:"Move rNode"}),i.moverNode({selectedNode:p.value,lngLat:Object.values(e.lngLat)})))}function re(){r.value&&(a.value.getCanvas().style.cursor="pointer",a.value.off("mousemove",ue),U.value=!1,Z.value=!1,T.value=!1,a.value.getCanvas().style.cursor="",a.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,a.value.off("mouseup",re))}const ce=g(()=>y.cyclewayMode),xe=g(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.1*R.value,0],.1*R.value],o=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return ce.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],o]:["*",e,o]}),Ie=g(()=>ce.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,o)=>(b(),O("section",null,[f(r)?(b(),$(Re,{key:0,map:f(a),onMouseup:we},null,8,["map"])):De("",!0),k(f(V),{"source-id":"rlinks",reactive:!1,source:{type:"geojson",dynamic:!0,data:D.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",E.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*R.value,R.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:G,onMouseleave:W,onClick:ae,onContextmenu:be},null,8,["source","layer"]),k(f(_e),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:x.value.nodes,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":xe.value,"icon-rotate":Ie.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),k(f(V),{"source-id":"rnodes",reactive:!1,source:{type:"geojson",dynamic:!0,data:c.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{type:"circle",minzoom:x.value.nodes,paint:{"circle-color":["case",["boolean",E.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:G,onMouseleave:W,onMousedown:se,onContextmenu:te},null,8,["source","layer"]),k(f(V),{"source-id":"anchorrNodes",reactive:!1,source:{type:"geojson",data:f(z),dynamic:!1,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{type:"circle",minzoom:x.value.anchor,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:ae,onMouseover:G,onMouseleave:W,onMousedown:se,onContextmenu:te},null,8,["source","layer"]),t.value.coordinates!==null?(b(),$(f($e),{key:1,"close-button":!1,showed:t.value.showed,coordinates:t.value.coordinates,"close-on-click":!1,onClose:o[1]||(o[1]=n=>t.value.showed=!1)},{default:I(()=>[je("span",{onMouseleave:o[0]||(o[0]=()=>{J.value||(t.value.showed=!1)})},[k(de,{density:"compact"},{default:I(()=>[(b(!0),O(X,null,ve(t.value.actions,n=>(b(),$(fe,{key:n.id},{default:I(()=>[k(pe,{variant:"outlined",size:"small",onClick:v=>le({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:I(()=>[me(ye(f(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])):(b(),$(Pe,{key:2,modelValue:t.value.showed,"onUpdate:modelValue":o[2]||(o[2]=n=>t.value.showed=n),"close-button":!1,coordinates:t.value.coordinates,timeout:"-1",class:"snackbar"},{default:I(()=>[k(de,{density:"compact"},{default:I(()=>[(b(!0),O(X,null,ve(t.value.actions,n=>(b(),$(fe,{key:n.id},{default:I(()=>[k(pe,{variant:"outlined",size:"small",onClick:v=>le({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:I(()=>[me(ye(f(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue","coordinates"]))]))}};export{Oe as default};
