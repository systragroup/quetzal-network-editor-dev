import{M as E,a as ye,b as pe}from"./main-CpSi--NZ.js";import{P as ge}from"./index-C8slN-lX.js";import{ab as se,r as c,o as Q,af as he,ac as A,j as D,k as X,q as g,z as d,L as ie,i as be,u as ke,f as we,ag as re,e as m,w as J,J as ue,K as Le,v as q,m as xe,C as Ie,M as Me,D as Ee,V as Se,F as Ce,y as Ne,l as W}from"./index-DWA-_zBJ.js";import{a as _e}from"./mapbox-gl-DW8YZ00t.js";const Fe={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(x,{emit:O}){const h=x,S=O,{map:r}=se(h),p=c(null),u=c(null),o=c({lnglat:null,point:null}),s=c({lnglat:null,point:null}),I=c(new Set);Q(()=>{r.value.on("mousedown",j)}),he(()=>{r.value.off("mousedown",j)});function j(i){i.originalEvent.button===2&&(o.value.lnglat=i.lngLat,o.value.point=i.point,r.value.on("mousemove",M),r.value.on("mouseup",z),S("mousedown",{mapboxEvent:i}))}function M(i){s.value.lnglat=i.lngLat,s.value.point=i.point;const w=r.value.unproject([s.value.point.x,o.value.point.y]),P=r.value.unproject([o.value.point.x,s.value.point.y]);p.value=ge([[[o.value.lnglat.lng,o.value.lnglat.lat],[w.lng,w.lat],[s.value.lnglat.lng,s.value.lnglat.lat],[P.lng,P.lat],[o.value.lnglat.lng,o.value.lnglat.lat]]]),r.value.getSource("selectPolygon").setData(p.value),u.value=[Object.values(o.value.point),Object.values(s.value.point)],S("mousemove",{mapboxEvent:i,polygon:p.value,bbox:u.value})}function z(i){r.value.getSource("selectPolygon").setData(A),r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",M),r.value.off("mouseup",z),H(),p.value&&S("mouseup",{mapboxEvent:i,polygon:p.value,selectedId:I.value}),u.value=null,p.value=null}function H(){if(u.value){const i=r.value.queryRenderedFeatures(u.value,{layers:["rlinks"]});I.value=new Set(i.map(w=>w.id))}else I.value=new Set}return(i,w)=>(D(),X(ie,null,[g(d(E),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:d(A)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":i.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),g(d(E),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":i.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},$e={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover","select"],setup(x,{emit:O}){const{$gettext:h}=be(),S=x,r=O,p=ke(),u=we(),{map:o,isRoadMode:s}=se(S);Q(()=>{o.value.on("dragend",b),o.value.on("zoomend",b),o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("staticrLinks","links"),o.value.moveLayer("anchorrNodes","links"),o.value.moveLayer("rnodes","links"))}),re(()=>{o.value.removeLayer("arrow-rlinks")});const I=m(()=>p.roadsPopupContent),j=m(()=>u.selectedrGroup),M=m(()=>u.visiblerLinks),z=m(()=>u.renderedrLinks),H=m(()=>u.renderedrNodes),i=m(()=>p.anchorMode),w=A,P=m(()=>i.value?u.anchorrNodes:A),C=c(null),l=c(null),K=c(!1),G=c(100),L=c(10),$=m(()=>L.value>y.value.rendered+1?2:L.value>y.value.rendered?1+(L.value-y.value.rendered):1),y=c({links:4,rendered:14});J(j,()=>{G.value=100,b()}),J(s,e=>{e?(o.value.on("dragend",b),o.value.on("zoomend",b),b()):(o.value.off("dragend",b),o.value.off("zoomend",b),u.setRenderedrLinks({method:"None"}),o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(M.value))});async function b(){if(L.value=o.value.getZoom(),L.value>y.value.rendered){const e=o.value.getBounds();u.getRenderedrLinks({bbox:[e._sw.lng,e._sw.lat,e._ne.lng,e._ne.lat]}),o.value.setLayoutProperty("staticrLinks","visibility","none")}else L.value>y.value.links&&G.value>y.value.rendered&&(await o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(M.value),u.setRenderedrLinks({method:"None"}),_());G.value=L.value}const Z=c(!1),T=c(!1),v=c("");function R(e){var a;if(s.value&&((a=C.value)!=null&&a.isOpen()&&C.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!K.value&&I.value.length>0){const k=e.mapboxEvent.features[0];if(k.layer.id!=="rnodes"){let F=I.value.map(V=>`${V}: <b>${k.properties[V]}</b>`);F=F.join("<br> "),C.value=new _e.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(F).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",l.value!==null&&o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const n=[...new Set(e.mapboxEvent.features.map(k=>k.id))];l.value={layerId:e.layerId,id:n},o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),U.value||r("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function B(e){var a,n;s.value&&((a=C.value)!=null&&a.isOpen()&&C.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((n=l.value)==null?void 0:n.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(Z.value?T.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,r("offHover",e)))))}function Y(e){if(s.value&&l.value!==null&&(v.value=l.value.id,v.value!==null&&l.value.layerId==="rlinks")){const a=i.value?"anchorrNodes":"rnodes";u.addRoadNodeInline({selectedIndex:v.value,lngLat:e.mapboxEvent.lngLat,nodes:a})}}const t=c({coordinates:[0,0],showed:!1,actions:[],feature:null});function ce(e){["Delete rLink","Delete Selected"].includes(e.action)?(u.deleterLink({selectedIndex:e.feature}),r("clickFeature",{action:"Delete rLink"})):r("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),t.value.showed=!1,_()}function ee(e){var n,k;const a=e.mapboxEvent.originalEvent.ctrlKey;if(s.value&&!a){const F=o.value.querySourceFeatures(l.value.layerId);v.value=F.filter(V=>l.value.id.includes(V.id)),v.value.length>0&&(((n=l.value)==null?void 0:n.layerId)==="rnodes"?r("clickFeature",{selectedFeature:v.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((k=l.value)==null?void 0:k.layerId)==="anchorrNodes"&&u.deleteAnchorrNode({selectedNode:v.value[0].properties}))}}const f=c(new Set([]));function N(e){f.value.forEach(a=>{o.value.setFeatureState({source:"rlinks",id:a},{select:e})})}function _(){N(!1),f.value=new Set([]),t.value.showed=!1}function oe(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&_()}Q(()=>{o.value.on("mousedown",oe),o.value.on("click",_)}),re(()=>{o.value.off("mousedown",oe),o.value.off("click",_)});const U=m(()=>f.value.size>0);J(U,e=>r("select",e));function de(e){var a;s.value&&((a=l.value)==null?void 0:a.layerId)==="rlinks"&&(t.value.showed||(t.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),t.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(f.value=new Set([...f.value,...l.value.id]),N(!0),t.value.feature=W.cloneDeep(f),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]):(N(!1),f.value=new Set([]),t.value.feature=W.cloneDeep(l.value.id),t.value.actions=[{name:"Edit rLink Info",text:h("Edit rLink Info")},{name:"Delete rLink",text:h("Delete rLink")}]))}function ve(e){if(e.mapboxEvent.originalEvent.ctrlKey?f.value=new Set([...f.value,...e.selectedId]):(N(!1),f.value=e.selectedId),N(!0),f.value.size>0){t.value.showed=!0;const n=e.polygon.geometry.coordinates[0];t.value.coordinates=[(n[0][0]+n[2][0])/2,Math.max(n[0][1],n[2][1])],t.value.feature=W.cloneDeep(f),t.value.actions=[{name:"Edit selected Info",text:h("Edit selected Info")},{name:"Delete Selected",text:h("Delete Selected")}]}else t.value.showed=!1}function le(e){if(s.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",Z.value=!0;const a=o.value.querySourceFeatures(l.value.layerId);v.value=a.filter(n=>n.id===l.value.id[0])[0],K.value=!0,l.value.layerId==="rnodes"&&u.getConnectedLinks({selectedNode:v.value}),o.value.on("mousemove",ae),o.value.on("mouseup",te)}}function ae(e){T.value&&v.value&&(r("clickFeature",{action:"Move rNode"}),l.value.layerId==="anchorrNodes"?u.moverAnchor({selectedNode:v.value,lngLat:Object.values(e.lngLat)}):u.moverNode({selectedNode:v.value,lngLat:Object.values(e.lngLat)}))}function te(){s.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",ae),Z.value=!1,T.value=!1,K.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,o.value.off("mouseup",te))}const ne=m(()=>p.cyclewayMode),fe=m(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],a=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return ne.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],a]:["*",e,a]}),me=m(()=>ne.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,a)=>(D(),X("section",null,[d(s)?(D(),ue(Fe,{key:0,map:d(o),onMouseup:ve},null,8,["map"])):Le("",!0),g(d(E),{"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:M.value,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:y.value.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",x.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*$.value,$.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:R,onMouseleave:B},null,8,["source","layer"]),g(d(E),{"source-id":"rlinks",source:{type:"geojson",data:z.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:y.value.links,paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",x.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*$.value,$.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:R,onMouseleave:B,onClick:Y,onContextmenu:de},null,8,["source","layer"]),g(d(ye),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:y.value.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":fe.value,"icon-rotate":me.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),g(d(E),{"source-id":"rnodes",source:{type:"geojson",data:H.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:y.value.rendered,paint:{"circle-color":["case",["boolean",x.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:R,onMouseleave:B,onMousedown:le,onContextmenu:ee},null,8,["source","layer"]),g(d(E),{"source-id":"anchorrNodes",source:{type:"geojson",data:d(s)?P.value:d(w),buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:y.value.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:Y,onMouseover:R,onMouseleave:B,onMousedown:le,onContextmenu:ee},null,8,["source","layer"]),g(d(pe),{"close-button":!1,showed:t.value.showed,coordinates:t.value.coordinates,"close-on-click":!1,onClose:a[1]||(a[1]=n=>t.value.showed=!1)},{default:q(()=>[xe("span",{onMouseleave:a[0]||(a[0]=()=>{U.value||(t.value.showed=!1)})},[g(Ie,{density:"compact"},{default:q(()=>[(D(!0),X(ie,null,Me(t.value.actions,n=>(D(),ue(Ee,{key:n.id},{default:q(()=>[g(Se,{variant:"outlined",size:"small",onClick:k=>ce({action:n.name,feature:t.value.feature,coordinates:t.value.coordinates})},{default:q(()=>[Ce(Ne(d(h)(n.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])]))}};export{$e as default};
