import{_ as $,c as ee,d as oe,aR as ae,u as re,a6 as te,t as ne,p as le,o as se,e as g,az as Z,r as f,w as H,f as F,g as z,q as G,j as h,C as I,aS as N,i as x,D as ie,F as ue,J as ce,G as de,y as ve,x as fe,h as me,E as ye,v as ge,n as he}from"./index-SV3EqaTi.js";import{a as be,b as ke}from"./index-N60LIGRD.js";const V=n=>n,we={name:"RoadLinks",components:{MglGeojsonLayer:ee,MglImageLayer:oe,MglPopup:ae},props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(n,s){const t=re(),e=te(),{map:r,isRoadMode:c}=ne(n);le(()=>{r.value.on("dragend",v),r.value.on("zoomend",v)}),se(()=>{r.value.removeLayer("arrow-rlinks")});const m=g(()=>t.roadsPopupContent),L=g(()=>e.selectedrGroup),E=g(()=>t.cyclewayMode),d=g(()=>e.visiblerLinks),j=g(()=>e.renderedrLinks),q=g(()=>e.renderedrNodes),R=g(()=>t.anchorMode),D=Z,O=g(()=>R.value?e.anchorrNodes:Z),k=f(null),a=f(null),M=f(!1),T={static:1,rendered:2},S=f(100),p=f({links:4,rendered:14}),b=f({coordinates:[0,0],showed:!1,actions:[],feature:null});H(L,o=>{S.value=100,v()}),H(c,o=>{o?(r.value.on("dragend",v),r.value.on("zoomend",v),v()):(r.value.off("dragend",v),r.value.off("zoomend",v),e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value))});function v(o){const l=r.value.getZoom();if(l>p.value.rendered){const i=r.value.getBounds(),y=be(ke([i._sw.lng,i._sw.lat,i._ne.lng,i._ne.lat]),.2);e.getRenderedrLinks({bbox:y}),r.value.getSource("staticrLinks").setData(D)}else l>p.value.links&&S.value>p.value.rendered?(e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value)):e.setRenderedrLinks({method:"None"});S.value=l}const _=f(!1),C=f(!1),u=f("");function J(o){var l;if(c.value&&((l=k.value)!=null&&l.isOpen()&&k.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!M.value&&m.value.length>0){const y=o.mapboxEvent.features[0];if(y.layer.id!=="rnodes"){let w=m.value.map(P=>`${P}: <b>${y.properties[P]}</b>`);w=w.join("<br> "),k.value=new he.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(w).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const i=[...new Set(o.mapboxEvent.features.map(y=>y.id))];a.value={layerId:o.layerId,id:i},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),s.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function U(o){var l,i;c.value&&((l=k.value)!=null&&l.isOpen()&&k.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((i=a.value)==null?void 0:i.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(_.value?C.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,s.emit("offHover",o)))))}function W(o){if(c.value&&a.value!==null&&(u.value=a.value.id,u.value!==null&&a.value.layerId==="rlinks")){const l=R.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:u.value,lngLat:o.mapboxEvent.lngLat,nodes:l})}}function K(o){c.value&&a.value.layerId==="rlinks"&&(b.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],b.value.showed=!0,b.value.feature=a.value.id,b.value.actions=[V("Edit rLink Info"),V("Delete rLink")])}function Q(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),s.emit("clickFeature",{action:"Delete rLink"})):s.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),b.value.showed=!1,b.value.type=null}function X(o){var l,i;if(c.value){const y=r.value.querySourceFeatures(a.value.layerId);u.value=y.filter(w=>a.value.id.includes(w.id)),u.value.length>0&&(((l=a.value)==null?void 0:l.layerId)==="rnodes"?s.emit("clickFeature",{selectedFeature:u.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((i=a.value)==null?void 0:i.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:u.value[0].properties}))}}function Y(o){if(c.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",_.value=!0;const l=r.value.querySourceFeatures(a.value.layerId);u.value=l.filter(i=>i.id===a.value.id[0])[0],M.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:u.value}),r.value.on("mousemove",A),r.value.on("mouseup",B)}}function A(o){C.value&&u.value&&(s.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:u.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:u.value,lngLat:Object.values(o.lngLat)}))}function B(o){c.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",A),_.value=!1,C.value=!1,M.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",B))}return{store:t,rlinksStore:e,anchorMode:R,keepHovering:_,dragNode:C,selectedPopupContent:m,selectedrGroup:L,cyclewayMode:E,renderedrLinks:j,renderedrNodes:q,renderedAnchorrNodes:O,header:D,popup:k,hoveredStateId:a,visiblerLinks:d,disablePopup:M,width:T,minZoom:p,contextMenu:b,getBounds:v,onCursor:J,offCursor:U,selectClick:W,linkRightClick:K,actionClick:Q,contextMenuNode:X,moveNode:Y}},computed:{ArrowSizeCondition(){const n=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],s=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],n,.25]],0],s]:["*",n,s]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function Le(n,s,t,e,r,c){const m=F("MglGeojsonLayer"),L=F("MglImageLayer"),E=F("MglPopup");return z(),G("section",null,[h(m,I({"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:e.visiblerLinks,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",t.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.static,e.width.static],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}}},N(t.isEditorMode||!t.isRoadMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor})),null,16,["source","layer"]),h(m,I({"source-id":"rlinks",source:{type:"geojson",data:e.renderedrLinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",t.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.rendered,e.width.rendered],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}}},N(t.isEditorMode||!t.isRoadMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,click:e.selectClick,contextmenu:e.linkRightClick})),null,16,["source","layer"]),h(L,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":c.ArrowSizeCondition,"icon-rotate":c.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),h(m,I({"source-id":"rnodes",source:{type:"geojson",data:e.renderedrNodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",t.isEditorMode,!1],n.$vuetify.theme.current.colors.mediumgrey,n.$vuetify.theme.current.colors.accent],"circle-stroke-color":n.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}}},N(t.isEditorMode||!t.isRoadMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,mousedown:e.moveNode,contextmenu:e.contextMenuNode})),null,16,["source","layer"]),h(m,I({"source-id":"anchorrNodes",source:{type:"geojson",data:t.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":n.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}}},N(t.isEditorMode||!t.isRoadMode?{}:{click:e.selectClick,mouseover:e.onCursor,mouseleave:e.offCursor,mousedown:e.moveNode,contextmenu:e.contextMenuNode})),null,16,["source","layer"]),h(E,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:s[1]||(s[1]=d=>e.contextMenu.showed=!1)},{default:x(()=>[ge("span",{onMouseleave:s[0]||(s[0]=d=>e.contextMenu.showed=!1)},[h(ie,{density:"compact"},{default:x(()=>[(z(!0),G(ue,null,ye(e.contextMenu.actions,d=>(z(),me(ce,{key:d.id},{default:x(()=>[h(de,{variant:"outlined",size:"small",onClick:j=>e.actionClick({action:d,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:x(()=>[fe(ve(n.$gettext(d)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const _e=$(we,[["render",Le]]);export{_e as default};
