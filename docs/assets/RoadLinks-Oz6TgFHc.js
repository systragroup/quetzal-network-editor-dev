import{_ as ee,c as oe,d as ae,aM as re,u as ne,a5 as te,t as le,p as se,o as ue,e as m,au as A,r as c,w as P,f as F,g as R,q as D,j as y,B as H,aN as Z,i as x,C as ie,F as ce,I as de,E as ve,x as fe,v as me,h as ye,D as ge,s as he,m as be}from"./index-nNed5iKc.js";import{a as ke,b as pe}from"./index-YP3YamTR.js";const V=t=>t,we={name:"RoadLinks",components:{MglGeojsonLayer:oe,MglImageLayer:ae,MglPopup:re},props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(t,l){const g=ne(),e=te(),{map:r,isEditorMode:M,isRoadMode:s}=le(t);se(()=>{r.value.on("dragend",d),r.value.on("zoomend",d)}),ue(()=>{r.value.removeLayer("arrow-rlinks")});const k=m(()=>g.roadsPopupContent),L=m(()=>e.selectedrGroup),v=m(()=>g.cyclewayMode),S=m(()=>e.renderedrLinks),G=m(()=>e.renderedrNodes),_=m(()=>g.anchorMode),q=A,O=m(()=>_.value?e.anchorrNodes:A),h=c(null),a=c(null),W=c({}),T=c({}),C=c(!1),p=c(1),E=c({links:2,rendered:14}),f=c({coordinates:[0,0],showed:!1,actions:[],feature:null});P(L,()=>{d()}),P(s,o=>{o?(r.value.on("dragend",d),r.value.on("zoomend",d),d()):(r.value.off("dragend",d),r.value.off("zoomend",d),p.value=1,e.setRenderedrLinks({method:"visible"}))});function d(o){const n=r.value.getBounds(),i=ke(pe([n._sw.lng,n._sw.lat,n._ne.lng,n._ne.lat]),.2);r.value.getZoom()>E.value.rendered?(p.value=2,e.getRenderedrLinks({bbox:i})):r.value.getZoom()>E.value.links?(p.value=1,e.setRenderedrLinks({method:"visible"})):(p.value=1,e.setRenderedrLinks({method:"None"}))}const I=c(!1),N=c(!1),u=c("");function U(o){var n;if(s.value&&((n=h.value)!=null&&n.isOpen()&&h.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!C.value&&k.value.length>0){const b=o.mapboxEvent.features[0];if(b.layer.id!=="rnodes"){let w=k.value.map(B=>`${B}: <b>${b.properties[B]}</b>`);w=w.join("<br> "),h.value=new be.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(w).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const i=[...new Set(o.mapboxEvent.features.map(b=>b.id))];a.value={layerId:o.layerId,id:i},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),l.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function J(o){var n,i;s.value&&((n=h.value)!=null&&n.isOpen()&&h.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((i=a.value)==null?void 0:i.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(I.value?N.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,l.emit("offHover",o)))))}function K(o){if(s.value&&a.value!==null&&(u.value=a.value.id,u.value!==null&&a.value.layerId==="rlinks")){const n=_.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:u.value,lngLat:o.mapboxEvent.lngLat,nodes:n})}}function Q(o){s.value&&a.value.layerId==="rlinks"&&(f.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],f.value.showed=!0,f.value.feature=a.value.id,f.value.actions=[V("Edit rLink Info"),V("Delete rLink")])}function X(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),l.emit("clickFeature",{action:"Delete rLink"})):l.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),f.value.showed=!1,f.value.type=null}function Y(o){var n,i;if(s.value){const b=r.value.querySourceFeatures(a.value.layerId);u.value=b.filter(w=>a.value.id.includes(w.id)),u.value.length>0&&(((n=a.value)==null?void 0:n.layerId)==="rnodes"?l.emit("clickFeature",{selectedFeature:u.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((i=a.value)==null?void 0:i.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:u.value[0].properties}))}}function $(o){if(s.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",I.value=!0;const n=r.value.querySourceFeatures(a.value.layerId);u.value=n.filter(i=>i.id===a.value.id[0])[0],C.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:u.value}),r.value.on("mousemove",j),r.value.on("mouseup",z)}}function j(o){N.value&&u.value&&(l.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:u.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:u.value,lngLat:Object.values(o.lngLat)}))}function z(o){s.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",j),I.value=!1,N.value=!1,C.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",z))}return{store:g,rlinksStore:e,anchorMode:_,map:r,isEditorMode:M,isRoadMode:s,keepHovering:I,dragNode:N,selectedPopupContent:k,selectedrGroup:L,cyclewayMode:v,renderedrLinks:S,renderedrNodes:G,renderedAnchorrNodes:O,header:q,popup:h,hoveredStateId:a,visibleNodes:W,visibleLinks:T,disablePopup:C,routeWidth:p,minZoom:E,contextMenu:f,getBounds:d,onCursor:U,offCursor:J,selectClick:K,linkRightClick:Q,actionClick:X,contextMenuNode:Y,moveNode:$}},computed:{ArrowSizeCondition(){const t=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],l=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],t,.25]],0],l]:["*",t,l]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function Me(t,l,g,e,r,M){const s=F("MglGeojsonLayer"),k=F("MglImageLayer"),L=F("MglPopup");return R(),D("section",null,[y(s,H({"source-id":"rlinks",source:{type:"geojson",data:e.renderedrLinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{interactive:!0,type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",e.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.routeWidth,e.routeWidth],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}}},Z(e.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,click:e.selectClick,contextmenu:e.linkRightClick})),null,16,["source","layer"]),y(k,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":M.ArrowSizeCondition,"icon-rotate":M.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),y(s,H({"source-id":"rnodes",source:{type:"geojson",data:e.renderedrNodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",e.isEditorMode,!1],t.$vuetify.theme.current.colors.mediumgrey,t.$vuetify.theme.current.colors.accent],"circle-stroke-color":t.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}}},Z(e.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,mousedown:e.moveNode,contextmenu:e.contextMenuNode})),null,16,["source","layer"]),y(s,{"source-id":"anchorrNodes",source:{type:"geojson",data:e.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":t.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:e.selectClick,onMouseover:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onClick","onMouseover","onMouseleave","onMousedown","onContextmenu"]),y(L,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:l[1]||(l[1]=v=>e.contextMenu.showed=!1)},{default:x(()=>[he("span",{onMouseleave:l[0]||(l[0]=v=>e.contextMenu.showed=!1)},[y(ie,{density:"compact"},{default:x(()=>[(R(!0),D(ce,null,ge(e.contextMenu.actions,v=>(R(),ye(de,{key:v.id},{default:x(()=>[y(ve,{variant:"outlined",size:"small",onClick:S=>e.actionClick({action:v,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:x(()=>[me(fe(t.$gettext(v)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const Ie=ee(we,[["render",Me]]);export{Ie as default};
