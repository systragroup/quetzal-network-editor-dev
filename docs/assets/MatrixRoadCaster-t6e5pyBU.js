import{au as X,u as y,ao as f,av as _,_ as Q,a5 as $,r as m,e as g,p as ee,w as te,g as c,h as k,i as s,W as T,K as q,a9 as U,x as u,v as d,j as r,s as D,S as ae,H as ne,F as E,Y as H,L as se,q as v,E as O,a1 as re,G as A,V as M,z as V,y as R,ab as ie,a2 as le,al as oe,l as ue,ap as de,X as ce}from"./index-H0c6mx3k.js";import{u as he}from"./Microservices-fjlBX6GN.js";import"./index-RnTv-dew.js";const me=e=>e,ge=X("runMRC",{state:()=>({stateMachineArn:"arn:aws:states:ca-central-1:142023388927:stateMachine:quetzal-matrixroadcaster-api",bucket:"quetzal-api-bucket",callID:"",status:"",timer:0,running:!1,executionArn:"",error:!1,errorMessage:"",parameters:{callID:"test",num_zones:100,train_size:100,date_time:"2022-12-13T08:00:21-04:00",ff_time_col:"time",max_speed:100,num_cores:1,num_random_od:1,create_zone:!0,hereApiKey:""}}),actions:{cleanRun(){this.running=!1,this.executionArn="",this.error=!1},setCallID(){this.callID=he.v4()},setParameters(e){this.parameters=e},terminateExecution(e){this.running=!1,this.error=!0,this.errorMessage=e,this.executionArn=""},changeRunning(e){this.running=e},getApproxTimer(e){const n=this.parameters.num_zones,i=this.parameters.train_size,t=this.parameters.num_random_od;this.timer=Math.min(n,i)*1.8+e*.002+15,this.timer+=10*t},succeedExecution(){this.running=!1,this.executionArn="",y().changeNotification({text:me("Matrix Road Caster executed successfully!"),autoClose:!1,color:"success"})},async startExecution(e){this.getApproxTimer(e.rlinks.features.length),this.setParameters(e.parameters),console.log("exporting roads to s3"),this.error=!1,this.running=!0;try{await f.putObject(this.bucket,this.callID.concat("/road_links.geojson"),JSON.stringify(e.rlinks)),await f.putObject(this.bucket,this.callID.concat("/road_nodes.geojson"),JSON.stringify(e.rnodes))}catch(i){y().changeAlert(i)}let n={input:JSON.stringify(this.parameters),name:this.callID,stateMachineArn:this.stateMachineArn};_.client.post("",n=JSON.stringify(n)).then(i=>{this.executionArn=i.data.executionArn,this.pollExecution()}).catch(i=>{y().changeAlert(i),this.running=!1,this.status="FAILED"})},pollExecution(){const e=setInterval(()=>{let n={executionArn:this.executionArn};this.timer=this.timer-2,_.client.post("/describe",n=JSON.stringify(n)).then(i=>{this.status=i.data.status,console.log(this.status),this.status==="SUCCEEDED"?(this.succeedExecution(),clearInterval(e)):["FAILED","TIMED_OUT","ABORTED"].includes(this.status)&&(this.terminateExecution(JSON.parse(i.data.cause)),clearInterval(e))}).catch(i=>{y().changeAlert(i)})},2e3)},stopExecution(){let e={executionArn:this.executionArn};_.client.post("/abort",e=JSON.stringify(e)).then(n=>{this.terminateExecution(n.data)}).catch(n=>{y().changeAlert(n)})}}}),C=e=>e,fe={name:"MatrixRoadCaster",components:{},setup(){const e=ge(),n=$(),i=y(),t=m([]),I=m(!1),N=m(!1),a=m(!0),b=m(!1),l=m([{name:"num_zones",text:"number of zones",value:null,type:"Number",units:"",hint:"number of zones. road nodes will be aggregate to form centroids",rules:["required","largerThanZero"]},{name:"train_size",text:"number of OD (api call)",value:null,type:"Number",units:"",hint:"number of OD to get from the API, the rest will be interpolated with ML",rules:["required","largerThanZero"]},{name:"date_time",text:"date Time",value:null,type:"String",units:"",hint:"DateTime in the past. (YYYY-MM-DDTHH:MM:SS(UTC-timezone) (-04:00 for montreal))",rules:["required","dateTimeRule"]},{name:"ff_time_col",text:"freeflow time on roads",value:null,items:n.rlineAttributes,type:"String",units:"",hint:"road links time (link length / speed) to use as a first approximation. this is the freeflow speed, or speed limit",rules:["required"]},{name:"max_speed",text:"max speed on road",value:null,type:"Number",units:"",hint:"Maximum allowed speed on a road. applying an OD matrix on the road network could result il unrealistic speed if not used.",rules:["required","largerThanZero"]},{name:"num_random_od",text:"number of OD to plot",value:null,type:"Number",units:"",hint:"number of OD calibration plot to produce. those are random OD.",rules:["required","largerThanZero"]},{name:"hereApiKey",text:"HERE api key",value:null,type:"password",units:"",hint:"HERE api key to download a set of OD",rules:["required"]}]),w=g(()=>e.bucket),p=g(()=>e.callID),F=g(()=>e.timer),P=g(()=>e.status),j=g(()=>e.running),L=g(()=>e.error),J=g(()=>e.errorMessage);ee(()=>{const o=e.parameters;l.value.forEach(h=>h.value=o[h.name]),p.value&&z()}),te(P,o=>{o==="SUCCEEDED"&&z()});async function Z(o){if(!(await o).valid)return;e.setCallID();const x={callID:p.value};l.value.forEach(S=>{x[S.name]=S.value}),e.startExecution({rlinks:n.rlinks,rnodes:n.rnodes,parameters:x})}function B(){e.stopExecution()}async function G(){N.value=!0;const o=await f.readJson(w.value,p.value.concat("/road_links.geojson"));n.loadrLinks(o);const h=await f.readJson(w.value,p.value.concat("/road_nodes.geojson"));n.loadrNodes(h),N.value=!1,i.changeNotification({text:C("Road links applied!"),autoClose:!0,color:"success"})}async function z(){const h=(await f.listFiles(w.value,p.value+"/")).filter(x=>x.endsWith(".png"));for(const x of h){const S=await f.getImagesURL(w.value,x);t.value.push(S)}}async function W(){I.value=!0,await f.downloadFolder(w.value,p.value.concat("/")),I.value=!1}const Y=m(!1),K=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;return{imgs:t,exporting:I,applying:N,validForm:a,showP:b,parameters:l,showHint:Y,rules:{required:o=>!!o||C("Required"),largerThanZero:o=>o>0||C("should be larger than 0"),nonNegative:o=>o>=0||C("should be larger or equal to 0"),dateTimeRule:o=>K.test(o)||C("invalid date time")},timer:F,running:j,error:L,errorMessage:J,download:W,run:Z,stopRun:B,ApplyResults:G}}};function pe(e,n,i,t,I,N){return c(),k(ce,{class:"ma-0 pa-2 background"},{default:s(()=>[r(T,null,{default:s(()=>[r(q,{class:"card"},{default:s(()=>[r(U,{class:"subtitle"},{default:s(()=>[d(u(e.$gettext("ML Matrix Road Caster")),1)]),_:1}),D("p",null,u(e.$gettext("1) Find n zones centroids using a Kmean clustering on the nodes")),1),D("p",null,u(e.$gettext("2) Call the Here Matrix API on random OD ( around 1% is sufficient )")),1),D("p",null,u(e.$gettext("3) Interpolate every other OD time with an hybrid Machine learning model")),1),D("p",null,u(e.$gettext("4) ajust the speed on the road network to match the routing time with the OD time using an iterative algorithm")),1),r(ae,{"validate-on":"submit lazy",onSubmit:ne(t.run,["prevent"])},{default:s(()=>[(c(!0),v(E,null,O(t.parameters,(a,b)=>(c(),v("div",{key:b},[a.type==="password"?(c(),k(H,{key:0,modelValue:a.value,"onUpdate:modelValue":l=>a.value=l,type:t.showP?"text":"password","append-icon":t.showP?"fas fa-eye":"fas fa-eye-slash",label:e.$gettext(a.text),suffix:a.units,hint:t.showHint?e.$gettext(a.hint):"","persistent-hint":t.showHint,rules:a.rules.map(l=>t.rules[l]),required:"","onClick:append":n[0]||(n[0]=l=>t.showP=!t.showP)},null,8,["modelValue","onUpdate:modelValue","type","append-icon","label","suffix","hint","persistent-hint","rules"])):typeof a.items>"u"?(c(),k(H,{key:1,modelValue:a.value,"onUpdate:modelValue":l=>a.value=l,type:a.type,label:e.$gettext(a.text),suffix:a.units,hint:t.showHint?e.$gettext(a.hint):"","persistent-hint":t.showHint,rules:a.rules.map(l=>t.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(c(),k(se,{key:2,modelValue:a.value,"onUpdate:modelValue":l=>a.value=l,type:a.type,items:a.items,label:e.$gettext(a.text),suffix:a.units,hint:t.showHint?e.$gettext(a.hint):"","persistent-hint":t.showHint,rules:a.rules.map(l=>t.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128)),r(re,null,{default:s(()=>[r(A,{variant:"regular",color:"success",loading:t.running||e.importStatus==="RUNNING",disabled:t.running||e.importStatus==="RUNNING"||!t.validForm,type:"submit"},{default:s(()=>[r(M,{size:"small",style:{"margin-right":"10px"}},{default:s(()=>[d(" fa-solid fa-play ")]),_:1}),d(" "+u(e.$gettext("Run")),1)]),_:1},8,["loading","disabled"]),R(r(A,{color:"grey",variant:"text",onClick:n[1]||(n[1]=a=>t.stopRun())},{default:s(()=>[d(u(e.$gettext("Abort")),1)]),_:1},512),[[V,e.importStatus=="RUNNING"]]),R(r(ie,null,{default:s(()=>[d(" ~ "+u(t.timer>0?Math.ceil(t.timer/60):e.$gettext("less than 1"))+u(e.$gettext(" minutes remaining")),1)]),_:1},512),[[V,e.importStatus=="RUNNING"]]),r(le),r(A,{size:"small",onClick:n[2]||(n[2]=a=>t.showHint=!t.showHint)},{default:s(()=>[r(M,null,{default:s(()=>[d("far fa-question-circle small")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1}),r(T,null,{default:s(()=>[r(q,{class:"card2"},{default:s(()=>[r(U,{class:"subtitle"},{default:s(()=>[d(u(e.$gettext("Calibration Results")),1)]),_:1}),R(r(A,{loading:t.applying,disabled:t.applying,onClick:t.ApplyResults},{default:s(()=>[r(M,{size:"small",style:{"margin-right":"10px"}},{default:s(()=>[d(" fa-solid fa-upload ")]),_:1}),d(" "+u(e.$gettext("Apply Road links to project")),1)]),_:1},8,["loading","disabled","onClick"]),[[V,t.imgs.length>0]]),R(r(A,{loading:t.exporting,disabled:t.exporting,onClick:t.download},{default:s(()=>[r(M,{size:"small",style:{"margin-right":"10px"}},{default:s(()=>[d(" fa-solid fa-download ")]),_:1}),d(" "+u(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","onClick"]),[[V,t.imgs.length>0]]),t.error?(c(),k(oe,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:s(()=>[d(u(e.$gettext("Service ended with an execution error or have been aborted.             Please retry. If the problem persist, contact us."))+" ",1),(c(!0),v(E,null,O(Object.keys(t.errorMessage),a=>(c(),v("p",{key:a},[D("b",null,u(a)+": ",1),d(u(t.errorMessage[a]),1)]))),128))]),_:1})):ue("",!0),(c(!0),v(E,null,O(t.imgs,(a,b)=>(c(),v("div",{key:b,class:"gallery"},[r(de,{src:a,alt:"image",cover:""},null,8,["src"])]))),128))]),_:1})]),_:1})]),_:1})}const we=Q(fe,[["render",pe],["__scopeId","data-v-24521792"]]);export{we as default};
