import{_ as Q,c as X,d as $,aY as ee,u as oe,a7 as ae,t as re,p as ne,o as te,e as g,aA as B,r as f,w as Z,f as S,g as F,q as P,j as h,i as _,D as le,F as se,J as ue,G as ie,y as ce,x as de,h as ve,E as fe,v as me,n as ye}from"./index-AjcSq5hc.js";import{a as ge,b as he}from"./index-6mgu2dm5.js";const G=n=>n,ke={name:"RoadLinks",components:{MglGeojsonLayer:X,MglImageLayer:$,MglPopup:ee},props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(n,l){const c=oe(),e=ae(),{map:r,isRoadMode:i}=re(n);ne(()=>{r.value.on("dragend",v),r.value.on("zoomend",v),r.value.getLayer("links")&&(r.value.moveLayer("rlinks","links"),r.value.moveLayer("staticrLinks","links"))}),te(()=>{r.value.removeLayer("arrow-rlinks")});const m=g(()=>c.roadsPopupContent),M=g(()=>e.selectedrGroup),I=g(()=>c.cyclewayMode),d=g(()=>e.visiblerLinks),R=g(()=>e.renderedrLinks),H=g(()=>e.renderedrNodes),N=g(()=>c.anchorMode),z=B,V=g(()=>N.value?e.anchorrNodes:B),b=f(null),a=f(null),p=f(!1),q={static:1,rendered:2},E=f(100),L=f({links:4,rendered:14}),k=f({coordinates:[0,0],showed:!1,actions:[],feature:null});Z(M,o=>{E.value=100,v()}),Z(i,o=>{o?(r.value.on("dragend",v),r.value.on("zoomend",v),v()):(r.value.off("dragend",v),r.value.off("zoomend",v),e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value))});function v(o){const t=r.value.getZoom();if(t>L.value.rendered){const s=r.value.getBounds(),y=ge(he([s._sw.lng,s._sw.lat,s._ne.lng,s._ne.lat]),.2);e.getRenderedrLinks({bbox:y}),r.value.getSource("staticrLinks").setData(z)}else t>L.value.links&&E.value>L.value.rendered?(e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value)):e.setRenderedrLinks({method:"None"});E.value=t}const C=f(!1),x=f(!1),u=f("");function O(o){var t;if(i.value&&((t=b.value)!=null&&t.isOpen()&&b.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!p.value&&m.value.length>0){const y=o.mapboxEvent.features[0];if(y.layer.id!=="rnodes"){let w=m.value.map(A=>`${A}: <b>${y.properties[A]}</b>`);w=w.join("<br> "),b.value=new ye.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(w).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const s=[...new Set(o.mapboxEvent.features.map(y=>y.id))];a.value={layerId:o.layerId,id:s},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),l.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function T(o){var t,s;i.value&&((t=b.value)!=null&&t.isOpen()&&b.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((s=a.value)==null?void 0:s.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(C.value?x.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,l.emit("offHover",o)))))}function J(o){if(i.value&&a.value!==null&&(u.value=a.value.id,u.value!==null&&a.value.layerId==="rlinks")){const t=N.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:u.value,lngLat:o.mapboxEvent.lngLat,nodes:t})}}function U(o){i.value&&a.value.layerId==="rlinks"&&(k.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],k.value.showed=!0,k.value.feature=a.value.id,k.value.actions=[G("Edit rLink Info"),G("Delete rLink")])}function W(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),l.emit("clickFeature",{action:"Delete rLink"})):l.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),k.value.showed=!1,k.value.type=null}function Y(o){var t,s;if(i.value){const y=r.value.querySourceFeatures(a.value.layerId);u.value=y.filter(w=>a.value.id.includes(w.id)),u.value.length>0&&(((t=a.value)==null?void 0:t.layerId)==="rnodes"?l.emit("clickFeature",{selectedFeature:u.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((s=a.value)==null?void 0:s.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:u.value[0].properties}))}}function K(o){if(i.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",C.value=!0;const t=r.value.querySourceFeatures(a.value.layerId);u.value=t.filter(s=>s.id===a.value.id[0])[0],p.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:u.value}),r.value.on("mousemove",j),r.value.on("mouseup",D)}}function j(o){x.value&&u.value&&(l.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:u.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:u.value,lngLat:Object.values(o.lngLat)}))}function D(o){i.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",j),C.value=!1,x.value=!1,p.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",D))}return{store:c,rlinksStore:e,anchorMode:N,keepHovering:C,dragNode:x,selectedPopupContent:m,selectedrGroup:M,cyclewayMode:I,renderedrLinks:R,renderedrNodes:H,renderedAnchorrNodes:V,header:z,popup:b,hoveredStateId:a,visiblerLinks:d,disablePopup:p,width:q,minZoom:L,contextMenu:k,getBounds:v,onCursor:O,offCursor:T,selectClick:J,linkRightClick:U,actionClick:W,contextMenuNode:Y,moveNode:K}},computed:{ArrowSizeCondition(){const n=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],l=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],n,.25]],0],l]:["*",n,l]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function be(n,l,c,e,r,i){const m=S("MglGeojsonLayer"),M=S("MglImageLayer"),I=S("MglPopup");return F(),P("section",null,[h(m,{"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:e.visiblerLinks,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",c.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.static,e.width.static],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor},null,8,["source","layer","onMouseenter","onMouseleave"]),h(m,{"source-id":"rlinks",source:{type:"geojson",data:e.renderedrLinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",c.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.rendered,e.width.rendered],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor,onClick:e.selectClick,onContextmenu:e.linkRightClick},null,8,["source","layer","onMouseenter","onMouseleave","onClick","onContextmenu"]),h(M,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":i.ArrowSizeCondition,"icon-rotate":i.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),h(m,{"source-id":"rnodes",source:{type:"geojson",data:e.renderedrNodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",c.isEditorMode,!1],n.$vuetify.theme.current.colors.mediumgrey,n.$vuetify.theme.current.colors.accent],"circle-stroke-color":n.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onMouseenter","onMouseleave","onMousedown","onContextmenu"]),h(m,{"source-id":"anchorrNodes",source:{type:"geojson",data:c.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":n.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:e.selectClick,onMouseover:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onClick","onMouseover","onMouseleave","onMousedown","onContextmenu"]),h(I,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:l[1]||(l[1]=d=>e.contextMenu.showed=!1)},{default:_(()=>[me("span",{onMouseleave:l[0]||(l[0]=d=>e.contextMenu.showed=!1)},[h(le,{density:"compact"},{default:_(()=>[(F(!0),P(se,null,fe(e.contextMenu.actions,d=>(F(),ve(ue,{key:d.id},{default:_(()=>[h(ie,{variant:"outlined",size:"small",onClick:R=>e.actionClick({action:d,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:_(()=>[de(ce(n.$gettext(d)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const pe=Q(ke,[["render",be]]);export{pe as default};
