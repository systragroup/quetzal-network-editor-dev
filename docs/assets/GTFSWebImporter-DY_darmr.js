import{c1 as ae,c2 as C,c3 as ue,aL as ie,c4 as ce,c5 as fe,c6 as B,c7 as z,_ as de,u as ve,b4 as ye,a8 as he,a as pe,r as M,c as G,o as me,v as be,aH as ge,b as x,x as T,f as y,e as m,ae as $,z as V,A as p,g,O as q,a$ as Y,I as S,d as A,av as Pe,G as N,H as U,y as h,k as we,a0 as xe,P as Ve,b2 as Le,S as Ie,a6 as ke,a7 as Me,X as Q,ab as Te}from"./index-pt6uXENh.js";import{b as E,a as Z,M as Ce}from"./Microservices-hr1Atp-z.js";import{P as Fe}from"./index-DARc2jNN.js";function k(t,e,r){if(r===void 0&&(r={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var n=ae(t),l=C(e),a=l.type,s=e.bbox,u=l.coordinates;if(s&&Ge(n,s)===!1)return!1;a==="Polygon"&&(u=[u]);for(var i=!1,d=0;d<u.length&&!i;d++)if(j(n,u[d][0],r.ignoreBoundary)){for(var v=!1,L=1;L<u[d].length&&!v;)j(n,u[d][L],!r.ignoreBoundary)&&(v=!0),L++;v||(i=!0)}return i}function j(t,e,r){var n=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var l=0,a=e.length-1;l<e.length;a=l++){var s=e[l][0],u=e[l][1],i=e[a][0],d=e[a][1],v=t[1]*(s-i)+u*(i-t[0])+d*(t[0]-s)===0&&(s-t[0])*(i-t[0])<=0&&(u-t[1])*(d-t[1])<=0;if(v)return!r;var L=u>t[1]!=d>t[1]&&t[0]<(i-s)*(t[1]-u)/(d-u)+s;L&&(n=!n)}return n}function Ge(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}function _(t,e,r){r===void 0&&(r={});for(var n=ae(t),l=ue(e),a=0;a<l.length-1;a++){var s=!1;if(r.ignoreEndVertices&&(a===0&&(s="start"),a===l.length-2&&(s="end"),a===0&&a+1===l.length-1&&(s="both")),Se(l[a],l[a+1],n,s,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Se(t,e,r,n,l){var a=r[0],s=r[1],u=t[0],i=t[1],d=e[0],v=e[1],L=r[0]-u,O=r[1]-i,b=d-u,P=v-i,F=L*P-O*b;if(l!==null){if(Math.abs(F)>l)return!1}else if(F!==0)return!1;if(n){if(n==="start")return Math.abs(b)>=Math.abs(P)?b>0?u<a&&a<=d:d<=a&&a<u:P>0?i<s&&s<=v:v<=s&&s<i;if(n==="end")return Math.abs(b)>=Math.abs(P)?b>0?u<=a&&a<d:d<a&&a<=u:P>0?i<=s&&s<v:v<s&&s<=i;if(n==="both")return Math.abs(b)>=Math.abs(P)?b>0?u<a&&a<d:d<a&&a<u:P>0?i<s&&s<v:v<s&&s<i}else return Math.abs(b)>=Math.abs(P)?b>0?u<=a&&a<=d:d<=a&&a<=u:P>0?i<=s&&s<=v:v<=s&&s<=i;return!1}function ee(t,e){var r=C(t),n=C(e),l=r.type,a=n.type,s=r.coordinates,u=n.coordinates;switch(l){case"Point":switch(a){case"Point":return K(s,u);default:throw new Error("feature2 "+a+" geometry not supported")}case"MultiPoint":switch(a){case"Point":return _e(r,n);case"MultiPoint":return Be(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}case"LineString":switch(a){case"Point":return _(n,r,{ignoreEndVertices:!0});case"LineString":return De(r,n);case"MultiPoint":return Ee(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}case"Polygon":switch(a){case"Point":return k(n,r,{ignoreBoundary:!0});case"LineString":return $e(r,n);case"Polygon":return qe(r,n);case"MultiPoint":return Oe(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}default:throw new Error("feature1 "+l+" geometry not supported")}}function _e(t,e){var r,n=!1;for(r=0;r<t.coordinates.length;r++)if(K(t.coordinates[r],e.coordinates)){n=!0;break}return n}function Be(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){for(var l=n[r],a=!1,s=0,u=t.coordinates;s<u.length;s++){var i=u[s];if(K(l,i)){a=!0;break}}if(!a)return!1}return!0}function Ee(t,e){for(var r=!1,n=0,l=e.coordinates;n<l.length;n++){var a=l[n];if(_(a,t,{ignoreEndVertices:!0})&&(r=!0),!_(a,t))return!1}return!!r}function Oe(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){var l=n[r];if(!k(l,t,{ignoreBoundary:!0}))return!1}return!0}function De(t,e){for(var r=!1,n=0,l=e.coordinates;n<l.length;n++){var a=l[n];if(_({type:"Point",coordinates:a},t,{ignoreEndVertices:!0})&&(r=!0),!_({type:"Point",coordinates:a},t,{ignoreEndVertices:!1}))return!1}return r}function $e(t,e){var r=!1,n=0,l=E(t),a=E(e);if(!ne(l,a))return!1;for(n;n<e.coordinates.length-1;n++){var s=Ae(e.coordinates[n],e.coordinates[n+1]);if(k({type:"Point",coordinates:s},t,{ignoreBoundary:!0})){r=!0;break}}return r}function qe(t,e){if(t.type==="Feature"&&t.geometry===null||e.type==="Feature"&&e.geometry===null)return!1;var r=E(t),n=E(e);if(!ne(r,n))return!1;for(var l=C(e).coordinates,a=0,s=l;a<s.length;a++)for(var u=s[a],i=0,d=u;i<d.length;i++){var v=d[i];if(!k(v,t))return!1}return!0}function ne(t,e){return!(t[0]>e[0]||t[2]<e[2]||t[1]>e[1]||t[3]<e[3])}function K(t,e){return t[0]===e[0]&&t[1]===e[1]}function Ae(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function W(t,e){e===void 0&&(e={});var r=C(t);switch(!e.properties&&t.type==="Feature"&&(e.properties=t.properties),r.type){case"Polygon":return Ne(r,e);case"MultiPolygon":return Ue(r,e);default:throw new Error("invalid poly")}}function Ne(t,e){e===void 0&&(e={});var r=C(t),n=r.coordinates,l=e.properties?e.properties:t.type==="Feature"?t.properties:{};return se(n,l)}function Ue(t,e){e===void 0&&(e={});var r=C(t),n=r.coordinates,l=e.properties?e.properties:t.type==="Feature"?t.properties:{},a=[];return n.forEach(function(s){a.push(se(s,l))}),ie(a)}function se(t,e){return t.length>1?ce(t,e):fe(t[0],e)}function We(t,e){var r=!0;return B(t,function(n){B(e,function(l){if(r===!1)return!1;r=ze(n.geometry,l.geometry)})}),r}function ze(t,e){switch(t.type){case"Point":switch(e.type){case"Point":return!He(t.coordinates,e.coordinates);case"LineString":return!te(e,t);case"Polygon":return!k(t,e)}break;case"LineString":switch(e.type){case"Point":return!te(t,e);case"LineString":return!Ke(t,e);case"Polygon":return!re(e,t)}break;case"Polygon":switch(e.type){case"Point":return!k(e,t);case"LineString":return!re(t,e);case"Polygon":return!Re(e,t)}}return!1}function te(t,e){for(var r=0;r<t.coordinates.length-1;r++)if(Xe(t.coordinates[r],t.coordinates[r+1],e.coordinates))return!0;return!1}function Ke(t,e){var r=z(t,e);return r.features.length>0}function re(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){var l=n[r];if(k(l,t))return!0}var a=z(e,W(t));return a.features.length>0}function Re(t,e){for(var r=0,n=t.coordinates[0];r<n.length;r++){var l=n[r];if(k(l,e))return!0}for(var a=0,s=e.coordinates[0];a<s.length;a++){var u=s[a];if(k(u,t))return!0}var i=z(W(t),W(e));return i.features.length>0}function Xe(t,e,r){var n=r[0]-t[0],l=r[1]-t[1],a=e[0]-t[0],s=e[1]-t[1],u=n*s-l*a;return u!==0?!1:Math.abs(a)>=Math.abs(s)?a>0?t[0]<=r[0]&&r[0]<=e[0]:e[0]<=r[0]&&r[0]<=t[0]:s>0?t[1]<=r[1]&&r[1]<=e[1]:e[1]<=r[1]&&r[1]<=t[1]}function He(t,e){return t[0]===e[0]&&t[1]===e[1]}function Je(t,e){var r=!1;return B(t,function(n){B(e,function(l){if(r===!0)return!0;r=!We(n.geometry,l.geometry)})}),r}const Ye={class:"background"},Qe={class:"params-row"},Ze={class:"list"},je={class:"list-row"},et={class:"list-item-small"},tt={class:"list-item-small"},rt={class:"list-item-small"},at={class:"list-item-small"},nt={class:"list-item-medium"},st={class:"list-item-medium"},ot={class:"list-item-large"},lt={__name:"GTFSWebImporter",setup(t){const{$gettext:e}=ve(),r=ye(),n=he(),l=pe(),a=M(!1),s=M(null),u=M([]),i=M([]),d=M(!1),v=M(r.selectedGTFS),L=G(()=>n.linksIsEmpty),O=G(()=>r.callID),b=G(()=>r.running),P=G(()=>r.error),F=G(()=>r.errorMessage);me(()=>{r.saveParams(D.value),r.saveSelectedGTFS(v.value)});const D=M([{name:"start_time",text:"start time",value:r.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:r.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:r.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),R={required:c=>!!c||e("Required")};be(async()=>{u.value=await oe(),u.value.forEach((c,f)=>{try{c.bbox=Z([c["location.bounding_box.minimum_longitude"],c["location.bounding_box.minimum_latitude"],c["location.bounding_box.maximum_longitude"],c["location.bounding_box.maximum_latitude"]])}catch{c.bbox=null}c.index=f}),u.value=u.value.filter(c=>c.bbox),u.value=u.value.filter(c=>c["urls.latest"].length>0),u.value.sort((c,f)=>c["location.country_code"]<f["location.country_code"]?-1:c["location.country_code"]>f["location.country_code"]?1:0)});async function oe(){try{const c=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});c.ok||l.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const f=await c.arrayBuffer();return ge(f)}catch(c){l.changeAlert(c)}}function le(c){s.value?s.value=c:(s.value=c,X())}function X(){let c=null;if(s.value.style==="bbox"){const o=s.value.geometry;c=Z([o[1],o[0],o[3],o[2]])}else c=Fe([s.value.geometry]);i.value=u.value.filter(o=>ee(c,o.bbox)||Je(c,o.bbox)),i.value.forEach(o=>o.allInPolygon=ee(c,o.bbox));const f=new Set(i.value.map(o=>o.index));v.value=v.value.filter(o=>f.has(o))}function H(){if(L.value){r.setCallID();const o={files:i.value.filter(w=>v.value.includes(w.index)).map(w=>w["urls.latest"]),callID:O.value};D.value.forEach(w=>{o[w.name]=w.value}),r.startExecution(o)}else a.value=!0}function J(){l.initLinks(),a.value=!1,H()}return(c,f)=>(x(),T("div",Ye,[y(q,{class:"card"},{default:m(()=>[y($,{class:"subtitle"},{default:m(()=>[V(p(g(e)("GTFS importer")),1)]),_:1}),y(Ce,{onChange:le})]),_:1}),y(q,{class:"card2"},{default:m(()=>[y($,{class:"subtitle"},{default:m(()=>[V(p(g(e)("Available GTFS")),1)]),_:1}),y(Y,null,{default:m(()=>[V(p(g(e)("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),y(S,{disabled:b.value,"prepend-icon":"fa-solid fa-sync",onClick:X},{default:m(()=>[V(p(g(e)("fetch available GTFS")),1)]),_:1},8,["disabled"]),y(S,{loading:b.value,disabled:b.value||v.value.length===0,color:b.value||v.value.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:H},{default:m(()=>[V(p(g(e)("Download")),1)]),_:1},8,["loading","disabled","color"]),y(Y,null,{default:m(()=>[P.value?(x(),A(Pe,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:m(()=>[V(p(g(e)("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(x(!0),T(N,null,U(Object.keys(F.value),o=>(x(),T("p",{key:o},[h("b",null,p(o)+": ",1),V(p(F.value[o]),1)]))),128))]),_:1})):we("",!0)]),_:1}),h("div",Qe,[(x(!0),T(N,null,U(D.value,(o,w)=>(x(),T("div",{key:w,class:"params"},[typeof o.items>"u"?(x(),A(xe,{key:0,modelValue:o.value,"onUpdate:modelValue":I=>o.value=I,step:"1",type:o.type,label:g(e)(o.text),suffix:o.units,variant:"underlined",hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(I=>R[I]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(x(),A(Ve,{key:1,modelValue:o.value,"onUpdate:modelValue":I=>o.value=I,variant:"underlined",type:o.type,items:o.items,label:g(e)(o.text),suffix:o.units,hint:d.value?g(e)(o.hint):"","persistent-hint":d.value,rules:o.rules.map(I=>R[I]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",Ze,[h("ul",je,[h("span",et,[y(Le,{disabled:!0})]),f[4]||(f[4]=h("span",{class:"list-item-small"},"All in polygon",-1)),f[5]||(f[5]=h("span",{class:"list-item-small"},"Code",-1)),f[6]||(f[6]=h("span",{class:"list-item-medium"},"Name",-1)),f[7]||(f[7]=h("span",{class:"list-item-medium"},"City",-1)),f[8]||(f[8]=h("span",{class:"list-item-large"},"Agency",-1)),f[9]||(f[9]=h("span",{class:"list-item-small"},".zip",-1))]),(x(!0),T(N,null,U(i.value,(o,w)=>(x(),T("ul",{key:o.index,class:"list-row"},[h("span",tt,[y(Ie,{modelValue:v.value,"onUpdate:modelValue":f[0]||(f[0]=I=>v.value=I),value:o.index,label:String(w)},null,8,["modelValue","value","label"])]),h("span",rt,p(o.allInPolygon),1),h("span",at,p(o["location.country_code"]),1),h("span",nt,p(o["location.subdivision_name"]),1),h("span",st,p(o["location.municipality"]),1),h("span",ot,p(o.provider),1),y(S,{variant:"text",icon:"fa-solid fa-download",size:"small",href:o["urls.latest"],style:{color:"white"}},null,8,["href"])]))),128))])]),_:1}),y(Te,{modelValue:a.value,"onUpdate:modelValue":f[2]||(f[2]=o=>a.value=o),persistent:"","max-width":"500",onKeydown:[Q(J,["enter"]),f[3]||(f[3]=Q(o=>a.value=!1,["esc"]))]},{default:m(()=>[y(q,null,{default:m(()=>[y($,{class:"text-h5"},{default:m(()=>[V(p(g(e)("Overwrite current PT network ?")),1)]),_:1}),y(ke,null,{default:m(()=>[y(Me),y(S,{color:"regular",onClick:f[1]||(f[1]=o=>a.value=!a.value)},{default:m(()=>[V(p(g(e)("No")),1)]),_:1}),y(S,{color:"primary",onClick:J},{default:m(()=>[V(p(g(e)("Yes")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},ft=de(lt,[["__scopeId","data-v-9c33a449"]]);export{ft as default};
