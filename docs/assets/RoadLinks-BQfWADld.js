import{b8 as te,u as le,a7 as re,t as ne,p as se,o as ue,e as i,aL as q,r as c,w as O,g as z,q as Z,j as y,ao as v,c as M,d as ie,i as x,v as ce,D as de,F as ve,E as fe,h as ye,J as me,G as ge,x as pe,y as he,b9 as be,n as ke}from"./index-BbyupCHu.js";const Le={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(k,{emit:T}){const{$gettext:N}=te(),J=k,p=T,C=le(),r=re(),{map:o,isRoadMode:d}=ne(J);se(()=>{o.value.on("dragend",f),o.value.on("zoomend",f),o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("staticrLinks","links"))}),ue(()=>{o.value.removeLayer("arrow-rlinks")});const j=i(()=>C.roadsPopupContent),U=i(()=>r.selectedrGroup),_=i(()=>r.visiblerLinks),W=i(()=>r.renderedrLinks),K=i(()=>r.renderedrNodes),R=i(()=>C.anchorMode),Q=q,X=i(()=>R.value?r.anchorrNodes:q),h=c(null),a=c(null),E=c(!1),F=c(100),m=c(10),w=i(()=>m.value>u.value.rendered+1?2:m.value>u.value.rendered?1+(m.value-u.value.rendered):1),u=c({links:4,rendered:14}),n=c({coordinates:[0,0],showed:!1,actions:[],feature:null});O(U,()=>{F.value=100,f()}),O(d,e=>{e?(o.value.on("dragend",f),o.value.on("zoomend",f),f()):(o.value.off("dragend",f),o.value.off("zoomend",f),r.setRenderedrLinks({method:"None"}),o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(_.value))});async function f(){if(m.value=o.value.getZoom(),m.value>u.value.rendered){const e=o.value.getBounds();r.getRenderedrLinks({bbox:[e._sw.lng,e._sw.lat,e._ne.lng,e._ne.lat]}),o.value.setLayoutProperty("staticrLinks","visibility","none")}else m.value>u.value.links&&F.value>u.value.rendered&&(await o.value.setLayoutProperty("staticrLinks","visibility","visible"),o.value.getSource("staticrLinks").setData(_.value),r.setRenderedrLinks({method:"None"}));F.value=m.value}const S=c(!1),$=c(!1),s=c("");function L(e){var t;if(d.value&&((t=h.value)!=null&&t.isOpen()&&h.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!E.value&&j.value.length>0){const g=e.mapboxEvent.features[0];if(g.layer.id!=="rnodes"){let b=j.value.map(G=>`${G}: <b>${g.properties[G]}</b>`);b=b.join("<br> "),h.value=new ke.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(b).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",a.value!==null&&o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const l=[...new Set(e.mapboxEvent.features.map(g=>g.id))];a.value={layerId:e.layerId,id:l},o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),p("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function I(e){var t,l;d.value&&((t=h.value)!=null&&t.isOpen()&&h.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((l=a.value)==null?void 0:l.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(S.value?$.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,p("offHover",e)))))}function B(e){if(d.value&&a.value!==null&&(s.value=a.value.id,s.value!==null&&a.value.layerId==="rlinks")){const t=R.value?"anchorrNodes":"rnodes";r.addRoadNodeInline({selectedIndex:s.value,lngLat:e.mapboxEvent.lngLat,nodes:t})}}function Y(e){d.value&&a.value.layerId==="rlinks"&&(n.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat],n.value.showed=!0,n.value.feature=a.value.id,n.value.actions=[N("Edit rLink Info"),N("Delete rLink")])}function ee(e){e.action==="Delete rLink"?(r.deleterLink({selectedIndex:e.feature}),p("clickFeature",{action:"Delete rLink"})):p("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),n.value.showed=!1,n.value.type=null}function D(e){var t,l;if(d.value){const g=o.value.querySourceFeatures(a.value.layerId);s.value=g.filter(b=>a.value.id.includes(b.id)),s.value.length>0&&(((t=a.value)==null?void 0:t.layerId)==="rnodes"?p("clickFeature",{selectedFeature:s.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((l=a.value)==null?void 0:l.layerId)==="anchorrNodes"&&r.deleteAnchorrNode({selectedNode:s.value[0].properties}))}}function P(e){if(d.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",S.value=!0;const t=o.value.querySourceFeatures(a.value.layerId);s.value=t.filter(l=>l.id===a.value.id[0])[0],E.value=!0,a.value.layerId==="rnodes"&&r.getConnectedLinks({selectedNode:s.value}),o.value.on("mousemove",A),o.value.on("mouseup",H)}}function A(e){$.value&&s.value&&(p("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?r.moverAnchor({selectedNode:s.value,lngLat:Object.values(e.lngLat)}):r.moverNode({selectedNode:s.value,lngLat:Object.values(e.lngLat)}))}function H(){d.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",A),S.value=!1,$.value=!1,E.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,o.value.off("mouseup",H))}const V=i(()=>C.cyclewayMode),oe=i(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],t=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return V.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],t]:["*",e,t]}),ae=i(()=>V.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,t)=>(z(),Z("section",null,[y(v(M),{"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:_.value,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:u.value.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",k.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*w.value,w.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:L,onMouseleave:I},null,8,["source","layer"]),y(v(M),{"source-id":"rlinks",source:{type:"geojson",data:W.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:u.value.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",k.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*w.value,w.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:L,onMouseleave:I,onClick:B,onContextmenu:Y},null,8,["source","layer"]),y(v(ie),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:u.value.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":oe.value,"icon-rotate":ae.value},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),y(v(M),{"source-id":"rnodes",source:{type:"geojson",data:K.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:u.value.rendered,paint:{"circle-color":["case",["boolean",k.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:L,onMouseleave:I,onMousedown:P,onContextmenu:D},null,8,["source","layer"]),y(v(M),{"source-id":"anchorrNodes",source:{type:"geojson",data:v(d)?X.value:v(Q),buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:u.value.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:B,onMouseover:L,onMouseleave:I,onMousedown:P,onContextmenu:D},null,8,["source","layer"]),y(v(be),{"close-button":!1,showed:n.value.showed,coordinates:n.value.coordinates,onClose:t[1]||(t[1]=l=>n.value.showed=!1)},{default:x(()=>[ce("span",{onMouseleave:t[0]||(t[0]=l=>n.value.showed=!1)},[y(de,{density:"compact"},{default:x(()=>[(z(!0),Z(ve,null,fe(n.value.actions,l=>(z(),ye(me,{key:l.id},{default:x(()=>[y(ge,{variant:"outlined",size:"small",onClick:g=>ee({action:l,feature:n.value.feature,coordinates:n.value.coordinates})},{default:x(()=>[pe(he(v(N)(l)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])]))}};export{Le as default};
