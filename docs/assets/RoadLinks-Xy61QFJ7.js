import{_ as ae,c as re,d as ne,aK as te,u as le,a4 as se,t as ie,a6 as ue,o as ce,e as d,aw as B,r as u,w as P,f as F,g as S,p as D,j as y,A as Z,aL as V,i as x,C as de,F as ve,I as fe,E as me,v as ye,s as ge,h as he,D as ke,q as be,m as we}from"./index-gvht7mQ-.js";import{a as pe,b as Me}from"./index-0RCUFZHI.js";const G=n=>n,Le={name:"StaticLinks",components:{MglGeojsonLayer:re,MglImageLayer:ne,MglPopup:te},props:["map","isEditorMode","isRoadMode"],events:["clickFeature"],setup(n,t){const g=le(),e=se(),{map:r,isEditorMode:p,isRoadMode:s}=ie(n);ue(()=>{r.value.on("dragend",v),r.value.on("zoomend",v)}),ce(()=>{r.value.removeLayer("arrow-rlinks")});const b=d(()=>g.roadsPopupContent),M=d(()=>e.selectedrGroup),f=d(()=>g.cyclewayMode),R=d(()=>e.visiblerNodes),H=d(()=>e.visiblerLinks),q=d(()=>e.renderedrLinks),O=d(()=>e.renderedrNodes),_=d(()=>g.anchorMode),W=B,T=d(()=>_.value?e.anchorrNodes:B),h=u(null),a=u(null),K=u({}),U=u({}),L=u(!1),C=u(1),E=u({links:2,rendered:14}),m=u({coordinates:[0,0],showed:!1,actions:[],feature:null});P(M,()=>{v()}),P(s,o=>{o?(r.value.on("dragend",v),r.value.on("zoomend",v)):(r.value.off("dragend",v),r.value.off("zoomend",v))});function v(){const o=r.value.getBounds(),l=pe(Me([o._sw.lng,o._sw.lat,o._ne.lng,o._ne.lat]),.2);r.value.getZoom()>E.value.rendered?(C.value=2,e.getRenderedrLinks({bbox:l})):r.value.getZoom()>E.value.links?(C.value=1,e.setRenderedrLinks({method:"visible"})):(C.value=1,e.setRenderedrLinks({method:"None"}))}const I=u(!1),N=u(!1),i=u("");function J(o){var l;if(s.value&&((l=h.value)!=null&&l.isOpen()&&h.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!L.value&&b.value.length>0){const k=o.mapboxEvent.features[0];if(k.layer.id!=="rnodes"){let w=b.value.map(A=>`${A}: <b>${k.properties[A]}</b>`);w=w.join("<br> "),h.value=new we.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(w).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const c=[...new Set(o.mapboxEvent.features.map(k=>k.id))];a.value={layerId:o.layerId,id:c},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),t.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function Q(o){var l,c;s.value&&((l=h.value)!=null&&l.isOpen()&&h.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((c=a.value)==null?void 0:c.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(I.value?N.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,t.emit("offHover",o)))))}function X(o){if(s.value&&a.value!==null&&(i.value=a.value.id,i.value!==null&&a.value.layerId==="rlinks")){const l=_.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:i.value,lngLat:o.mapboxEvent.lngLat,nodes:l})}}function Y(o){s.value&&a.value.layerId==="rlinks"&&(m.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],m.value.showed=!0,m.value.feature=a.value.id,m.value.actions=[G("Edit rLink Info"),G("Delete rLink")])}function $(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),t.emit("clickFeature",{action:"Delete rLink"})):t.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),m.value.showed=!1,m.value.type=null}function ee(o){var l,c;if(s.value){const k=r.value.querySourceFeatures(a.value.layerId);i.value=k.filter(w=>a.value.id.includes(w.id)),i.value.length>0&&(((l=a.value)==null?void 0:l.layerId)==="rnodes"?t.emit("clickFeature",{selectedFeature:i.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((c=a.value)==null?void 0:c.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:i.value[0].properties}))}}function oe(o){if(s.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",I.value=!0;const l=r.value.querySourceFeatures(a.value.layerId);i.value=l.filter(c=>c.id===a.value.id[0])[0],L.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:i.value}),r.value.on("mousemove",j),r.value.on("mouseup",z)}}function j(o){N.value&&i.value&&(t.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:i.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:i.value,lngLat:Object.values(o.lngLat)}))}function z(o){s.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",j),I.value=!1,N.value=!1,L.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",z))}return{store:g,rlinksStore:e,anchorMode:_,map:r,isEditorMode:p,isRoadMode:s,keepHovering:I,dragNode:N,selectedPopupContent:b,selectedrGroup:M,cyclewayMode:f,rlinks:H,rnodes:R,renderedrLinks:q,renderedrNodes:O,renderedAnchorrNodes:T,header:W,popup:h,hoveredStateId:a,visibleNodes:K,visibleLinks:U,disablePopup:L,routeWidth:C,minZoom:E,contextMenu:m,getBounds:v,onCursor:J,offCursor:Q,selectClick:X,linkRightClick:Y,actionClick:$,contextMenuNode:ee,moveNode:oe}},computed:{ArrowSizeCondition(){const n=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],t=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],n,.25]],0],t]:["*",n,t]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function Ce(n,t,g,e,r,p){const s=F("MglGeojsonLayer"),b=F("MglImageLayer"),M=F("MglPopup");return S(),D("section",null,[y(s,Z({"source-id":"rlinks",source:{type:"geojson",data:e.isRoadMode?e.renderedrLinks:e.rlinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{interactive:!0,type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",e.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.routeWidth,e.routeWidth],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}}},V(e.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,click:e.selectClick,contextmenu:e.linkRightClick})),null,16,["source","layer"]),y(b,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":p.ArrowSizeCondition,"icon-rotate":p.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],n.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),y(s,Z({"source-id":"rnodes",source:{type:"geojson",data:e.isRoadMode?e.renderedrNodes:e.rnodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",e.isEditorMode,!1],n.$vuetify.theme.current.colors.mediumgrey,n.$vuetify.theme.current.colors.accent],"circle-stroke-color":n.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}}},V(e.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,mousedown:e.moveNode,contextmenu:e.contextMenuNode})),null,16,["source","layer"]),y(s,{"source-id":"anchorrNodes",source:{type:"geojson",data:e.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":n.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:e.selectClick,onMouseover:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onClick","onMouseover","onMouseleave","onMousedown","onContextmenu"]),y(M,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:t[1]||(t[1]=f=>e.contextMenu.showed=!1)},{default:x(()=>[be("span",{onMouseleave:t[0]||(t[0]=f=>e.contextMenu.showed=!1)},[y(de,{density:"compact"},{default:x(()=>[(S(!0),D(ve,null,ke(e.contextMenu.actions,f=>(S(),he(fe,{key:f.id},{default:x(()=>[y(me,{variant:"outlined",size:"small",onClick:R=>e.actionClick({action:f,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:x(()=>[ge(ye(n.$gettext(f)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const xe=ae(Le,[["render",Ce]]);export{xe as default};
