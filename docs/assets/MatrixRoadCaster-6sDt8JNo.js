import{an as E,u as L,bR as W,c as l,r as g,ac as Y,a as C,d as H,h as K,g as J,i,j as r,m as d,a9 as Q,D as M,L as S,B as V,C as b,W as O,ai as X,a3 as ee,A as te,a8 as ae,R as ne,Q as oe,aE as y,ao as le,_ as se}from"./index-DxwmzM9S.js";import{W as re}from"./Warning-Dv5KDkrc.js";import{S as ue}from"./SimpleForm-DSALCkks.js";import{M as ie}from"./Markdown-B0YBaQ1R.js";import{g as de}from"./form-B2uRhppC.js";const ce={class:"zone-row"},me=E({__name:"MatrixRoadCaster",setup(pe){const{$gettext:u}=L(),n=W(),_=l(()=>n.running),R=l(()=>n.error),T=l(()=>n.errorMessage),k=l(()=>n.bucket),p=l(()=>n.callID),D=l(()=>n.timer),A=l(()=>n.status),c=l(()=>n.parameters),w=g(n.zoneFile),f=Y(),I=C(),U=l(()=>I.otherFiles.filter(t=>t.extension==="geojson").map(t=>t.name)),x=l(()=>c.value.use_zone),m=g([{key:"api",label:"Api",value:"google",type:"select",hint:"api to use",items:["google","here"],rules:[]},{key:"use_zone",label:"Use zone",value:!1,type:"boolean",units:"",hint:"use zone",rules:[]},{key:"num_zones",label:"number of zones",value:null,type:"number",disabled:!1,units:"",hint:"number of zones. road nodes will be aggregate to form centroids",rules:["required","largerThanZero"]},{key:"train_size",label:"number of OD (api call)",value:null,type:"number",units:"",hint:"number of OD to get from the API, the rest will be interpolated with ML",rules:["required","largerThanZero"]},{key:"date_time",label:"date Time",value:null,type:"string",units:"",hint:"HERE DateTime in the past. (YYYY-MM-DDTHH:MM:SS(UTC-timezone) (-04:00 for montreal)). Google: datetime in the future. The timezone is not used here (local timezone used)",rules:["required",$,B]},{key:"ff_time_col",label:"freeflow time on roads",value:null,items:f.rlineAttributes,type:"select",units:"",hint:"road links time (link length / speed) to use as a first approximation. this is the freeflow speed, or speed limit",rules:["required"]},{key:"max_speed",label:"max speed on road",value:null,type:"number",units:"",hint:"Maximum allowed speed on a road. applying an OD matrix on the road network could result il unrealistic speed if not used.",rules:["required","largerThanZero"]},{key:"num_random_od",label:"number of OD to plot",value:null,type:"number",units:"",hint:"number of OD calibration plot to produce. those are random OD.",rules:["required","largerThanZero"]},{key:"hereApiKey",label:"api key",value:null,type:"string",units:"",hint:"Google or Here api key to download a set of OD",rules:["required"]}]);H(()=>{m.value.forEach(t=>t.value=c.value[t.key])});function h(t){n.saveParam(t),m.value.filter(a=>a.key==="num_zones")[0].disabled=x.value}function j(){const t=c.value.num_zones,a=c.value.train_size,e=c.value.num_random_od;n.timer=Math.min(t,a)*1.8+f.rlinks.features.length*.002+15,n.timer+=10*e}async function F(){try{if(await y.putObject(k.value,p.value.concat("/road_links.geojson"),JSON.stringify(f.rlinks)),await y.putObject(k.value,p.value.concat("/road_nodes.geojson"),JSON.stringify(f.rnodes)),x.value){const t=C(),a=le(),e=w.value,s=t.otherFiles.filter(o=>o.name===e)[0];s.content==null&&a.model!==null&&(s.content=await y.readBytes(a.model,a.scenario+"/"+s.path)),await y.putObject(k.value,p.value.concat("/zones.geojson"),s.content)}}catch(t){C().changeAlert(t)}}const z=g();async function N(){if(!await z.value.validate())return;n.setCallID(),n.running=!0,n.saveParams(m.value),j(),await F();const a={callID:p.value,...c.value};n.start(a)}function P(){n.stopExecution()}const Z=l(()=>c.value.api==="google"),q=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;function $(t){return q.test(t)||u("invalid date time")}function B(t){return Z.value&&Date.parse(t)>Date.now()||u("datetime must be in the future")}const v=g(!1),G=u(`
# ML Matrix Road Caster
  1) Find n zones centroids using a Kmean clustering on the nodes or use your own zoning.
  2) Call the Google or Here Matrix API on random OD ( around 1% is sufficient )
  3) Interpolate every other OD time with an hybrid Machine learning model
  4) ajust the speed on the road network to match the routing time with the OD time using an iterative algorithm') 
`);return(t,a)=>(J(),K(oe,{class:"card"},{default:i(()=>[r(ie,{source:d(G)},null,8,["source"]),r(re,{show:R.value,messages:T.value},null,8,["show","messages"]),r(ue,{ref_key:"formRef",ref:z,modelValue:m.value,"onUpdate:modelValue":a[3]||(a[3]=e=>m.value=e),onChange:h},{use_zone:i(({item:e,showHint:s})=>[te("div",ce,[r(ae,{modelValue:e.value,"onUpdate:modelValue":o=>e.value=o,class:"pr-2",color:"primary",variant:"underlined",label:d(u)(e.label),hint:s?e.hint:"","persistent-hint":s,onChange:o=>h(e)},null,8,["modelValue","onUpdate:modelValue","label","hint","persistent-hint","onChange"]),r(ne,{modelValue:w.value,"onUpdate:modelValue":a[0]||(a[0]=o=>w.value=o),items:U.value,disabled:!x.value,onChange:o=>h(e)},null,8,["modelValue","items","disabled","onChange"])])]),hereApiKey:i(({item:e,showHint:s})=>[r(ee,{modelValue:e.value,"onUpdate:modelValue":o=>e.value=o,type:v.value?"text":"password","append-icon":v.value?"fas fa-eye":"fas fa-eye-slash",label:d(u)(e.label),suffix:e.units,hint:s?e.hint:"","persistent-hint":s,rules:d(de)(e.rules),"onClick:append":a[1]||(a[1]=o=>v.value=!v.value),onChange:o=>h(e)},null,8,["modelValue","onUpdate:modelValue","type","append-icon","label","suffix","hint","persistent-hint","rules","onChange"])]),default:i(()=>[r(Q,null,{default:i(()=>[r(S,{variant:"outlined",color:"success",loading:_.value,onClick:N},{default:i(()=>[V(b(d(u)("Process")),1)]),_:1},8,["loading"]),M(r(S,{color:"grey",variant:"text",onClick:a[2]||(a[2]=e=>P())},{default:i(()=>[V(b(d(u)("Abort")),1)]),_:1},512),[[O,_.value&&A.value==="RUNNING"]]),M(r(X,null,{default:i(()=>[V(" ~ "+b(D.value>0?Math.ceil(D.value/60):d(u)("less than 1"))+b(d(u)(" minutes remaining")),1)]),_:1},512),[[O,_.value]])]),_:1})]),_:1},8,["modelValue"])]),_:1}))}}),ye=se(me,[["__scopeId","data-v-74754e5d"]]);export{ye as default};
