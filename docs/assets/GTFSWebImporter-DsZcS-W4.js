import{M as re,b as R}from"./Microservices-DMcFhqvE.js";import{c2 as Z,c3 as S,c4 as ae,aB as I,aE as ne,c5 as se,c6 as oe,c7 as M,c8 as A,b5 as ie,_ as le,aW as ue,a6 as ce,u as de,r as b,e as F,o as fe,aA as he,f as ve,g as p,q as T,j as d,i as v,ab as _,x as m,y as f,L as E,aR as W,G as C,h as O,an as ye,F as B,E as D,v as h,l as ge,Z as pe,N as me,aT as we,Q as be,a2 as Pe,a3 as Fe,a4 as H,a9 as Te,c9 as Se,ca as xe}from"./index-D1y_tDWo.js";function P(e,t,r){if(r===void 0&&(r={}),!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");var a=Z(e),o=S(t),n=o.type,i=t.bbox,s=o.coordinates;if(i&&Le(a,i)===!1)return!1;n==="Polygon"&&(s=[s]);for(var u=!1,l=0;l<s.length&&!u;l++)if(K(a,s[l][0],r.ignoreBoundary)){for(var c=!1,w=1;w<s[l].length&&!c;)K(a,s[l][w],!r.ignoreBoundary)&&(c=!0),w++;c||(u=!0)}return u}function K(e,t,r){var a=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var o=0,n=t.length-1;o<t.length;n=o++){var i=t[o][0],s=t[o][1],u=t[n][0],l=t[n][1],c=e[1]*(i-u)+s*(u-e[0])+l*(e[0]-i)===0&&(i-e[0])*(u-e[0])<=0&&(s-e[1])*(l-e[1])<=0;if(c)return!r;var w=s>e[1]!=l>e[1]&&e[0]<(u-i)*(e[1]-s)/(l-s)+i;w&&(a=!a)}return a}function Le(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}function L(e,t,r){r===void 0&&(r={});for(var a=Z(e),o=ae(t),n=0;n<o.length-1;n++){var i=!1;if(r.ignoreEndVertices&&(n===0&&(i="start"),n===o.length-2&&(i="end"),n===0&&n+1===o.length-1&&(i="both")),Ge(o[n],o[n+1],a,i,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Ge(e,t,r,a,o){var n=r[0],i=r[1],s=e[0],u=e[1],l=t[0],c=t[1],w=r[0]-s,V=r[1]-u,y=l-s,g=c-u,k=w*g-V*y;if(o!==null){if(Math.abs(k)>o)return!1}else if(k!==0)return!1;if(a){if(a==="start")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<=l:l<=n&&n<s:g>0?u<i&&i<=c:c<=i&&i<u;if(a==="end")return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<l:l<n&&n<=s:g>0?u<=i&&i<c:c<i&&i<=u;if(a==="both")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<l:l<n&&n<s:g>0?u<i&&i<c:c<i&&i<u}else return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<=l:l<=n&&n<=s:g>0?u<=i&&i<=c:c<=i&&i<=u;return!1}function X(e,t){var r=S(e),a=S(t),o=r.type,n=a.type,i=r.coordinates,s=a.coordinates;switch(o){case"Point":switch(n){case"Point":return N(i,s);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Ve(r,a);case"MultiPoint":return ke(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return L(a,r,{ignoreEndVertices:!0});case"LineString":return Me(r,a);case"MultiPoint":return Ce(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return P(a,r,{ignoreBoundary:!0});case"LineString":return _e(r,a);case"Polygon":return Ee(r,a);case"MultiPoint":return Ie(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+o+" geometry not supported")}}function Ve(e,t){var r,a=!1;for(r=0;r<e.coordinates.length;r++)if(N(e.coordinates[r],t.coordinates)){a=!0;break}return a}function ke(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){for(var o=a[r],n=!1,i=0,s=e.coordinates;i<s.length;i++){var u=s[i];if(N(o,u)){n=!0;break}}if(!n)return!1}return!0}function Ce(e,t){for(var r=!1,a=0,o=t.coordinates;a<o.length;a++){var n=o[a];if(L(n,e,{ignoreEndVertices:!0})&&(r=!0),!L(n,e))return!1}return!!r}function Ie(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var o=a[r];if(!P(o,e,{ignoreBoundary:!0}))return!1}return!0}function Me(e,t){for(var r=!1,a=0,o=t.coordinates;a<o.length;a++){var n=o[a];if(L({type:"Point",coordinates:n},e,{ignoreEndVertices:!0})&&(r=!0),!L({type:"Point",coordinates:n},e,{ignoreEndVertices:!1}))return!1}return r}function _e(e,t){var r=!1,a=0,o=I(e),n=I(t);if(!z(o,n))return!1;for(a;a<t.coordinates.length-1;a++){var i=Oe(t.coordinates[a],t.coordinates[a+1]);if(P({type:"Point",coordinates:i},e,{ignoreBoundary:!0})){r=!0;break}}return r}function Ee(e,t){if(e.type==="Feature"&&e.geometry===null||t.type==="Feature"&&t.geometry===null)return!1;var r=I(e),a=I(t);if(!z(r,a))return!1;for(var o=S(t).coordinates,n=0,i=o;n<i.length;n++)for(var s=i[n],u=0,l=s;u<l.length;u++){var c=l[u];if(!P(c,e))return!1}return!0}function z(e,t){return!(e[0]>t[0]||e[2]<t[2]||e[1]>t[1]||e[3]<t[3])}function N(e,t){return e[0]===t[0]&&e[1]===t[1]}function Oe(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}function q(e,t){t===void 0&&(t={});var r=S(e);switch(!t.properties&&e.type==="Feature"&&(t.properties=e.properties),r.type){case"Polygon":return Be(r,t);case"MultiPolygon":return De(r,t);default:throw new Error("invalid poly")}}function Be(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,o=t.properties?t.properties:e.type==="Feature"?e.properties:{};return $(a,o)}function De(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,o=t.properties?t.properties:e.type==="Feature"?e.properties:{},n=[];return a.forEach(function(i){n.push($(i,o))}),ne(n)}function $(e,t){return e.length>1?se(e,t):oe(e[0],t)}function qe(e,t){var r=!0;return M(e,function(a){M(t,function(o){if(r===!1)return!1;r=Ae(a.geometry,o.geometry)})}),r}function Ae(e,t){switch(e.type){case"Point":switch(t.type){case"Point":return!We(e.coordinates,t.coordinates);case"LineString":return!J(t,e);case"Polygon":return!P(e,t)}break;case"LineString":switch(t.type){case"Point":return!J(e,t);case"LineString":return!Ne(e,t);case"Polygon":return!Q(t,e)}break;case"Polygon":switch(t.type){case"Point":return!P(t,e);case"LineString":return!Q(e,t);case"Polygon":return!Ue(t,e)}}return!1}function J(e,t){for(var r=0;r<e.coordinates.length-1;r++)if(Re(e.coordinates[r],e.coordinates[r+1],t.coordinates))return!0;return!1}function Ne(e,t){var r=A(e,t);return r.features.length>0}function Q(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var o=a[r];if(P(o,e))return!0}var n=A(t,q(e));return n.features.length>0}function Ue(e,t){for(var r=0,a=e.coordinates[0];r<a.length;r++){var o=a[r];if(P(o,t))return!0}for(var n=0,i=t.coordinates[0];n<i.length;n++){var s=i[n];if(P(s,e))return!0}var u=A(q(e),q(t));return u.features.length>0}function Re(e,t,r){var a=r[0]-e[0],o=r[1]-e[1],n=t[0]-e[0],i=t[1]-e[1],s=a*i-o*n;return s!==0?!1:Math.abs(n)>=Math.abs(i)?n>0?e[0]<=r[0]&&r[0]<=t[0]:t[0]<=r[0]&&r[0]<=e[0]:i>0?e[1]<=r[1]&&r[1]<=t[1]:t[1]<=r[1]&&r[1]<=e[1]}function We(e,t){return e[0]===t[0]&&e[1]===t[1]}function He(e,t){var r=!1;return M(e,function(a){M(t,function(o){if(r===!0)return!0;r=!qe(a.geometry,o.geometry)})}),r}var Ke=function(e,t){if(e===null)throw new Error("No coordinates passed");for(var r=0;r<e.length;r++)for(var a=e[r],o=0;o<a[a.length-1].length;o++){if(a.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(a[a.length-1][o]!==a[0][o])throw new Error("First and last Position are not equivalent.")}var n={type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:t};return n.properties||(n.properties={}),n};const Xe=ie(Ke),Y=e=>e,Je={name:"GTFSWebImporter",components:{MapSelector:re},setup(){const e=ue(),t=ce(),r=de(),a=b(!1),o=b(null),n=b({}),i=b([]),s=b([]),u=b(!1),l=b(!1),c=b(e.selectedGTFS),w=F(()=>t.linksIsEmpty),V=F(()=>e.UploadedGTFS),y=F(()=>e.callID),g=F(()=>e.running),k=F(()=>e.error),j=F(()=>e.errorMessage),ee=F(()=>V.value.filter(x=>x.progress<100).length>0);fe(()=>{e.saveParams(U.value),e.saveSelectedGTFS(c.value)});const U=b([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"String",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"String",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),te=/^(0?[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return{showOverwriteDialog:a,poly:o,runGTFS:e,store:r,nodes:n,gtfsList:i,availableGTFS:s,selectedGTFS:c,checkall:u,showHint:l,parameters:U,rules:{required:x=>!!x||Y("Required"),timeRule:x=>te.test(x)||Y("invalid date time")},linksIsEmpty:w,UploadedGTFS:V,callID:y,running:g,error:k,errorMessage:j,isUploading:ee}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,t)=>{try{e.bbox=R([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=t}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,t)=>e["location.country_code"]<t["location.country_code"]?-1:e["location.country_code"]>t["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const t=await e.arrayBuffer();return he(t)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const r=this.poly.geometry;e=R([r[1],r[0],r[3],r[2]])}else e=Xe([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(r=>X(e,r.bbox)||He(e,r.bbox)),this.availableGTFS.forEach(r=>r.allInPolygon=X(e,r.bbox));const t=new Set(this.availableGTFS.map(r=>r.index));this.selectedGTFS=this.selectedGTFS.filter(r=>t.has(r))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const r={files:this.availableGTFS.filter(a=>this.selectedGTFS.includes(a.index)).map(a=>a["urls.latest"])};this.parameters.forEach(a=>{r[a.name]=a.value}),this.runGTFS.startExecution(r)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},G=e=>(Se("data-v-74086045"),e=e(),xe(),e),Qe={class:"background"},Ye={class:"params-row"},Ze={class:"list"},ze={class:"list-row"},$e={class:"list-item-small"},je=G(()=>h("span",{class:"list-item-small"},"All in polygon",-1)),et=G(()=>h("span",{class:"list-item-small"},"Code",-1)),tt=G(()=>h("span",{class:"list-item-medium"},"Name",-1)),rt=G(()=>h("span",{class:"list-item-large"},"City",-1)),at=G(()=>h("span",{class:"list-item-large"},"Agency",-1)),nt={class:"list-item-small"},st={class:"list-item-small"},ot={class:"list-item-small"},it={class:"list-item-medium"},lt={class:"list-item-large"},ut={class:"list-item-large"};function ct(e,t,r,a,o,n){const i=ve("MapSelector");return p(),T("div",Qe,[d(E,{class:"card"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("GTFS importer")),1)]),_:1}),d(i,{onChange:n.getBBOX},null,8,["onChange"])]),_:1}),d(E,{class:"card2"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("Available GTFS")),1)]),_:1}),d(W,null,{default:v(()=>[m(f(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),d(C,{disabled:a.running,"prepend-icon":"fa-solid fa-sync",onClick:n.getAvaileGTFS},{default:v(()=>[m(f(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),d(C,{loading:a.running,disabled:a.running||a.selectedGTFS.length===0,color:a.running||a.selectedGTFS.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:n.importGTFS},{default:v(()=>[m(f(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","color","onClick"]),d(W,null,{default:v(()=>[a.error?(p(),O(ye,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:v(()=>[m(f(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(p(!0),T(B,null,D(Object.keys(a.errorMessage),s=>(p(),T("p",{key:s},[h("b",null,f(s)+": ",1),m(f(a.errorMessage[s]),1)]))),128))]),_:1})):ge("",!0)]),_:1}),h("div",Ye,[(p(!0),T(B,null,D(a.parameters,(s,u)=>(p(),T("div",{key:u,class:"params"},[typeof s.items>"u"?(p(),O(pe,{key:0,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,type:s.type,label:e.$gettext(s.text),suffix:s.units,variant:"underlined",hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(p(),O(me,{key:1,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,variant:"underlined",type:s.type,items:s.items,label:e.$gettext(s.text),suffix:s.units,hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",Ze,[h("ul",ze,[h("span",$e,[d(we,{disabled:!0})]),je,et,tt,rt,at]),(p(!0),T(B,null,D(a.availableGTFS,(s,u)=>(p(),T("ul",{key:s.index,class:"list-row"},[h("span",nt,[d(be,{modelValue:a.selectedGTFS,"onUpdate:modelValue":t[0]||(t[0]=l=>a.selectedGTFS=l),value:s.index,label:String(u)},null,8,["modelValue","value","label"])]),h("span",st,f(s.allInPolygon),1),h("span",ot,f(s["location.country_code"]),1),h("span",it,f(s["location.subdivision_name"]),1),h("span",lt,f(s["location.municipality"]),1),h("span",ut,f(s.provider),1)]))),128))])]),_:1}),d(Te,{modelValue:a.showOverwriteDialog,"onUpdate:modelValue":t[2]||(t[2]=s=>a.showOverwriteDialog=s),persistent:"","max-width":"500",onKeydown:[H(n.applyOverwriteDialog,["enter"]),t[3]||(t[3]=H(s=>a.showOverwriteDialog=!1,["esc"]))]},{default:v(()=>[d(E,null,{default:v(()=>[d(_,{class:"text-h5"},{default:v(()=>[m(f(e.$gettext("Overwrite current PT network ?")),1)]),_:1}),d(Pe,null,{default:v(()=>[d(Fe),d(C,{color:"regular",onClick:t[1]||(t[1]=s=>a.showOverwriteDialog=!a.showOverwriteDialog)},{default:v(()=>[m(f(e.$gettext("No")),1)]),_:1}),d(C,{color:"primary",onClick:n.applyOverwriteDialog},{default:v(()=>[m(f(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const vt=le(Je,[["render",ct],["__scopeId","data-v-74086045"]]);export{vt as default};
