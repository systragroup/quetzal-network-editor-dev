import{_ as $,c as ee,d as oe,aR as ae,u as re,a6 as ne,t as te,p as le,o as se,e as g,az as B,r as d,w as P,f as F,g as R,q as D,j as h,C as H,aS as Z,i as x,D as ue,F as ie,J as ce,G as de,y as ve,x as fe,h as me,E as ye,v as ge,m as he}from"./index-KxYlB9va.js";import{a as be,b as ke}from"./index-OtUW8uTq.js";const G=t=>t,we={name:"RoadLinks",components:{MglGeojsonLayer:ee,MglImageLayer:oe,MglPopup:ae},props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(t,l){const u=re(),e=ne(),{map:r,isRoadMode:i}=te(t);le(()=>{r.value.on("dragend",v),r.value.on("zoomend",v)}),se(()=>{r.value.removeLayer("arrow-rlinks")});const f=g(()=>u.roadsPopupContent),M=g(()=>e.selectedrGroup),N=g(()=>u.cyclewayMode),m=g(()=>e.renderedrLinks),S=g(()=>e.renderedrNodes),_=g(()=>u.anchorMode),V=B,q=g(()=>_.value?e.anchorrNodes:B),b=d(null),a=d(null),O=d({}),W=d({}),L=d(!1),w=d(1),E=d({links:2,rendered:14}),y=d({coordinates:[0,0],showed:!1,actions:[],feature:null});P(M,()=>{v()}),P(i,o=>{o?(r.value.on("dragend",v),r.value.on("zoomend",v),v()):(r.value.off("dragend",v),r.value.off("zoomend",v),w.value=1,e.setRenderedrLinks({method:"visible"}))});function v(o){const n=r.value.getBounds(),c=be(ke([n._sw.lng,n._sw.lat,n._ne.lng,n._ne.lat]),.2);r.value.getZoom()>E.value.rendered?(w.value=2,e.getRenderedrLinks({bbox:c})):r.value.getZoom()>E.value.links?(w.value=1,e.setRenderedrLinks({method:"visible"})):(w.value=1,e.setRenderedrLinks({method:"None"}))}const C=d(!1),I=d(!1),s=d("");function T(o){var n;if(i.value&&((n=b.value)!=null&&n.isOpen()&&b.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!L.value&&f.value.length>0){const k=o.mapboxEvent.features[0];if(k.layer.id!=="rnodes"){let p=f.value.map(A=>`${A}: <b>${k.properties[A]}</b>`);p=p.join("<br> "),b.value=new he.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(p).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const c=[...new Set(o.mapboxEvent.features.map(k=>k.id))];a.value={layerId:o.layerId,id:c},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),l.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function J(o){var n,c;i.value&&((n=b.value)!=null&&n.isOpen()&&b.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((c=a.value)==null?void 0:c.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(C.value?I.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,l.emit("offHover",o)))))}function U(o){if(i.value&&a.value!==null&&(s.value=a.value.id,s.value!==null&&a.value.layerId==="rlinks")){const n=_.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:s.value,lngLat:o.mapboxEvent.lngLat,nodes:n})}}function K(o){i.value&&a.value.layerId==="rlinks"&&(y.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],y.value.showed=!0,y.value.feature=a.value.id,y.value.actions=[G("Edit rLink Info"),G("Delete rLink")])}function Q(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),l.emit("clickFeature",{action:"Delete rLink"})):l.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),y.value.showed=!1,y.value.type=null}function X(o){var n,c;if(i.value){const k=r.value.querySourceFeatures(a.value.layerId);s.value=k.filter(p=>a.value.id.includes(p.id)),s.value.length>0&&(((n=a.value)==null?void 0:n.layerId)==="rnodes"?l.emit("clickFeature",{selectedFeature:s.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((c=a.value)==null?void 0:c.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:s.value[0].properties}))}}function Y(o){if(i.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",C.value=!0;const n=r.value.querySourceFeatures(a.value.layerId);s.value=n.filter(c=>c.id===a.value.id[0])[0],L.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:s.value}),r.value.on("mousemove",z),r.value.on("mouseup",j)}}function z(o){I.value&&s.value&&(l.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:s.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:s.value,lngLat:Object.values(o.lngLat)}))}function j(o){i.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",z),C.value=!1,I.value=!1,L.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",j))}return{store:u,rlinksStore:e,anchorMode:_,keepHovering:C,dragNode:I,selectedPopupContent:f,selectedrGroup:M,cyclewayMode:N,renderedrLinks:m,renderedrNodes:S,renderedAnchorrNodes:q,header:V,popup:b,hoveredStateId:a,visibleNodes:O,visibleLinks:W,disablePopup:L,routeWidth:w,minZoom:E,contextMenu:y,getBounds:v,onCursor:T,offCursor:J,selectClick:U,linkRightClick:K,actionClick:Q,contextMenuNode:X,moveNode:Y}},computed:{ArrowSizeCondition(){const t=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],l=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],t,.25]],0],l]:["*",t,l]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function pe(t,l,u,e,r,i){const f=F("MglGeojsonLayer"),M=F("MglImageLayer"),N=F("MglPopup");return R(),D("section",null,[h(f,H({"source-id":"rlinks",source:{type:"geojson",data:e.renderedrLinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",u.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.routeWidth,e.routeWidth],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}}},Z(u.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,click:e.selectClick,contextmenu:e.linkRightClick})),null,16,["source","layer"]),h(M,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":i.ArrowSizeCondition,"icon-rotate":i.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),h(f,H({"source-id":"rnodes",source:{type:"geojson",data:e.renderedrNodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",u.isEditorMode,!1],t.$vuetify.theme.current.colors.mediumgrey,t.$vuetify.theme.current.colors.accent],"circle-stroke-color":t.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}}},Z(u.isEditorMode?{}:{mouseenter:e.onCursor,mouseleave:e.offCursor,mousedown:e.moveNode,contextmenu:e.contextMenuNode})),null,16,["source","layer"]),h(f,{"source-id":"anchorrNodes",source:{type:"geojson",data:u.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":t.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:e.selectClick,onMouseover:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onClick","onMouseover","onMouseleave","onMousedown","onContextmenu"]),h(N,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:l[1]||(l[1]=m=>e.contextMenu.showed=!1)},{default:x(()=>[ge("span",{onMouseleave:l[0]||(l[0]=m=>e.contextMenu.showed=!1)},[h(ue,{density:"compact"},{default:x(()=>[(R(!0),D(ie,null,ye(e.contextMenu.actions,m=>(R(),me(ce,{key:m.id},{default:x(()=>[h(de,{variant:"outlined",size:"small",onClick:S=>e.actionClick({action:m,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:x(()=>[fe(ve(t.$gettext(m)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const Ce=$(we,[["render",pe]]);export{Ce as default};
