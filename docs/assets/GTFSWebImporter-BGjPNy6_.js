import{M as ee,b as K}from"./Microservices-L2SvP4CQ.js";import{bM as Y,bN as S,bO as te,aK as I,aN as re,bP as ae,bQ as se,bR as M,bS as N,_ as ne,a_ as oe,b as ie,a as le,r as w,c as T,a9 as ue,aJ as ce,Q as de,d as p,e as F,g as d,h as v,Z as _,s as m,t as f,J as O,aX as W,V as k,z as B,ay as fe,F as D,B as E,f as h,A as he,y as ve,x as ye,G as ge,N as pe,a2 as me,k as be,Y as H,ak as we,bT as Pe,bU as Te}from"./index-Tpk785Lp.js";import{P as Fe}from"./index-HsnOawJQ.js";import"./main-C0uRBFu0.js";function P(e,t,r){if(r===void 0&&(r={}),!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");var a=Y(e),i=S(t),s=i.type,o=t.bbox,n=i.coordinates;if(o&&Se(a,o)===!1)return!1;s==="Polygon"&&(n=[n]);for(var u=!1,l=0;l<n.length&&!u;l++)if(J(a,n[l][0],r.ignoreBoundary)){for(var c=!1,b=1;b<n[l].length&&!c;)J(a,n[l][b],!r.ignoreBoundary)&&(c=!0),b++;c||(u=!0)}return u}function J(e,t,r){var a=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var i=0,s=t.length-1;i<t.length;s=i++){var o=t[i][0],n=t[i][1],u=t[s][0],l=t[s][1],c=e[1]*(o-u)+n*(u-e[0])+l*(e[0]-o)===0&&(o-e[0])*(u-e[0])<=0&&(n-e[1])*(l-e[1])<=0;if(c)return!r;var b=n>e[1]!=l>e[1]&&e[0]<(u-o)*(e[1]-n)/(l-n)+o;b&&(a=!a)}return a}function Se(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}function x(e,t,r){r===void 0&&(r={});for(var a=Y(e),i=te(t),s=0;s<i.length-1;s++){var o=!1;if(r.ignoreEndVertices&&(s===0&&(o="start"),s===i.length-2&&(o="end"),s===0&&s+1===i.length-1&&(o="both")),xe(i[s],i[s+1],a,o,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function xe(e,t,r,a,i){var s=r[0],o=r[1],n=e[0],u=e[1],l=t[0],c=t[1],b=r[0]-n,L=r[1]-u,y=l-n,g=c-u,V=b*g-L*y;if(i!==null){if(Math.abs(V)>i)return!1}else if(V!==0)return!1;if(a){if(a==="start")return Math.abs(y)>=Math.abs(g)?y>0?n<s&&s<=l:l<=s&&s<n:g>0?u<o&&o<=c:c<=o&&o<u;if(a==="end")return Math.abs(y)>=Math.abs(g)?y>0?n<=s&&s<l:l<s&&s<=n:g>0?u<=o&&o<c:c<o&&o<=u;if(a==="both")return Math.abs(y)>=Math.abs(g)?y>0?n<s&&s<l:l<s&&s<n:g>0?u<o&&o<c:c<o&&o<u}else return Math.abs(y)>=Math.abs(g)?y>0?n<=s&&s<=l:l<=s&&s<=n:g>0?u<=o&&o<=c:c<=o&&o<=u;return!1}function R(e,t){var r=S(e),a=S(t),i=r.type,s=a.type,o=r.coordinates,n=a.coordinates;switch(i){case"Point":switch(s){case"Point":return U(o,n);default:throw new Error("feature2 "+s+" geometry not supported")}case"MultiPoint":switch(s){case"Point":return Ge(r,a);case"MultiPoint":return Le(r,a);default:throw new Error("feature2 "+s+" geometry not supported")}case"LineString":switch(s){case"Point":return x(a,r,{ignoreEndVertices:!0});case"LineString":return Ie(r,a);case"MultiPoint":return Ve(r,a);default:throw new Error("feature2 "+s+" geometry not supported")}case"Polygon":switch(s){case"Point":return P(a,r,{ignoreBoundary:!0});case"LineString":return Me(r,a);case"Polygon":return Ce(r,a);case"MultiPoint":return ke(r,a);default:throw new Error("feature2 "+s+" geometry not supported")}default:throw new Error("feature1 "+i+" geometry not supported")}}function Ge(e,t){var r,a=!1;for(r=0;r<e.coordinates.length;r++)if(U(e.coordinates[r],t.coordinates)){a=!0;break}return a}function Le(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){for(var i=a[r],s=!1,o=0,n=e.coordinates;o<n.length;o++){var u=n[o];if(U(i,u)){s=!0;break}}if(!s)return!1}return!0}function Ve(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var s=i[a];if(x(s,e,{ignoreEndVertices:!0})&&(r=!0),!x(s,e))return!1}return!!r}function ke(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(!P(i,e,{ignoreBoundary:!0}))return!1}return!0}function Ie(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var s=i[a];if(x({type:"Point",coordinates:s},e,{ignoreEndVertices:!0})&&(r=!0),!x({type:"Point",coordinates:s},e,{ignoreEndVertices:!1}))return!1}return r}function Me(e,t){var r=!1,a=0,i=I(e),s=I(t);if(!z(i,s))return!1;for(a;a<t.coordinates.length-1;a++){var o=_e(t.coordinates[a],t.coordinates[a+1]);if(P({type:"Point",coordinates:o},e,{ignoreBoundary:!0})){r=!0;break}}return r}function Ce(e,t){if(e.type==="Feature"&&e.geometry===null||t.type==="Feature"&&t.geometry===null)return!1;var r=I(e),a=I(t);if(!z(r,a))return!1;for(var i=S(t).coordinates,s=0,o=i;s<o.length;s++)for(var n=o[s],u=0,l=n;u<l.length;u++){var c=l[u];if(!P(c,e))return!1}return!0}function z(e,t){return!(e[0]>t[0]||e[2]<t[2]||e[1]>t[1]||e[3]<t[3])}function U(e,t){return e[0]===t[0]&&e[1]===t[1]}function _e(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}function A(e,t){t===void 0&&(t={});var r=S(e);switch(!t.properties&&e.type==="Feature"&&(t.properties=e.properties),r.type){case"Polygon":return Oe(r,t);case"MultiPolygon":return Be(r,t);default:throw new Error("invalid poly")}}function Oe(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{};return Z(a,i)}function Be(e,t){t===void 0&&(t={});var r=S(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{},s=[];return a.forEach(function(o){s.push(Z(o,i))}),re(s)}function Z(e,t){return e.length>1?ae(e,t):se(e[0],t)}function De(e,t){var r=!0;return M(e,function(a){M(t,function(i){if(r===!1)return!1;r=Ee(a.geometry,i.geometry)})}),r}function Ee(e,t){switch(e.type){case"Point":switch(t.type){case"Point":return!qe(e.coordinates,t.coordinates);case"LineString":return!X(t,e);case"Polygon":return!P(e,t)}break;case"LineString":switch(t.type){case"Point":return!X(e,t);case"LineString":return!Ae(e,t);case"Polygon":return!Q(t,e)}break;case"Polygon":switch(t.type){case"Point":return!P(t,e);case"LineString":return!Q(e,t);case"Polygon":return!Ne(t,e)}}return!1}function X(e,t){for(var r=0;r<e.coordinates.length-1;r++)if(Ue(e.coordinates[r],e.coordinates[r+1],t.coordinates))return!0;return!1}function Ae(e,t){var r=N(e,t);return r.features.length>0}function Q(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(P(i,e))return!0}var s=N(t,A(e));return s.features.length>0}function Ne(e,t){for(var r=0,a=e.coordinates[0];r<a.length;r++){var i=a[r];if(P(i,t))return!0}for(var s=0,o=t.coordinates[0];s<o.length;s++){var n=o[s];if(P(n,e))return!0}var u=N(A(e),A(t));return u.features.length>0}function Ue(e,t,r){var a=r[0]-e[0],i=r[1]-e[1],s=t[0]-e[0],o=t[1]-e[1],n=a*o-i*s;return n!==0?!1:Math.abs(s)>=Math.abs(o)?s>0?e[0]<=r[0]&&r[0]<=t[0]:t[0]<=r[0]&&r[0]<=e[0]:o>0?e[1]<=r[1]&&r[1]<=t[1]:t[1]<=r[1]&&r[1]<=e[1]}function qe(e,t){return e[0]===t[0]&&e[1]===t[1]}function Ke(e,t){var r=!1;return M(e,function(a){M(t,function(i){if(r===!0)return!0;r=!De(a.geometry,i.geometry)})}),r}const We=e=>e,He={name:"GTFSWebImporter",components:{MapSelector:ee},setup(){const e=oe(),t=ie(),r=le(),a=w(!1),i=w(null),s=w({}),o=w([]),n=w([]),u=w(!1),l=w(!1),c=w(e.selectedGTFS),b=T(()=>t.linksIsEmpty),L=T(()=>e.UploadedGTFS),y=T(()=>e.callID),g=T(()=>e.running),V=T(()=>e.error),j=T(()=>e.errorMessage),$=T(()=>L.value.filter(C=>C.progress<100).length>0);ue(()=>{e.saveParams(q.value),e.saveSelectedGTFS(c.value)});const q=w([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]);return{showOverwriteDialog:a,poly:i,runGTFS:e,store:r,nodes:s,gtfsList:o,availableGTFS:n,selectedGTFS:c,checkall:u,showHint:l,parameters:q,rules:{required:C=>!!C||We("Required")},linksIsEmpty:b,UploadedGTFS:L,callID:y,running:g,error:V,errorMessage:j,isUploading:$}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,t)=>{try{e.bbox=K([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=t}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,t)=>e["location.country_code"]<t["location.country_code"]?-1:e["location.country_code"]>t["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const t=await e.arrayBuffer();return ce(t)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const r=this.poly.geometry;e=K([r[1],r[0],r[3],r[2]])}else e=Fe([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(r=>R(e,r.bbox)||Ke(e,r.bbox)),this.availableGTFS.forEach(r=>r.allInPolygon=R(e,r.bbox));const t=new Set(this.availableGTFS.map(r=>r.index));this.selectedGTFS=this.selectedGTFS.filter(r=>t.has(r))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const r={files:this.availableGTFS.filter(a=>this.selectedGTFS.includes(a.index)).map(a=>a["urls.latest"])};this.parameters.forEach(a=>{r[a.name]=a.value}),this.runGTFS.startExecution(r)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},G=e=>(Pe("data-v-9dd377c2"),e=e(),Te(),e),Je={class:"background"},Re={class:"params-row"},Xe={class:"list"},Qe={class:"list-row"},Ye={class:"list-item-small"},ze=G(()=>h("span",{class:"list-item-small"},"All in polygon",-1)),Ze=G(()=>h("span",{class:"list-item-small"},"Code",-1)),je=G(()=>h("span",{class:"list-item-medium"},"Name",-1)),$e=G(()=>h("span",{class:"list-item-large"},"City",-1)),et=G(()=>h("span",{class:"list-item-large"},"Agency",-1)),tt={class:"list-item-small"},rt={class:"list-item-small"},at={class:"list-item-small"},st={class:"list-item-medium"},nt={class:"list-item-large"},ot={class:"list-item-large"};function it(e,t,r,a,i,s){const o=de("MapSelector");return p(),F("div",Je,[d(O,{class:"card"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("GTFS importer")),1)]),_:1}),d(o,{onChange:s.getBBOX},null,8,["onChange"])]),_:1}),d(O,{class:"card2"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("Available GTFS")),1)]),_:1}),d(W,null,{default:v(()=>[m(f(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),d(k,{disabled:a.running,"prepend-icon":"fa-solid fa-sync",onClick:s.getAvaileGTFS},{default:v(()=>[m(f(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),d(k,{loading:a.running,disabled:a.running||a.selectedGTFS.length===0,color:a.running||a.selectedGTFS.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:s.importGTFS},{default:v(()=>[m(f(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","color","onClick"]),d(W,null,{default:v(()=>[a.error?(p(),B(fe,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:v(()=>[m(f(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(p(!0),F(D,null,E(Object.keys(a.errorMessage),n=>(p(),F("p",{key:n},[h("b",null,f(n)+": ",1),m(f(a.errorMessage[n]),1)]))),128))]),_:1})):he("",!0)]),_:1}),h("div",Re,[(p(!0),F(D,null,E(a.parameters,(n,u)=>(p(),F("div",{key:u,class:"params"},[typeof n.items>"u"?(p(),B(ve,{key:0,modelValue:n.value,"onUpdate:modelValue":l=>n.value=l,step:"1",type:n.type,label:e.$gettext(n.text),suffix:n.units,variant:"underlined",hint:a.showHint?e.$gettext(n.hint):"","persistent-hint":a.showHint,rules:n.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(p(),B(ye,{key:1,modelValue:n.value,"onUpdate:modelValue":l=>n.value=l,variant:"underlined",type:n.type,items:n.items,label:e.$gettext(n.text),suffix:n.units,hint:a.showHint?e.$gettext(n.hint):"","persistent-hint":a.showHint,rules:n.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",Xe,[h("ul",Qe,[h("span",Ye,[d(ge,{disabled:!0})]),ze,Ze,je,$e,et]),(p(!0),F(D,null,E(a.availableGTFS,(n,u)=>(p(),F("ul",{key:n.index,class:"list-row"},[h("span",tt,[d(pe,{modelValue:a.selectedGTFS,"onUpdate:modelValue":t[0]||(t[0]=l=>a.selectedGTFS=l),value:n.index,label:String(u)},null,8,["modelValue","value","label"])]),h("span",rt,f(n.allInPolygon),1),h("span",at,f(n["location.country_code"]),1),h("span",st,f(n["location.subdivision_name"]),1),h("span",nt,f(n["location.municipality"]),1),h("span",ot,f(n.provider),1)]))),128))])]),_:1}),d(we,{modelValue:a.showOverwriteDialog,"onUpdate:modelValue":t[2]||(t[2]=n=>a.showOverwriteDialog=n),persistent:"","max-width":"500",onKeydown:[H(s.applyOverwriteDialog,["enter"]),t[3]||(t[3]=H(n=>a.showOverwriteDialog=!1,["esc"]))]},{default:v(()=>[d(O,null,{default:v(()=>[d(_,{class:"text-h5"},{default:v(()=>[m(f(e.$gettext("Overwrite current PT network ?")),1)]),_:1}),d(me,null,{default:v(()=>[d(be),d(k,{color:"regular",onClick:t[1]||(t[1]=n=>a.showOverwriteDialog=!a.showOverwriteDialog)},{default:v(()=>[m(f(e.$gettext("No")),1)]),_:1}),d(k,{color:"primary",onClick:s.applyOverwriteDialog},{default:v(()=>[m(f(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const ht=ne(He,[["render",it],["__scopeId","data-v-9dd377c2"]]);export{ht as default};
