import{bN as H,bO as L,bP as ue,bQ as T,bR as $,al as le,u as fe,b1 as ce,aa as de,a as ve,r as p,c as I,o as ye,d as he,bS as me,f as ge,g as be,j as y,i as m,ae as O,B as x,C as V,m as w,ax as pe,Q as D,A as z,L as k,R as we,bT as Pe,a8 as xe,a9 as Ve,Z as K,ah as Le,aJ as Q,am as Ie,aY as Me,_ as Ce}from"./index-8t7L7H7c.js";import{b as F,a as ke,M as Te}from"./Microservices-Cfzr8Y44.js";import{g as Fe}from"./form-B2uRhppC.js";import{T as Se}from"./TimeSeriesSelector-D32d7RrT.js";import{W as Be}from"./Warning-DrYUjqYF.js";function P(t,e,r){if(r===void 0&&(r={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var a=H(t),s=L(e),n=s.type,o=e.bbox,i=s.coordinates;if(o&&Ge(a,o)===!1)return!1;n==="Polygon"&&(i=[i]);for(var l=!1,v=0;v<i.length&&!l;v++)if(Y(a,i[v][0],r.ignoreBoundary)){for(var d=!1,b=1;b<i[v].length&&!d;)Y(a,i[v][b],!r.ignoreBoundary)&&(d=!0),b++;d||(l=!0)}return l}function Y(t,e,r){var a=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var s=0,n=e.length-1;s<e.length;n=s++){var o=e[s][0],i=e[s][1],l=e[n][0],v=e[n][1],d=t[1]*(o-l)+i*(l-t[0])+v*(t[0]-o)===0&&(o-t[0])*(l-t[0])<=0&&(i-t[1])*(v-t[1])<=0;if(d)return!r;var b=i>t[1]!=v>t[1]&&t[0]<(l-o)*(t[1]-i)/(v-i)+o;b&&(a=!a)}return a}function Ge(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}function M(t,e,r){r===void 0&&(r={});for(var a=H(t),s=ue(e),n=0;n<s.length-1;n++){var o=!1;if(r.ignoreEndVertices&&(n===0&&(o="start"),n===s.length-2&&(o="end"),n===0&&n+1===s.length-1&&(o="both")),Ee(s[n],s[n+1],a,o,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Ee(t,e,r,a,s){var n=r[0],o=r[1],i=t[0],l=t[1],v=e[0],d=e[1],b=r[0]-i,S=r[1]-l,h=v-i,g=d-l,C=b*g-S*h;if(s!==null){if(Math.abs(C)>s)return!1}else if(C!==0)return!1;if(a){if(a==="start")return Math.abs(h)>=Math.abs(g)?h>0?i<n&&n<=v:v<=n&&n<i:g>0?l<o&&o<=d:d<=o&&o<l;if(a==="end")return Math.abs(h)>=Math.abs(g)?h>0?i<=n&&n<v:v<n&&n<=i:g>0?l<=o&&o<d:d<o&&o<=l;if(a==="both")return Math.abs(h)>=Math.abs(g)?h>0?i<n&&n<v:v<n&&n<i:g>0?l<o&&o<d:d<o&&o<l}else return Math.abs(h)>=Math.abs(g)?h>0?i<=n&&n<=v:v<=n&&n<=i:g>0?l<=o&&o<=d:d<=o&&o<=l;return!1}function J(t,e){var r=L(t),a=L(e),s=r.type,n=a.type,o=r.coordinates,i=a.coordinates;switch(s){case"Point":switch(n){case"Point":return A(o,i);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Oe(r,a);case"MultiPoint":return De(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return M(a,r,{ignoreEndVertices:!0});case"LineString":return Ae(r,a);case"MultiPoint":return _e(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return P(a,r,{ignoreBoundary:!0});case"LineString":return Ne(r,a);case"Polygon":return Re(r,a);case"MultiPoint":return $e(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+s+" geometry not supported")}}function Oe(t,e){var r,a=!1;for(r=0;r<t.coordinates.length;r++)if(A(t.coordinates[r],e.coordinates)){a=!0;break}return a}function De(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){for(var s=a[r],n=!1,o=0,i=t.coordinates;o<i.length;o++){var l=i[o];if(A(s,l)){n=!0;break}}if(!n)return!1}return!0}function _e(t,e){for(var r=!1,a=0,s=e.coordinates;a<s.length;a++){var n=s[a];if(M(n,t,{ignoreEndVertices:!0})&&(r=!0),!M(n,t))return!1}return!!r}function $e(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){var s=a[r];if(!P(s,t,{ignoreBoundary:!0}))return!1}return!0}function Ae(t,e){for(var r=!1,a=0,s=e.coordinates;a<s.length;a++){var n=s[a];if(M({type:"Point",coordinates:n},t,{ignoreEndVertices:!0})&&(r=!0),!M({type:"Point",coordinates:n},t,{ignoreEndVertices:!1}))return!1}return r}function Ne(t,e){var r=!1,a=0,s=F(t),n=F(e);if(!j(s,n))return!1;for(a;a<e.coordinates.length-1;a++){var o=Ue(e.coordinates[a],e.coordinates[a+1]);if(P({type:"Point",coordinates:o},t,{ignoreBoundary:!0})){r=!0;break}}return r}function Re(t,e){if(t.type==="Feature"&&t.geometry===null||e.type==="Feature"&&e.geometry===null)return!1;var r=F(t),a=F(e);if(!j(r,a))return!1;for(var s=L(e).coordinates,n=0,o=s;n<o.length;n++)for(var i=o[n],l=0,v=i;l<v.length;l++){var d=v[l];if(!P(d,t))return!1}return!0}function j(t,e){return!(t[0]>e[0]||t[2]<e[2]||t[1]>e[1]||t[3]<e[3])}function A(t,e){return t[0]===e[0]&&t[1]===e[1]}function Ue(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function ee(t,e,r){r===void 0&&(r={});var a={type:"Feature"};return(r.id===0||r.id)&&(a.id=r.id),r.bbox&&(a.bbox=r.bbox),a.properties=e||{},a.geometry=t,a}function We(t,e,r){if(r===void 0&&(r={}),t.length<2)throw new Error("coordinates must be an array of two or more positions");var a={type:"LineString",coordinates:t};return ee(a,e,r)}function qe(t,e){e===void 0&&(e={});var r={type:"FeatureCollection"};return e.id&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.features=t,r}function ze(t,e,r){r===void 0&&(r={});var a={type:"MultiLineString",coordinates:t};return ee(a,e,r)}function _(t,e){e===void 0&&(e={});var r=L(t);switch(!e.properties&&t.type==="Feature"&&(e.properties=t.properties),r.type){case"Polygon":return Ke(r,e);case"MultiPolygon":return Qe(r,e);default:throw new Error("invalid poly")}}function Ke(t,e){e===void 0&&(e={});var r=L(t),a=r.coordinates,s=e.properties?e.properties:t.type==="Feature"?t.properties:{};return re(a,s)}function Qe(t,e){e===void 0&&(e={});var r=L(t),a=r.coordinates,s=e.properties?e.properties:t.type==="Feature"?t.properties:{},n=[];return a.forEach(function(o){n.push(re(o,s))}),qe(n)}function re(t,e){return t.length>1?ze(t,e):We(t[0],e)}function Ye(t,e){var r=!0;return T(t,function(a){T(e,function(s){if(r===!1)return!1;r=Je(a.geometry,s.geometry)})}),r}function Je(t,e){switch(t.type){case"Point":switch(e.type){case"Point":return!je(t.coordinates,e.coordinates);case"LineString":return!X(e,t);case"Polygon":return!P(t,e)}break;case"LineString":switch(e.type){case"Point":return!X(t,e);case"LineString":return!Xe(t,e);case"Polygon":return!Z(e,t)}break;case"Polygon":switch(e.type){case"Point":return!P(e,t);case"LineString":return!Z(t,e);case"Polygon":return!Ze(e,t)}}return!1}function X(t,e){for(var r=0;r<t.coordinates.length-1;r++)if(He(t.coordinates[r],t.coordinates[r+1],e.coordinates))return!0;return!1}function Xe(t,e){var r=$(t,e);return r.features.length>0}function Z(t,e){for(var r=0,a=e.coordinates;r<a.length;r++){var s=a[r];if(P(s,t))return!0}var n=$(e,_(t));return n.features.length>0}function Ze(t,e){for(var r=0,a=t.coordinates[0];r<a.length;r++){var s=a[r];if(P(s,e))return!0}for(var n=0,o=e.coordinates[0];n<o.length;n++){var i=o[n];if(P(i,t))return!0}var l=$(_(t),_(e));return l.features.length>0}function He(t,e,r){var a=r[0]-t[0],s=r[1]-t[1],n=e[0]-t[0],o=e[1]-t[1],i=a*o-s*n;return i!==0?!1:Math.abs(n)>=Math.abs(o)?n>0?t[0]<=r[0]&&r[0]<=e[0]:e[0]<=r[0]&&r[0]<=t[0]:o>0?t[1]<=r[1]&&r[1]<=e[1]:e[1]<=r[1]&&r[1]<=t[1]}function je(t,e){return t[0]===e[0]&&t[1]===e[1]}function er(t,e){var r=!1;return T(t,function(a){T(e,function(s){if(r===!0)return!0;r=!Ye(a.geometry,s.geometry)})}),r}const rr={class:"background"},tr={class:"params-row"},ar={class:"table-container"},nr=le({__name:"GTFSWebImporter",setup(t){const{$gettext:e}=fe(),r=ce(),a=de(),s=ve(),n=p(!1),o=p(Me()),i=p([]),l=p([]),v=p(!1),d=p(r.selectedGTFS),b=I(()=>a.linksIsEmpty),S=I(()=>r.callID),h=I(()=>r.running),g=I(()=>r.error),C=I(()=>r.errorMessage),B=I(()=>r.parameters),G=p(B.value.timeseries),E=p(B.value.day);function N(){const f=l.value.filter(u=>d.value.includes(u.index)).map(u=>u.url);r.saveParams({files:f,timeseries:Q(G.value),day:E.value,dates:[]}),r.saveSelectedGTFS(d.value)}ye(()=>{N()}),he(async()=>{te()});async function te(){i.value=await ae(),i.value=i.value.filter(c=>c["location.bounding_box.minimum_longitude"]),i.value.forEach((c,f)=>{c.bbox=ke([c["location.bounding_box.minimum_longitude"],c["location.bounding_box.minimum_latitude"],c["location.bounding_box.maximum_longitude"],c["location.bounding_box.maximum_latitude"]]),c.index=f}),i.value=i.value.filter(c=>c.bbox),i.value=i.value.filter(c=>{var f;return((f=c["urls.latest"])==null?void 0:f.length)>0}),i.value.sort((c,f)=>c["location.country_code"]<f["location.country_code"]?-1:c["location.country_code"]>f["location.country_code"]?1:0)}async function ae(){try{const c=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});c.ok||s.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const f=await c.arrayBuffer();return me(f)}catch(c){return s.changeAlert(c),[]}}function ne(c){o.value=c,oe()}function oe(){const c=i.value.filter(u=>J(o.value,u.bbox)||er(o.value,u.bbox));l.value=c.map(u=>({index:u.index,bbox:u.bbox,allInPolygon:J(o.value,u.bbox),countryCode:u["location.country_code"],city:u["location.municipality"],name:u["location.subdivision_name"],url:u["urls.latest"],provider:u.provider}));const f=new Set(l.value.map(u=>u.index));d.value=d.value.filter(u=>f.has(u))}const R=p();async function U(){var f;if(await R.value.validate())if(b.value){r.setCallID(),N();const u=Q(B.value),q=Ie(),ie={scenario_path_S3:S.value,launcher_arg:{training_folder:"/tmp",params:u},metadata:{user_email:(f=q.cognitoInfo)==null?void 0:f.email}};r.start(ie)}else n.value=!0}function W(){a.$reset(),n.value=!1,U()}const se=[{key:"index",title:"id"},{key:"allInPolygon",title:"All in polygon"},{key:"countryCode",title:"Code"},{key:"name",title:"Name"},{key:"city",title:"City"},{key:"provider",title:"Agency"},{key:"url",title:".zip"}];return(c,f)=>(be(),ge("div",rr,[y(D,{class:"card"},{default:m(()=>[y(O,{class:"subtitle"},{default:m(()=>[x(V(w(e)("GTFS importer")),1)]),_:1}),y(pe,null,{default:m(()=>[x(V(w(e)("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),y(Te,{onChange:ne})]),_:1}),y(D,{class:"card"},{default:m(()=>[y(O,{class:"subtitle"},{default:m(()=>[x(V(w(e)("Available GTFS")),1)]),_:1}),z("div",tr,[y(k,{loading:h.value,disabled:h.value||d.value.length===0,color:h.value||d.value.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:U},{default:m(()=>[x(V(w(e)("Download")),1)]),_:1},8,["loading","disabled","color"]),y(we,{modelValue:E.value,"onUpdate:modelValue":f[0]||(f[0]=u=>E.value=u),step:"1","max-width":"10rem",type:"string",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],label:w(e)("day"),suffix:"",density:"compact",variant:"outlined","hide-details":"","persistent-hint":v.value,rules:w(Fe)(["required"])},null,8,["modelValue","label","persistent-hint","rules"])]),y(Be,{show:g.value,messages:C.value},null,8,["show","messages"]),y(Se,{ref_key:"formRef",ref:R,modelValue:G.value,"onUpdate:modelValue":f[1]||(f[1]=u=>G.value=u)},null,8,["modelValue"]),z("div",ar,[y(Pe,{modelValue:d.value,"onUpdate:modelValue":f[2]||(f[2]=u=>d.value=u),class:"table",height:"100","item-height":"10","fixed-header":!0,sticky:!0,headers:se,items:l.value,"item-value":"index","hide-default-footer":"","show-select":"",hover:""},{"item.url":m(({item:u})=>[y(k,{variant:"text",icon:"fa-solid fa-download",size:"small",href:u.url},null,8,["href"])]),_:1},8,["modelValue","items"])])]),_:1}),y(Le,{modelValue:n.value,"onUpdate:modelValue":f[4]||(f[4]=u=>n.value=u),persistent:"","max-width":"500",onKeydown:[K(W,["enter"]),f[5]||(f[5]=K(u=>n.value=!1,["esc"]))]},{default:m(()=>[y(D,null,{default:m(()=>[y(O,{class:"text-h5"},{default:m(()=>[x(V(w(e)("Overwrite current PT network ?")),1)]),_:1}),y(xe,null,{default:m(()=>[y(Ve),y(k,{color:"regular",onClick:f[3]||(f[3]=u=>n.value=!n.value)},{default:m(()=>[x(V(w(e)("No")),1)]),_:1}),y(k,{color:"primary",onClick:W},{default:m(()=>[x(V(w(e)("Yes")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}}),fr=Ce(nr,[["__scopeId","data-v-2a5f1acf"]]);export{fr as default};
