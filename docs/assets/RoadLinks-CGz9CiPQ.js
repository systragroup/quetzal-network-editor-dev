import{M as F,a as we,b as xe}from"./main-Cz9rNVUF.js";import{P as Ie}from"./index-eyoXliWx.js";import{ab as ie,r as c,o as W,af as Le,ac as _,j as D,k as Q,q as k,z as y,L as de,i as Se,u as Ee,f as Me,ag as ue,e as h,ci as Ne,w as A,J as ce,K as Ce,v as B,m as De,C as Fe,M as _e,D as je,V as $e,F as Pe,y as ze,l as I,ba as qe,U as Re}from"./index-CIzcs_Se.js";import{a as Ae}from"./mapbox-gl-Q-t2QOFX.js";const Be={__name:"MapClickSelector",props:["map"],emits:["mousedown","mouseup","mousemove"],setup(E,{emit:V}){const O=E,g=V,{map:i}=ie(O),d=c(null),b=c(null),s=c({lnglat:null,point:null}),o=c({lnglat:null,point:null}),v=c(new Set);W(()=>{i.value.on("mousedown",j)}),Le(()=>{i.value.off("mousedown",j)});function j(r){r.originalEvent.button===2&&(s.value.lnglat=r.lngLat,s.value.point=r.point,i.value.on("mousemove",$),i.value.on("mouseup",L),g("mousedown",{mapboxEvent:r}))}function $(r){o.value.lnglat=r.lngLat,o.value.point=r.point;const w=i.value.unproject([o.value.point.x,s.value.point.y]),M=i.value.unproject([s.value.point.x,o.value.point.y]);d.value=Ie([[[s.value.lnglat.lng,s.value.lnglat.lat],[w.lng,w.lat],[o.value.lnglat.lng,o.value.lnglat.lat],[M.lng,M.lat],[s.value.lnglat.lng,s.value.lnglat.lat]]]),i.value.getSource("selectPolygon").setData(d.value),b.value=[Object.values(s.value.point),Object.values(o.value.point)],g("mousemove",{mapboxEvent:r,polygon:d.value,bbox:b.value})}function L(r){i.value.getSource("selectPolygon").setData(_),i.value.getCanvas().style.cursor="pointer",i.value.off("mousemove",$),i.value.off("mouseup",L),P(),d.value&&g("mouseup",{mapboxEvent:r,polygon:d.value,selectedId:v.value}),b.value=null,d.value=null}function P(){if(b.value){const r=i.value.queryRenderedFeatures(b.value,{layers:["rlinks"]});v.value=new Set(r.map(w=>w.id))}else v.value=new Set}return(r,w)=>(D(),Q(de,null,[k(y(F),{"source-id":"selectPolygon",reactive:!1,source:{type:"geojson",data:y(_)},"layer-id":"poly",layer:{type:"fill",paint:{"fill-color":r.$vuetify.theme.current.colors.linksprimary,"fill-opacity":.3}}},null,8,["source","layer"]),k(y(F),{"source-id":"selectPolygon",type:"line",source:"selectPolygon","layer-id":"stroke",layer:{type:"line",paint:{"line-color":r.$vuetify.theme.current.colors.linksprimary,"line-width":3}}},null,8,["layer"])],64))}},Ze={__name:"RoadLinks",props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover","select"],setup(E,{expose:V,emit:O}){const{$gettext:g}=Se(),i=E,d=O;V({init:L});const b=Ee(),s=Me(),{map:o,isRoadMode:v}=ie(i);W(()=>{o.value.getLayer("links")&&(o.value.moveLayer("rlinks","links"),o.value.moveLayer("anchorrNodes","links"),o.value.moveLayer("rnodes","links")),L()}),ue(()=>{o.value.removeLayer("arrow-rlinks")});function j(){const e=I.cloneDeep(r.value);e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rlinks").setData(e)}function $(){const e=I.cloneDeep(w.value);e.features.forEach(a=>a.id=a.properties.index),o.value.getSource("rnodes").setData(e)}function L(){j(),$()}const P=h(()=>b.roadsPopupContent),r=h(()=>s.visiblerLinks),w=h(()=>s.visiblerNodes);function M(){const e=o.value.queryRenderedFeatures({layers:["rlinks"]}),a=new Set(e.map(u=>u.id)),t=r.value.features.filter(u=>a.has(u.properties.index)),m=I.cloneDeep(_);return t.filter(u=>u.geometry.coordinates.length>2).forEach(u=>{const S=u.properties.index;u.geometry.coordinates.slice(1,-1).forEach((be,ke)=>m.features.push(qe(be,{index:Re.generate(),linkIndex:S,coordinatedIndex:ke+1})))}),m}const H=h(()=>b.anchorMode);Ne(()=>{if(v.value&&H.value&&z.value>=x.value.anchor){const e=M();o.value.getSource("anchorrNodes").setData(e)}else o.value.getSource("anchorrNodes").setData(_)},{flush:"post"});const N=c(null),l=c(null),K=c(!1),z=c(10),q=h(()=>{const e=z.value-x.value.nodes;return 2/(1+Math.exp(-e+3))+1}),x=c({anchor:14,nodes:12});async function X(){z.value=o.value.getZoom()}async function Y(){if(H.value&&z.value>=x.value.anchor){const e=M();o.value.getSource("anchorrNodes").setData(e)}}A(v,e=>{e?(o.value.on("dragend",Y),o.value.on("zoomend",X),x.value.nodes=12):(b.setAnchorMode(!1),o.value.off("dragend",Y),o.value.off("zoomend",X),x.value.nodes=24)},{immediate:!0});const Z=c(!1),T=c(!1),f=c("");function U(e){var a;if(v.value&&((a=N.value)!=null&&a.isOpen()&&N.value.remove(),l.value===null||l.value.layerId==="rlinks")){if(!K.value&&P.value.length>0){const m=e.mapboxEvent.features[0];if(m.layer.id==="rlinks"){let u=P.value.map(S=>`${S}: <b>${m.properties[S]}</b>`);u=u.join("<br> "),N.value=new Ae.Popup({closeButton:!1}).setLngLat([e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]).setHTML(u).addTo(e.map)}}o.value.getCanvas().style.cursor="pointer",l.value!==null&&o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1});const t=[...new Set(e.mapboxEvent.features.map(m=>m.id))];l.value={layerId:e.layerId,id:t},o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!0}),J.value||d("onHover",{layerId:l.value.layerId,selectedId:l.value.id})}}function G(e){var a,t;v.value&&((a=N.value)!=null&&a.isOpen()&&N.value.remove(),l.value!==null&&(["rnodes","anchorrNodes"].includes((t=l.value)==null?void 0:t.layerId)&&(e==null?void 0:e.layerId)==="rlinks"||(Z.value?T.value=!0:(o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,d("offHover",e)))))}function ee(e){if(v.value&&l.value!==null&&(f.value=l.value.id,f.value!==null&&l.value.layerId==="rlinks")){const a=H.value?"anchorrNodes":"rnodes";s.addRoadNodeInline({selectedIndex:f.value,lngLat:e.mapboxEvent.lngLat,nodes:a})}}function oe(e,a){if(a.length===0)L();else{const t=I.cloneDeep(a);t.forEach(u=>u.id=u.properties?u.properties.index:u.id),o.value.getSource(e).updateData({type:"FeatureCollection",features:t})}}const ve=h(()=>s.updateLinks),fe=h(()=>s.updateNodes);A(ve,e=>{oe("rlinks",e)},{flush:"sync"}),A(fe,e=>{oe("rnodes",e)},{flush:"sync"});const n=c({coordinates:[0,0],showed:!1,actions:[],feature:null});function pe(e){["Delete rLink","Delete Selected"].includes(e.action)?(s.deleterLink({selectedIndex:e.feature}),d("clickFeature",{action:"Delete rLink"})):d("clickFeature",{selectedIndex:e.feature,action:e.action,lngLat:e.coordinates}),n.value.showed=!1,R()}function ae(e){var t,m;const a=e.mapboxEvent.originalEvent.ctrlKey;if(v.value&&!a){const u=o.value.querySourceFeatures(l.value.layerId);f.value=u.filter(S=>l.value.id.includes(S.id)),f.value.length>0&&(((t=l.value)==null?void 0:t.layerId)==="rnodes"?d("clickFeature",{selectedFeature:f.value[0],action:"Edit rNode Info",lngLat:e.mapboxEvent.lngLat}):((m=l.value)==null?void 0:m.layerId)==="anchorrNodes"&&s.deleteAnchorrNode({selectedNode:f.value[0].properties}))}}const p=c(new Set([]));function C(e){p.value.forEach(a=>{o.value.setFeatureState({source:"rlinks",id:a},{select:e})})}function R(){C(!1),p.value=new Set([]),n.value.showed=!1}function le(e){!e.originalEvent.ctrlKey&&e.originalEvent.button===2&&R()}W(()=>{o.value.on("mousedown",le),o.value.on("click",R)}),ue(()=>{o.value.off("mousedown",le),o.value.off("click",R)});const J=h(()=>p.value.size>0);A(J,e=>d("select",e));function me(e){var a;v.value&&((a=l.value)==null?void 0:a.layerId)==="rlinks"&&(n.value.showed||(n.value.coordinates=[e.mapboxEvent.lngLat.lng,e.mapboxEvent.lngLat.lat]),n.value.showed=!0,e.mapboxEvent.originalEvent.ctrlKey?(p.value=new Set([...p.value,...l.value.id]),C(!0),n.value.feature=I.cloneDeep(p),n.value.actions=[{name:"Edit selected Info",text:g("Edit selected Info")},{name:"Delete Selected",text:g("Delete Selected")}]):(C(!1),p.value=new Set([]),n.value.feature=I.cloneDeep(l.value.id),n.value.actions=[{name:"Edit rLink Info",text:g("Edit rLink Info")},{name:"Delete rLink",text:g("Delete rLink")}]))}function ye(e){if(e.mapboxEvent.originalEvent.ctrlKey?p.value=new Set([...p.value,...e.selectedId]):(C(!1),p.value=e.selectedId),C(!0),p.value.size>0){n.value.showed=!0;const t=e.polygon.geometry.coordinates[0];n.value.coordinates=[(t[0][0]+t[2][0])/2,Math.max(t[0][1],t[2][1])],n.value.feature=I.cloneDeep(p),n.value.actions=[{name:"Edit selected Info",text:g("Edit selected Info")},{name:"Delete Selected",text:g("Delete Selected")}]}else n.value.showed=!1}function te(e){if(v.value&&e.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(l.value.layerId)){e.mapboxEvent.preventDefault(),o.value.getCanvas().style.cursor="grab",Z.value=!0;const a=o.value.querySourceFeatures(l.value.layerId);f.value=a.filter(t=>t.id===l.value.id[0])[0],K.value=!0,l.value.layerId==="rnodes"&&s.getConnectedLinks({selectedNode:f.value}),o.value.on("mousemove",ne),o.value.on("mouseup",se)}}function ne(e){T.value&&f.value&&(l.value.layerId==="anchorrNodes"?s.moverAnchor({selectedNode:f.value,lngLat:Object.values(e.lngLat)}):(d("clickFeature",{action:"Move rNode"}),s.moverNode({selectedNode:f.value,lngLat:Object.values(e.lngLat)})))}function se(){v.value&&(o.value.getCanvas().style.cursor="pointer",o.value.off("mousemove",ne),Z.value=!1,T.value=!1,K.value=!1,o.value.getCanvas().style.cursor="",o.value.setFeatureState({source:l.value.layerId,id:l.value.id[0]},{hover:!1}),l.value=null,o.value.off("mouseup",se))}const re=h(()=>b.cyclewayMode),ge=h(()=>{const e=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.1*q.value,0],.1*q.value],a=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return re.value?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],e,.25]],0],a]:["*",e,a]}),he=h(()=>re.value?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90);return(e,a)=>(D(),Q("section",null,[y(v)?(D(),ce(Be,{key:0,map:y(o),onMouseup:ye},null,8,["map"])):Ce("",!0),k(y(F),{"source-id":"rlinks",reactive:!1,source:{type:"geojson",dynamic:!0,data:r.value,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",paint:{"line-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]],"line-opacity":["case",["boolean",E.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*q.value,q.value],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:U,onMouseleave:G,onClick:ee,onContextmenu:me},null,8,["source","layer"]),k(y(we),{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:x.value.nodes,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":ge.value,"icon-rotate":he.value},paint:{"icon-color":["case",["boolean",["feature-state","select"],!1],"#87FFF3",["case",["has","route_color"],["concat","#",["get","route_color"]],e.$vuetify.theme.current.colors.linksprimary]]}}},null,8,["layer"]),k(y(F),{"source-id":"rnodes",reactive:!1,source:{type:"geojson",dynamic:!0,data:w.value,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{type:"circle",minzoom:x.value.nodes,paint:{"circle-color":["case",["boolean",E.isEditorMode,!1],e.$vuetify.theme.current.colors.mediumgrey,e.$vuetify.theme.current.colors.accent],"circle-stroke-color":e.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:U,onMouseleave:G,onMousedown:te,onContextmenu:ae},null,8,["source","layer"]),k(y(F),{"source-id":"anchorrNodes",reactive:!1,source:{type:"geojson",data:y(_),dynamic:!1,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{type:"circle",minzoom:x.value.anchor,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":e.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:ee,onMouseover:U,onMouseleave:G,onMousedown:te,onContextmenu:ae},null,8,["source","layer"]),k(y(xe),{"close-button":!1,showed:n.value.showed,coordinates:n.value.coordinates,"close-on-click":!1,onClose:a[1]||(a[1]=t=>n.value.showed=!1)},{default:B(()=>[De("span",{onMouseleave:a[0]||(a[0]=()=>{J.value||(n.value.showed=!1)})},[k(Fe,{density:"compact"},{default:B(()=>[(D(!0),Q(de,null,_e(n.value.actions,t=>(D(),ce(je,{key:t.id},{default:B(()=>[k($e,{variant:"outlined",size:"small",onClick:m=>pe({action:t.name,feature:n.value.feature,coordinates:n.value.coordinates})},{default:B(()=>[Pe(ze(y(g)(t.text)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])]))}};export{Ze as default};
