import{_ as X,c as Y,d as $,a$ as ee,u as oe,a7 as ae,t as re,p as ne,o as te,e as y,aB as A,r as f,w as Z,f as S,g as F,q as P,j as g,i as _,v as le,D as se,F as ue,E as ie,h as ce,J as de,G as ve,x as fe,y as me,n as ye}from"./index-BfbOZJSg.js";import{a as ge,b as he}from"./index-UIdMoy6U.js";const G=t=>t,ke={name:"RoadLinks",components:{MglGeojsonLayer:Y,MglImageLayer:$,MglPopup:ee},props:["map","isEditorMode","isRoadMode"],emits:["clickFeature","onHover","offHover"],setup(t,l){const c=oe(),e=ae(),{map:r,isRoadMode:u}=re(t);ne(()=>{r.value.on("dragend",v),r.value.on("zoomend",v),r.value.getLayer("links")&&(r.value.moveLayer("rlinks","links"),r.value.moveLayer("staticrLinks","links"))}),te(()=>{r.value.removeLayer("arrow-rlinks")});const m=y(()=>c.roadsPopupContent),M=y(()=>e.selectedrGroup),I=y(()=>c.cyclewayMode),d=y(()=>e.visiblerLinks),R=y(()=>e.renderedrLinks),H=y(()=>e.renderedrNodes),N=y(()=>c.anchorMode),z=A,V=y(()=>N.value?e.anchorrNodes:A),k=f(null),a=f(null),p=f(!1),q={static:1,rendered:2},E=f(100),L=f({links:4,rendered:14}),h=f({coordinates:[0,0],showed:!1,actions:[],feature:null});Z(M,()=>{E.value=100,v()}),Z(u,o=>{o?(r.value.on("dragend",v),r.value.on("zoomend",v),v()):(r.value.off("dragend",v),r.value.off("zoomend",v),e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value))});function v(){const o=r.value.getZoom();if(o>L.value.rendered){const n=r.value.getBounds(),i=ge(he([n._sw.lng,n._sw.lat,n._ne.lng,n._ne.lat]),.2);e.getRenderedrLinks({bbox:i}),r.value.getSource("staticrLinks").setData(z)}else o>L.value.links&&E.value>L.value.rendered?(e.setRenderedrLinks({method:"None"}),r.value.getSource("staticrLinks").setData(d.value)):e.setRenderedrLinks({method:"None"});E.value=o}const C=f(!1),x=f(!1),s=f("");function O(o){var n;if(u.value&&((n=k.value)!=null&&n.isOpen()&&k.value.remove(),a.value===null||a.value.layerId==="rlinks")){if(!p.value&&m.value.length>0){const b=o.mapboxEvent.features[0];if(b.layer.id!=="rnodes"){let w=m.value.map(B=>`${B}: <b>${b.properties[B]}</b>`);w=w.join("<br> "),k.value=new ye.Popup({closeButton:!1}).setLngLat([o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat]).setHTML(w).addTo(o.map)}}r.value.getCanvas().style.cursor="pointer",a.value!==null&&r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1});const i=[...new Set(o.mapboxEvent.features.map(b=>b.id))];a.value={layerId:o.layerId,id:i},r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!0}),l.emit("onHover",{layerId:a.value.layerId,selectedId:a.value.id})}}function T(o){var n,i;u.value&&((n=k.value)!=null&&n.isOpen()&&k.value.remove(),a.value!==null&&(["rnodes","anchorrNodes"].includes((i=a.value)==null?void 0:i.layerId)&&(o==null?void 0:o.layerId)==="rlinks"||(C.value?x.value=!0:(r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,l.emit("offHover",o)))))}function J(o){if(u.value&&a.value!==null&&(s.value=a.value.id,s.value!==null&&a.value.layerId==="rlinks")){const n=N.value?"anchorrNodes":"rnodes";e.addRoadNodeInline({selectedIndex:s.value,lngLat:o.mapboxEvent.lngLat,nodes:n})}}function U(o){u.value&&a.value.layerId==="rlinks"&&(h.value.coordinates=[o.mapboxEvent.lngLat.lng,o.mapboxEvent.lngLat.lat],h.value.showed=!0,h.value.feature=a.value.id,h.value.actions=[G("Edit rLink Info"),G("Delete rLink")])}function W(o){o.action==="Delete rLink"?(e.deleterLink({selectedIndex:o.feature}),l.emit("clickFeature",{action:"Delete rLink"})):l.emit("clickFeature",{selectedIndex:o.feature,action:o.action,lngLat:o.coordinates}),h.value.showed=!1,h.value.type=null}function K(o){var n,i;if(u.value){const b=r.value.querySourceFeatures(a.value.layerId);s.value=b.filter(w=>a.value.id.includes(w.id)),s.value.length>0&&(((n=a.value)==null?void 0:n.layerId)==="rnodes"?l.emit("clickFeature",{selectedFeature:s.value[0],action:"Edit rNode Info",lngLat:o.mapboxEvent.lngLat}):((i=a.value)==null?void 0:i.layerId)==="anchorrNodes"&&e.deleteAnchorrNode({selectedNode:s.value[0].properties}))}}function Q(o){if(u.value&&o.mapboxEvent.originalEvent.button===0&["rnodes","anchorrNodes"].includes(a.value.layerId)){o.mapboxEvent.preventDefault(),r.value.getCanvas().style.cursor="grab",C.value=!0;const n=r.value.querySourceFeatures(a.value.layerId);s.value=n.filter(i=>i.id===a.value.id[0])[0],p.value=!0,a.value.layerId==="rnodes"&&e.getConnectedLinks({selectedNode:s.value}),r.value.on("mousemove",j),r.value.on("mouseup",D)}}function j(o){x.value&&s.value&&(l.emit("clickFeature",{action:"Move rNode"}),a.value.layerId==="anchorrNodes"?e.moverAnchor({selectedNode:s.value,lngLat:Object.values(o.lngLat)}):e.moverNode({selectedNode:s.value,lngLat:Object.values(o.lngLat)}))}function D(){u.value&&(r.value.getCanvas().style.cursor="pointer",r.value.off("mousemove",j),C.value=!1,x.value=!1,p.value=!1,r.value.getCanvas().style.cursor="",r.value.setFeatureState({source:a.value.layerId,id:a.value.id[0]},{hover:!1}),a.value=null,r.value.off("mouseup",D))}return{store:c,rlinksStore:e,anchorMode:N,keepHovering:C,dragNode:x,selectedPopupContent:m,selectedrGroup:M,cyclewayMode:I,renderedrLinks:R,renderedrNodes:H,renderedAnchorrNodes:V,header:z,popup:k,hoveredStateId:a,visiblerLinks:d,disablePopup:p,width:q,minZoom:L,contextMenu:h,getBounds:v,onCursor:O,offCursor:T,selectClick:J,linkRightClick:U,actionClick:W,contextMenuNode:K,moveNode:Q}},computed:{ArrowSizeCondition(){const t=["case",["has","oneway"],["case",["to-boolean",["to-number",["get","oneway"]]],.25,0],.25],l=["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2];return this.cyclewayMode?["*",["case",["all",["to-boolean",["get","cycleway"]],["to-boolean",["get","cycleway_reverse"]]],["case",["all",["!=",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],0,["case",["all",["==",["downcase",["get","cycleway"]],"no"],["==",["downcase",["get","cycleway_reverse"]],"no"]],t,.25]],0],l]:["*",t,l]},ArrowDirCondition(){return this.cyclewayMode?["case",["all",["==",["downcase",["get","cycleway"]],"no"],["!=",["downcase",["get","cycleway_reverse"]],"no"]],-90,90]:90}}};function be(t,l,c,e,r,u){const m=S("MglGeojsonLayer"),M=S("MglImageLayer"),I=S("MglPopup");return F(),P("section",null,[g(m,{"source-id":"staticrLinks",reactive:!1,source:{type:"geojson",data:e.visiblerLinks,buffer:0,promoteId:"index"},"layer-id":"staticrLinks",layer:{type:"line",maxzoom:18,minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",c.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.static,e.width.static],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor},null,8,["source","layer","onMouseenter","onMouseleave"]),g(m,{"source-id":"rlinks",source:{type:"geojson",data:e.renderedrLinks,buffer:0,promoteId:"index"},"layer-id":"rlinks",layer:{type:"line",minzoom:e.minZoom.links,paint:{"line-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary],"line-opacity":["case",["boolean",c.isEditorMode,!1],.3,1],"line-width":["*",["case",["boolean",["feature-state","hover"],!1],2*e.width.rendered,e.width.rendered],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]],"line-blur":["*",["case",["boolean",["feature-state","hover"],!1],1,0],["case",["has","route_width"],["case",["to-boolean",["to-number",["get","route_width"]]],["to-number",["get","route_width"]],2],2]]},layout:{"line-sort-key":["to-number",["get","route_width"]]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor,onClick:e.selectClick,onContextmenu:e.linkRightClick},null,8,["source","layer","onMouseenter","onMouseleave","onClick","onContextmenu"]),g(M,{"source-id":"rlinks",type:"symbol",source:"rlinks","layer-id":"arrow-rlinks",layer:{type:"symbol",minzoom:e.minZoom.rendered,layout:{"symbol-placement":"line","symbol-spacing":200,"icon-ignore-placement":!0,"icon-image":"arrow","icon-size":u.ArrowSizeCondition,"icon-rotate":u.ArrowDirCondition},paint:{"icon-color":["case",["has","route_color"],["concat","#",["get","route_color"]],t.$vuetify.theme.current.colors.linksprimary]}}},null,8,["layer"]),g(m,{"source-id":"rnodes",source:{type:"geojson",data:e.renderedrNodes,buffer:0,promoteId:"index"},"layer-id":"rnodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":["case",["boolean",c.isEditorMode,!1],t.$vuetify.theme.current.colors.mediumgrey,t.$vuetify.theme.current.colors.accent],"circle-stroke-color":t.$vuetify.theme.current.colors.white,"circle-stroke-width":1,"circle-radius":["case",["boolean",["feature-state","hover"],!1],14,6],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0]}},onMouseenter:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onMouseenter","onMouseleave","onMousedown","onContextmenu"]),g(m,{"source-id":"anchorrNodes",source:{type:"geojson",data:c.isRoadMode?e.renderedAnchorrNodes:e.header,buffer:0,promoteId:"index"},"layer-id":"anchorrNodes",layer:{interactive:!0,type:"circle",minzoom:e.minZoom.rendered,paint:{"circle-color":"#ffffff","circle-opacity":.5,"circle-radius":["case",["boolean",["feature-state","hover"],!1],10,8],"circle-blur":["case",["boolean",["feature-state","hover"],!1],.3,0],"circle-stroke-color":t.$vuetify.theme.current.colors.darkgrey,"circle-stroke-width":2}},onClick:e.selectClick,onMouseover:e.onCursor,onMouseleave:e.offCursor,onMousedown:e.moveNode,onContextmenu:e.contextMenuNode},null,8,["source","layer","onClick","onMouseover","onMouseleave","onMousedown","onContextmenu"]),g(I,{"close-button":!1,showed:e.contextMenu.showed,coordinates:e.contextMenu.coordinates,onClose:l[1]||(l[1]=d=>e.contextMenu.showed=!1)},{default:_(()=>[le("span",{onMouseleave:l[0]||(l[0]=d=>e.contextMenu.showed=!1)},[g(se,{density:"compact"},{default:_(()=>[(F(!0),P(ue,null,ie(e.contextMenu.actions,d=>(F(),ce(de,{key:d.id},{default:_(()=>[g(ve,{variant:"outlined",size:"small",onClick:R=>e.actionClick({action:d,feature:e.contextMenu.feature,coordinates:e.contextMenu.coordinates})},{default:_(()=>[fe(me(t.$gettext(d)),1)]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:1})],32)]),_:1},8,["showed","coordinates"])])}const pe=X(ke,[["render",be]]);export{pe as default};
