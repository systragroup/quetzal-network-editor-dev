import{M as re,b as R}from"./Microservices-cVQECORJ.js";import{bN as Z,bO as F,bP as ae,aB as C,aE as ne,bQ as se,bR as oe,bS as M,bT as U,_ as ie,aW as le,a6 as ue,u as ce,r as w,e as T,o as de,aA as fe,f as he,g as p,q as S,j as d,i as v,ab as _,x as m,y as f,L as O,aR as W,G as I,h as B,an as ve,F as E,E as D,v as h,l as ye,Z as ge,N as pe,aT as me,Q as be,a2 as we,a3 as Pe,a4 as H,a9 as Te,bU as Se,bV as Fe}from"./index-DVm0in2n.js";import{P as xe}from"./index-fJ15Q1cQ.js";function P(e,t,r){if(r===void 0&&(r={}),!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");var a=Z(e),i=F(t),n=i.type,o=t.bbox,s=i.coordinates;if(o&&Ge(a,o)===!1)return!1;n==="Polygon"&&(s=[s]);for(var u=!1,l=0;l<s.length&&!u;l++)if(K(a,s[l][0],r.ignoreBoundary)){for(var c=!1,b=1;b<s[l].length&&!c;)K(a,s[l][b],!r.ignoreBoundary)&&(c=!0),b++;c||(u=!0)}return u}function K(e,t,r){var a=!1;t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]&&(t=t.slice(0,t.length-1));for(var i=0,n=t.length-1;i<t.length;n=i++){var o=t[i][0],s=t[i][1],u=t[n][0],l=t[n][1],c=e[1]*(o-u)+s*(u-e[0])+l*(e[0]-o)===0&&(o-e[0])*(u-e[0])<=0&&(s-e[1])*(l-e[1])<=0;if(c)return!r;var b=s>e[1]!=l>e[1]&&e[0]<(u-o)*(e[1]-s)/(l-s)+o;b&&(a=!a)}return a}function Ge(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}function G(e,t,r){r===void 0&&(r={});for(var a=Z(e),i=ae(t),n=0;n<i.length-1;n++){var o=!1;if(r.ignoreEndVertices&&(n===0&&(o="start"),n===i.length-2&&(o="end"),n===0&&n+1===i.length-1&&(o="both")),Le(i[n],i[n+1],a,o,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Le(e,t,r,a,i){var n=r[0],o=r[1],s=e[0],u=e[1],l=t[0],c=t[1],b=r[0]-s,V=r[1]-u,y=l-s,g=c-u,k=b*g-V*y;if(i!==null){if(Math.abs(k)>i)return!1}else if(k!==0)return!1;if(a){if(a==="start")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<=l:l<=n&&n<s:g>0?u<o&&o<=c:c<=o&&o<u;if(a==="end")return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<l:l<n&&n<=s:g>0?u<=o&&o<c:c<o&&o<=u;if(a==="both")return Math.abs(y)>=Math.abs(g)?y>0?s<n&&n<l:l<n&&n<s:g>0?u<o&&o<c:c<o&&o<u}else return Math.abs(y)>=Math.abs(g)?y>0?s<=n&&n<=l:l<=n&&n<=s:g>0?u<=o&&o<=c:c<=o&&o<=u;return!1}function Q(e,t){var r=F(e),a=F(t),i=r.type,n=a.type,o=r.coordinates,s=a.coordinates;switch(i){case"Point":switch(n){case"Point":return q(o,s);default:throw new Error("feature2 "+n+" geometry not supported")}case"MultiPoint":switch(n){case"Point":return Ve(r,a);case"MultiPoint":return ke(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"LineString":switch(n){case"Point":return G(a,r,{ignoreEndVertices:!0});case"LineString":return Me(r,a);case"MultiPoint":return Ie(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}case"Polygon":switch(n){case"Point":return P(a,r,{ignoreBoundary:!0});case"LineString":return _e(r,a);case"Polygon":return Oe(r,a);case"MultiPoint":return Ce(r,a);default:throw new Error("feature2 "+n+" geometry not supported")}default:throw new Error("feature1 "+i+" geometry not supported")}}function Ve(e,t){var r,a=!1;for(r=0;r<e.coordinates.length;r++)if(q(e.coordinates[r],t.coordinates)){a=!0;break}return a}function ke(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){for(var i=a[r],n=!1,o=0,s=e.coordinates;o<s.length;o++){var u=s[o];if(q(i,u)){n=!0;break}}if(!n)return!1}return!0}function Ie(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var n=i[a];if(G(n,e,{ignoreEndVertices:!0})&&(r=!0),!G(n,e))return!1}return!!r}function Ce(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(!P(i,e,{ignoreBoundary:!0}))return!1}return!0}function Me(e,t){for(var r=!1,a=0,i=t.coordinates;a<i.length;a++){var n=i[a];if(G({type:"Point",coordinates:n},e,{ignoreEndVertices:!0})&&(r=!0),!G({type:"Point",coordinates:n},e,{ignoreEndVertices:!1}))return!1}return r}function _e(e,t){var r=!1,a=0,i=C(e),n=C(t);if(!z(i,n))return!1;for(a;a<t.coordinates.length-1;a++){var o=Be(t.coordinates[a],t.coordinates[a+1]);if(P({type:"Point",coordinates:o},e,{ignoreBoundary:!0})){r=!0;break}}return r}function Oe(e,t){if(e.type==="Feature"&&e.geometry===null||t.type==="Feature"&&t.geometry===null)return!1;var r=C(e),a=C(t);if(!z(r,a))return!1;for(var i=F(t).coordinates,n=0,o=i;n<o.length;n++)for(var s=o[n],u=0,l=s;u<l.length;u++){var c=l[u];if(!P(c,e))return!1}return!0}function z(e,t){return!(e[0]>t[0]||e[2]<t[2]||e[1]>t[1]||e[3]<t[3])}function q(e,t){return e[0]===t[0]&&e[1]===t[1]}function Be(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}function A(e,t){t===void 0&&(t={});var r=F(e);switch(!t.properties&&e.type==="Feature"&&(t.properties=e.properties),r.type){case"Polygon":return Ee(r,t);case"MultiPolygon":return De(r,t);default:throw new Error("invalid poly")}}function Ee(e,t){t===void 0&&(t={});var r=F(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{};return j(a,i)}function De(e,t){t===void 0&&(t={});var r=F(e),a=r.coordinates,i=t.properties?t.properties:e.type==="Feature"?e.properties:{},n=[];return a.forEach(function(o){n.push(j(o,i))}),ne(n)}function j(e,t){return e.length>1?se(e,t):oe(e[0],t)}function Ae(e,t){var r=!0;return M(e,function(a){M(t,function(i){if(r===!1)return!1;r=Ue(a.geometry,i.geometry)})}),r}function Ue(e,t){switch(e.type){case"Point":switch(t.type){case"Point":return!We(e.coordinates,t.coordinates);case"LineString":return!X(t,e);case"Polygon":return!P(e,t)}break;case"LineString":switch(t.type){case"Point":return!X(e,t);case"LineString":return!qe(e,t);case"Polygon":return!J(t,e)}break;case"Polygon":switch(t.type){case"Point":return!P(t,e);case"LineString":return!J(e,t);case"Polygon":return!Ne(t,e)}}return!1}function X(e,t){for(var r=0;r<e.coordinates.length-1;r++)if(Re(e.coordinates[r],e.coordinates[r+1],t.coordinates))return!0;return!1}function qe(e,t){var r=U(e,t);return r.features.length>0}function J(e,t){for(var r=0,a=t.coordinates;r<a.length;r++){var i=a[r];if(P(i,e))return!0}var n=U(t,A(e));return n.features.length>0}function Ne(e,t){for(var r=0,a=e.coordinates[0];r<a.length;r++){var i=a[r];if(P(i,t))return!0}for(var n=0,o=t.coordinates[0];n<o.length;n++){var s=o[n];if(P(s,e))return!0}var u=U(A(e),A(t));return u.features.length>0}function Re(e,t,r){var a=r[0]-e[0],i=r[1]-e[1],n=t[0]-e[0],o=t[1]-e[1],s=a*o-i*n;return s!==0?!1:Math.abs(n)>=Math.abs(o)?n>0?e[0]<=r[0]&&r[0]<=t[0]:t[0]<=r[0]&&r[0]<=e[0]:o>0?e[1]<=r[1]&&r[1]<=t[1]:t[1]<=r[1]&&r[1]<=e[1]}function We(e,t){return e[0]===t[0]&&e[1]===t[1]}function He(e,t){var r=!1;return M(e,function(a){M(t,function(i){if(r===!0)return!0;r=!Ae(a.geometry,i.geometry)})}),r}const Y=e=>e,Ke={name:"GTFSWebImporter",components:{MapSelector:re},setup(){const e=le(),t=ue(),r=ce(),a=w(!1),i=w(null),n=w({}),o=w([]),s=w([]),u=w(!1),l=w(!1),c=w(e.selectedGTFS),b=T(()=>t.linksIsEmpty),V=T(()=>e.UploadedGTFS),y=T(()=>e.callID),g=T(()=>e.running),k=T(()=>e.error),$=T(()=>e.errorMessage),ee=T(()=>V.value.filter(x=>x.progress<100).length>0);de(()=>{e.saveParams(N.value),e.saveSelectedGTFS(c.value)});const N=w([{name:"start_time",text:"start time",value:e.parameters.start_time,type:"String",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"end_time",text:"end time",value:e.parameters.end_time,type:"String",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required","timeRule"]},{name:"day",text:"day",value:e.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),te=/^(0?[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return{showOverwriteDialog:a,poly:i,runGTFS:e,store:r,nodes:n,gtfsList:o,availableGTFS:s,selectedGTFS:c,checkall:u,showHint:l,parameters:N,rules:{required:x=>!!x||Y("Required"),timeRule:x=>te.test(x)||Y("invalid date time")},linksIsEmpty:b,UploadedGTFS:V,callID:y,running:g,error:k,errorMessage:$,isUploading:ee}},async created(){this.gtfsList=await this.fetchCSV(),this.gtfsList.forEach((e,t)=>{try{e.bbox=R([e["location.bounding_box.minimum_longitude"],e["location.bounding_box.minimum_latitude"],e["location.bounding_box.maximum_longitude"],e["location.bounding_box.maximum_latitude"]])}catch{e.bbox=null}e.index=t}),this.gtfsList=this.gtfsList.filter(e=>e.bbox),this.gtfsList=this.gtfsList.filter(e=>e["urls.latest"].length>0),this.gtfsList.sort((e,t)=>e["location.country_code"]<t["location.country_code"]?-1:e["location.country_code"]>t["location.country_code"]?1:0)},methods:{async fetchCSV(){try{const e=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});e.ok||this.store.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const t=await e.arrayBuffer();return fe(t)}catch(e){this.store.changeAlert(e)}},getBBOX(e){this.poly?this.poly=e:(this.poly=e,this.getAvaileGTFS())},getAvaileGTFS(){let e=null;if(this.poly.style==="bbox"){const r=this.poly.geometry;e=R([r[1],r[0],r[3],r[2]])}else e=xe([this.poly.geometry]);this.availableGTFS=this.gtfsList.filter(r=>Q(e,r.bbox)||He(e,r.bbox)),this.availableGTFS.forEach(r=>r.allInPolygon=Q(e,r.bbox));const t=new Set(this.availableGTFS.map(r=>r.index));this.selectedGTFS=this.selectedGTFS.filter(r=>t.has(r))},importGTFS(){if(this.linksIsEmpty){this.runGTFS.setCallID();const r={files:this.availableGTFS.filter(a=>this.selectedGTFS.includes(a.index)).map(a=>a["urls.latest"])};this.parameters.forEach(a=>{r[a.name]=a.value}),this.runGTFS.startExecution(r)}else this.showOverwriteDialog=!0},applyOverwriteDialog(){this.store.initLinks(),this.showOverwriteDialog=!1,this.importGTFS()}}},L=e=>(Se("data-v-74086045"),e=e(),Fe(),e),Qe={class:"background"},Xe={class:"params-row"},Je={class:"list"},Ye={class:"list-row"},Ze={class:"list-item-small"},ze=L(()=>h("span",{class:"list-item-small"},"All in polygon",-1)),je=L(()=>h("span",{class:"list-item-small"},"Code",-1)),$e=L(()=>h("span",{class:"list-item-medium"},"Name",-1)),et=L(()=>h("span",{class:"list-item-large"},"City",-1)),tt=L(()=>h("span",{class:"list-item-large"},"Agency",-1)),rt={class:"list-item-small"},at={class:"list-item-small"},nt={class:"list-item-small"},st={class:"list-item-medium"},ot={class:"list-item-large"},it={class:"list-item-large"};function lt(e,t,r,a,i,n){const o=he("MapSelector");return p(),S("div",Qe,[d(O,{class:"card"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("GTFS importer")),1)]),_:1}),d(o,{onChange:n.getBBOX},null,8,["onChange"])]),_:1}),d(O,{class:"card2"},{default:v(()=>[d(_,{class:"subtitle"},{default:v(()=>[m(f(e.$gettext("Available GTFS")),1)]),_:1}),d(W,null,{default:v(()=>[m(f(e.$gettext("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),d(I,{disabled:a.running,"prepend-icon":"fa-solid fa-sync",onClick:n.getAvaileGTFS},{default:v(()=>[m(f(e.$gettext("fetch available GTFS")),1)]),_:1},8,["disabled","onClick"]),d(I,{loading:a.running,disabled:a.running||a.selectedGTFS.length===0,color:a.running||a.selectedGTFS.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:n.importGTFS},{default:v(()=>[m(f(e.$gettext("Download")),1)]),_:1},8,["loading","disabled","color","onClick"]),d(W,null,{default:v(()=>[a.error?(p(),B(ve,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:v(()=>[m(f(e.$gettext("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(p(!0),S(E,null,D(Object.keys(a.errorMessage),s=>(p(),S("p",{key:s},[h("b",null,f(s)+": ",1),m(f(a.errorMessage[s]),1)]))),128))]),_:1})):ye("",!0)]),_:1}),h("div",Xe,[(p(!0),S(E,null,D(a.parameters,(s,u)=>(p(),S("div",{key:u,class:"params"},[typeof s.items>"u"?(p(),B(ge,{key:0,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,type:s.type,label:e.$gettext(s.text),suffix:s.units,variant:"underlined",hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(p(),B(pe,{key:1,modelValue:s.value,"onUpdate:modelValue":l=>s.value=l,variant:"underlined",type:s.type,items:s.items,label:e.$gettext(s.text),suffix:s.units,hint:a.showHint?e.$gettext(s.hint):"","persistent-hint":a.showHint,rules:s.rules.map(l=>a.rules[l]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),h("div",Je,[h("ul",Ye,[h("span",Ze,[d(me,{disabled:!0})]),ze,je,$e,et,tt]),(p(!0),S(E,null,D(a.availableGTFS,(s,u)=>(p(),S("ul",{key:s.index,class:"list-row"},[h("span",rt,[d(be,{modelValue:a.selectedGTFS,"onUpdate:modelValue":t[0]||(t[0]=l=>a.selectedGTFS=l),value:s.index,label:String(u)},null,8,["modelValue","value","label"])]),h("span",at,f(s.allInPolygon),1),h("span",nt,f(s["location.country_code"]),1),h("span",st,f(s["location.subdivision_name"]),1),h("span",ot,f(s["location.municipality"]),1),h("span",it,f(s.provider),1)]))),128))])]),_:1}),d(Te,{modelValue:a.showOverwriteDialog,"onUpdate:modelValue":t[2]||(t[2]=s=>a.showOverwriteDialog=s),persistent:"","max-width":"500",onKeydown:[H(n.applyOverwriteDialog,["enter"]),t[3]||(t[3]=H(s=>a.showOverwriteDialog=!1,["esc"]))]},{default:v(()=>[d(O,null,{default:v(()=>[d(_,{class:"text-h5"},{default:v(()=>[m(f(e.$gettext("Overwrite current PT network ?")),1)]),_:1}),d(we,null,{default:v(()=>[d(Pe),d(I,{color:"regular",onClick:t[1]||(t[1]=s=>a.showOverwriteDialog=!a.showOverwriteDialog)},{default:v(()=>[m(f(e.$gettext("No")),1)]),_:1}),d(I,{color:"primary",onClick:n.applyOverwriteDialog},{default:v(()=>[m(f(e.$gettext("Yes")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue","onKeydown"])])}const ht=ie(Ke,[["render",lt],["__scopeId","data-v-74086045"]]);export{ht as default};
