import{bV as ne,g as k,bW as ue,aY as E,a_ as ce,bX as fe,bY as de,bZ as O,b_ as X,_ as ve,i as he,ba as ye,h as pe,u as me,r as M,e as C,ag as be,o as ge,aX as Pe,j as _,k as T,q as h,v as m,a6 as $,F as x,y,z as g,T as A,b7 as Z,V as B,J as N,aM as we,L as U,M as W,m as p,K as _e,I as xe,H as Ve,Q as Ie,W as Le,aa as Me,B as Te,a5 as H,ar as ke,b$ as Fe,c0 as Ce}from"./index-DWA-_zBJ.js";import{b as j,M as Se}from"./Microservices-DK2m19G0.js";import{P as Ge}from"./index-C8slN-lX.js";import"./main-CpSi--NZ.js";function L(t,e,r){if(r===void 0&&(r={}),!t)throw new Error("point is required");if(!e)throw new Error("polygon is required");var n=ne(t),o=k(e),a=o.type,s=e.bbox,i=o.coordinates;if(s&&Be(n,s)===!1)return!1;a==="Polygon"&&(i=[i]);for(var u=!1,f=0;f<i.length&&!u;f++)if(ee(n,i[f][0],r.ignoreBoundary)){for(var d=!1,V=1;V<i[f].length&&!d;)ee(n,i[f][V],!r.ignoreBoundary)&&(d=!0),V++;d||(u=!0)}return u}function ee(t,e,r){var n=!1;e[0][0]===e[e.length-1][0]&&e[0][1]===e[e.length-1][1]&&(e=e.slice(0,e.length-1));for(var o=0,a=e.length-1;o<e.length;a=o++){var s=e[o][0],i=e[o][1],u=e[a][0],f=e[a][1],d=t[1]*(s-u)+i*(u-t[0])+f*(t[0]-s)===0&&(s-t[0])*(u-t[0])<=0&&(i-t[1])*(f-t[1])<=0;if(d)return!r;var V=i>t[1]!=f>t[1]&&t[0]<(u-s)*(t[1]-i)/(f-i)+s;V&&(n=!n)}return n}function Be(t,e){return e[0]<=t[0]&&e[1]<=t[1]&&e[2]>=t[0]&&e[3]>=t[1]}function S(t,e,r){r===void 0&&(r={});for(var n=ne(t),o=ue(e),a=0;a<o.length-1;a++){var s=!1;if(r.ignoreEndVertices&&(a===0&&(s="start"),a===o.length-2&&(s="end"),a===0&&a+1===o.length-1&&(s="both")),Ee(o[a],o[a+1],n,s,typeof r.epsilon>"u"?null:r.epsilon))return!0}return!1}function Ee(t,e,r,n,o){var a=r[0],s=r[1],i=t[0],u=t[1],f=e[0],d=e[1],V=r[0]-i,D=r[1]-u,b=f-i,P=d-u,F=V*P-D*b;if(o!==null){if(Math.abs(F)>o)return!1}else if(F!==0)return!1;if(n){if(n==="start")return Math.abs(b)>=Math.abs(P)?b>0?i<a&&a<=f:f<=a&&a<i:P>0?u<s&&s<=d:d<=s&&s<u;if(n==="end")return Math.abs(b)>=Math.abs(P)?b>0?i<=a&&a<f:f<a&&a<=i:P>0?u<=s&&s<d:d<s&&s<=u;if(n==="both")return Math.abs(b)>=Math.abs(P)?b>0?i<a&&a<f:f<a&&a<i:P>0?u<s&&s<d:d<s&&s<u}else return Math.abs(b)>=Math.abs(P)?b>0?i<=a&&a<=f:f<=a&&a<=i:P>0?u<=s&&s<=d:d<=s&&s<=u;return!1}function te(t,e){var r=k(t),n=k(e),o=r.type,a=n.type,s=r.coordinates,i=n.coordinates;switch(o){case"Point":switch(a){case"Point":return Y(s,i);default:throw new Error("feature2 "+a+" geometry not supported")}case"MultiPoint":switch(a){case"Point":return Oe(r,n);case"MultiPoint":return De(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}case"LineString":switch(a){case"Point":return S(n,r,{ignoreEndVertices:!0});case"LineString":return Ae(r,n);case"MultiPoint":return qe(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}case"Polygon":switch(a){case"Point":return L(n,r,{ignoreBoundary:!0});case"LineString":return Ne(r,n);case"Polygon":return Ue(r,n);case"MultiPoint":return $e(r,n);default:throw new Error("feature2 "+a+" geometry not supported")}default:throw new Error("feature1 "+o+" geometry not supported")}}function Oe(t,e){var r,n=!1;for(r=0;r<t.coordinates.length;r++)if(Y(t.coordinates[r],e.coordinates)){n=!0;break}return n}function De(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){for(var o=n[r],a=!1,s=0,i=t.coordinates;s<i.length;s++){var u=i[s];if(Y(o,u)){a=!0;break}}if(!a)return!1}return!0}function qe(t,e){for(var r=!1,n=0,o=e.coordinates;n<o.length;n++){var a=o[n];if(S(a,t,{ignoreEndVertices:!0})&&(r=!0),!S(a,t))return!1}return!!r}function $e(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){var o=n[r];if(!L(o,t,{ignoreBoundary:!0}))return!1}return!0}function Ae(t,e){for(var r=!1,n=0,o=e.coordinates;n<o.length;n++){var a=o[n];if(S({type:"Point",coordinates:a},t,{ignoreEndVertices:!0})&&(r=!0),!S({type:"Point",coordinates:a},t,{ignoreEndVertices:!1}))return!1}return r}function Ne(t,e){var r=!1,n=0,o=E(t),a=E(e);if(!se(o,a))return!1;for(n;n<e.coordinates.length-1;n++){var s=We(e.coordinates[n],e.coordinates[n+1]);if(L({type:"Point",coordinates:s},t,{ignoreBoundary:!0})){r=!0;break}}return r}function Ue(t,e){if(t.type==="Feature"&&t.geometry===null||e.type==="Feature"&&e.geometry===null)return!1;var r=E(t),n=E(e);if(!se(r,n))return!1;for(var o=k(e).coordinates,a=0,s=o;a<s.length;a++)for(var i=s[a],u=0,f=i;u<f.length;u++){var d=f[u];if(!L(d,t))return!1}return!0}function se(t,e){return!(t[0]>e[0]||t[2]<e[2]||t[1]>e[1]||t[3]<e[3])}function Y(t,e){return t[0]===e[0]&&t[1]===e[1]}function We(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function K(t,e){e===void 0&&(e={});var r=k(t);switch(!e.properties&&t.type==="Feature"&&(e.properties=t.properties),r.type){case"Polygon":return Ke(r,e);case"MultiPolygon":return Xe(r,e);default:throw new Error("invalid poly")}}function Ke(t,e){e===void 0&&(e={});var r=k(t),n=r.coordinates,o=e.properties?e.properties:t.type==="Feature"?t.properties:{};return oe(n,o)}function Xe(t,e){e===void 0&&(e={});var r=k(t),n=r.coordinates,o=e.properties?e.properties:t.type==="Feature"?t.properties:{},a=[];return n.forEach(function(s){a.push(oe(s,o))}),ce(a)}function oe(t,e){return t.length>1?fe(t,e):de(t[0],e)}function Ye(t,e){var r=!0;return O(t,function(n){O(e,function(o){if(r===!1)return!1;r=Je(n.geometry,o.geometry)})}),r}function Je(t,e){switch(t.type){case"Point":switch(e.type){case"Point":return!Ze(t.coordinates,e.coordinates);case"LineString":return!re(e,t);case"Polygon":return!L(t,e)}break;case"LineString":switch(e.type){case"Point":return!re(t,e);case"LineString":return!Re(t,e);case"Polygon":return!ae(e,t)}break;case"Polygon":switch(e.type){case"Point":return!L(e,t);case"LineString":return!ae(t,e);case"Polygon":return!ze(e,t)}}return!1}function re(t,e){for(var r=0;r<t.coordinates.length-1;r++)if(Qe(t.coordinates[r],t.coordinates[r+1],e.coordinates))return!0;return!1}function Re(t,e){var r=X(t,e);return r.features.length>0}function ae(t,e){for(var r=0,n=e.coordinates;r<n.length;r++){var o=n[r];if(L(o,t))return!0}var a=X(e,K(t));return a.features.length>0}function ze(t,e){for(var r=0,n=t.coordinates[0];r<n.length;r++){var o=n[r];if(L(o,e))return!0}for(var a=0,s=e.coordinates[0];a<s.length;a++){var i=s[a];if(L(i,t))return!0}var u=X(K(t),K(e));return u.features.length>0}function Qe(t,e,r){var n=r[0]-t[0],o=r[1]-t[1],a=e[0]-t[0],s=e[1]-t[1],i=n*s-o*a;return i!==0?!1:Math.abs(a)>=Math.abs(s)?a>0?t[0]<=r[0]&&r[0]<=e[0]:e[0]<=r[0]&&r[0]<=t[0]:s>0?t[1]<=r[1]&&r[1]<=e[1]:e[1]<=r[1]&&r[1]<=t[1]}function Ze(t,e){return t[0]===e[0]&&t[1]===e[1]}function He(t,e){var r=!1;return O(t,function(n){O(e,function(o){if(r===!0)return!0;r=!Ye(n.geometry,o.geometry)})}),r}const G=t=>(Fe("data-v-d7238ff6"),t=t(),Ce(),t),je={class:"background"},et={class:"params-row"},tt={class:"list"},rt={class:"list-row"},at={class:"list-item-small"},nt=G(()=>p("span",{class:"list-item-small"},"All in polygon",-1)),st=G(()=>p("span",{class:"list-item-small"},"Code",-1)),ot=G(()=>p("span",{class:"list-item-medium"},"Name",-1)),lt=G(()=>p("span",{class:"list-item-large"},"City",-1)),it=G(()=>p("span",{class:"list-item-large"},"Agency",-1)),ut={class:"list-item-small"},ct={class:"list-item-small"},ft={class:"list-item-small"},dt={class:"list-item-medium"},vt={class:"list-item-large"},ht={class:"list-item-large"},yt={__name:"GTFSWebImporter",setup(t){const{$gettext:e}=he(),r=ye(),n=pe(),o=me(),a=M(!1),s=M(null),i=M([]),u=M([]),f=M(!1),d=M(r.selectedGTFS),V=C(()=>n.linksIsEmpty),D=C(()=>r.callID),b=C(()=>r.running),P=C(()=>r.error),F=C(()=>r.errorMessage);be(()=>{r.saveParams(q.value),r.saveSelectedGTFS(d.value)});const q=M([{name:"start_time",text:"start time",value:r.parameters.start_time,type:"time",units:"",hint:"Start Time to restrict the GTFS in a period",rules:["required"]},{name:"end_time",text:"end time",value:r.parameters.end_time,type:"time",units:"",hint:"End Time to restrict the GTFS in a period",rules:["required"]},{name:"day",text:"day",value:r.parameters.day,type:"String",items:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],units:"",hint:"restrict each GTFS to this day.",rules:["required"]}]),J={required:c=>!!c||e("Required")};ge(async()=>{i.value=await le(),i.value.forEach((c,v)=>{try{c.bbox=j([c["location.bounding_box.minimum_longitude"],c["location.bounding_box.minimum_latitude"],c["location.bounding_box.maximum_longitude"],c["location.bounding_box.maximum_latitude"]])}catch{c.bbox=null}c.index=v}),i.value=i.value.filter(c=>c.bbox),i.value=i.value.filter(c=>c["urls.latest"].length>0),i.value.sort((c,v)=>c["location.country_code"]<v["location.country_code"]?-1:c["location.country_code"]>v["location.country_code"]?1:0)});async function le(){try{const c=await fetch("https://storage.googleapis.com/storage/v1/b/mdb-csv/o/sources.csv?alt=media",{});c.ok||o.changeAlert({name:"Network error",message:"cannot fetch GTFS list"});const v=await c.arrayBuffer();return Pe(v)}catch(c){o.changeAlert(c)}}function ie(c){s.value?s.value=c:(s.value=c,R())}function R(){let c=null;if(s.value.style==="bbox"){const l=s.value.geometry;c=j([l[1],l[0],l[3],l[2]])}else c=Ge([s.value.geometry]);u.value=i.value.filter(l=>te(c,l.bbox)||He(c,l.bbox)),u.value.forEach(l=>l.allInPolygon=te(c,l.bbox));const v=new Set(u.value.map(l=>l.index));d.value=d.value.filter(l=>v.has(l))}function z(){if(V.value){r.setCallID();const l={files:u.value.filter(w=>d.value.includes(w.index)).map(w=>w["urls.latest"]),callID:D.value};q.value.forEach(w=>{l[w.name]=w.value}),r.startExecution(l)}else a.value=!0}function Q(){o.initLinks(),a.value=!1,z()}return(c,v)=>(_(),T("div",je,[h(A,{class:"card"},{default:m(()=>[h($,{class:"subtitle"},{default:m(()=>[x(y(g(e)("GTFS importer")),1)]),_:1}),h(Se,{onChange:ie})]),_:1}),h(A,{class:"card2"},{default:m(()=>[h($,{class:"subtitle"},{default:m(()=>[x(y(g(e)("Available GTFS")),1)]),_:1}),h(Z,null,{default:m(()=>[x(y(g(e)("Data fetch from")+" https://database.mobilitydata.org/"),1)]),_:1}),h(B,{disabled:b.value,"prepend-icon":"fa-solid fa-sync",onClick:R},{default:m(()=>[x(y(g(e)("fetch available GTFS")),1)]),_:1},8,["disabled"]),h(B,{loading:b.value,disabled:b.value||d.value.length===0,color:b.value||d.value.length===0?"regular":"success","prepend-icon":"fa-solid fa-play",onClick:z},{default:m(()=>[x(y(g(e)("Download")),1)]),_:1},8,["loading","disabled","color"]),h(Z,null,{default:m(()=>[P.value?(_(),N(we,{key:0,density:"compact",variant:"outlined",text:"",type:"error"},{default:m(()=>[x(y(g(e)("There as been an error while importing OSM network.             Please try again. If the problem persist, contact us."))+" ",1),(_(!0),T(U,null,W(Object.keys(F.value),l=>(_(),T("p",{key:l},[p("b",null,y(l)+": ",1),x(y(F.value[l]),1)]))),128))]),_:1})):_e("",!0)]),_:1}),p("div",et,[(_(!0),T(U,null,W(q.value,(l,w)=>(_(),T("div",{key:w,class:"params"},[typeof l.items>"u"?(_(),N(xe,{key:0,modelValue:l.value,"onUpdate:modelValue":I=>l.value=I,step:"1",type:l.type,label:g(e)(l.text),suffix:l.units,variant:"underlined",hint:f.value?g(e)(l.hint):"","persistent-hint":f.value,rules:l.rules.map(I=>J[I]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","label","suffix","hint","persistent-hint","rules"])):(_(),N(Ve,{key:1,modelValue:l.value,"onUpdate:modelValue":I=>l.value=I,variant:"underlined",type:l.type,items:l.items,label:g(e)(l.text),suffix:l.units,hint:f.value?g(e)(l.hint):"","persistent-hint":f.value,rules:l.rules.map(I=>J[I]),required:"",onWheel:()=>{}},null,8,["modelValue","onUpdate:modelValue","type","items","label","suffix","hint","persistent-hint","rules"]))]))),128))]),p("div",tt,[p("ul",rt,[p("span",at,[h(Ie,{disabled:!0})]),nt,st,ot,lt,it]),(_(!0),T(U,null,W(u.value,(l,w)=>(_(),T("ul",{key:l.index,class:"list-row"},[p("span",ut,[h(Le,{modelValue:d.value,"onUpdate:modelValue":v[0]||(v[0]=I=>d.value=I),value:l.index,label:String(w)},null,8,["modelValue","value","label"])]),p("span",ct,y(l.allInPolygon),1),p("span",ft,y(l["location.country_code"]),1),p("span",dt,y(l["location.subdivision_name"]),1),p("span",vt,y(l["location.municipality"]),1),p("span",ht,y(l.provider),1)]))),128))])]),_:1}),h(ke,{modelValue:a.value,"onUpdate:modelValue":v[2]||(v[2]=l=>a.value=l),persistent:"","max-width":"500",onKeydown:[H(Q,["enter"]),v[3]||(v[3]=H(l=>a.value=!1,["esc"]))]},{default:m(()=>[h(A,null,{default:m(()=>[h($,{class:"text-h5"},{default:m(()=>[x(y(g(e)("Overwrite current PT network ?")),1)]),_:1}),h(Me,null,{default:m(()=>[h(Te),h(B,{color:"regular",onClick:v[1]||(v[1]=l=>a.value=!a.value)},{default:m(()=>[x(y(g(e)("No")),1)]),_:1}),h(B,{color:"primary",onClick:Q},{default:m(()=>[x(y(g(e)("Yes")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Pt=ve(yt,[["__scopeId","data-v-d7238ff6"]]);export{Pt as default};
